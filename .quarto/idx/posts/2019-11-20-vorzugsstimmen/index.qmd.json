{"title":"Austrian General Elections 2019: Preference votes","markdown":{"yaml":{"title":"Austrian General Elections 2019: Preference votes","description":"A look at the distribution of preference votes casted in the 2019 general elections.","date":"11-20-2019","categories":["elections","stringr","tidyr::pivot","Austria"],"image":"preview.png"},"headingText":"preps -------------------------------------------------------------------","containsRefs":false,"markdown":"\n\n\n```{r setup, include=FALSE}\nlibrary(rvest, quietly = T, verbose = F, warn=F)\nlibrary(tidyverse, quietly = T, verbose = F, warn=F)\nlibrary(knitr, quietly =T)\nlibrary(paletteer)\nlibrary(ggtext)\nlibrary(ggforce)\nlibrary(extrafont)\nloadfonts(device = \"win\", quiet = T)\nlibrary(hrbrthemes)\nlibrary(patchwork)\nlibrary(ggiraph)\nlibrary(lemon)\nlibrary(reactable)\n\nplot_bg_color <- \"white\"\n\nknitr::opts_chunk$set(echo = T, background=plot_bg_color)\n\n\ntheme_post <- function() {\n  hrbrthemes::theme_ipsum_rc() +\n    theme(\n      plot.background = element_rect(fill = plot_bg_color, color=NA),\n      panel.background = element_rect(fill = plot_bg_color, color=NA),\n      #panel.border = element_rect(colour = plot_bg_color, fill=NA),\n      #plot.border = element_rect(colour = plot_bg_color, fill=NA),\n      plot.margin = margin(l = 0, \n                           t = 0.25,\n                           unit = \"cm\"),\n      plot.title = element_text(\n        color = \"grey20\",\n        face = \"bold\",\n        margin = margin(l = 0, b=0.25, unit = \"cm\"),\n        size = 18\n      ),\n      plot.title.position = \"plot\",\n      plot.subtitle = element_text(\n        color = \"grey50\",\n        margin = margin(t = 0.2, b = 0.3, unit = \"cm\"),\n        size = 11\n      ),\n      plot.caption = element_text(\n        color = \"grey50\",\n        size = 11\n      ),\n      plot.caption.position = \"panel\",\n      axis.title.x = element_text(\n        angle = 0,\n        color = \"grey50\",\n        hjust = 1\n      ),\n      axis.text.x = element_text(\n        size = 12,\n        color = \"grey50\"\n      ),\n      axis.title.y = element_blank(),\n      axis.text.y = element_text(\n        size = 9,\n        color = \"grey50\"\n      ),\n      panel.grid.minor.x = element_blank(),\n      panel.grid.major.x = element_blank(),\n      panel.grid.minor.y = element_blank(),\n      panel.spacing = unit(0.25, \"cm\"),\n      panel.spacing.y = unit(0.25, \"cm\"),\n      strip.text = element_text(\n        angle = 0,\n        size = 9,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      legend.title = element_text(\n        color = \"grey30\",\n        face = \"bold\",\n        vjust = 1,\n        size = 7\n      ),\n      legend.text = element_text(\n        size = 12,\n        color = \"grey30\"\n      ),\n      legend.justification = \"left\",\n      legend.box = \"horizontal\", # arrangement of multiple legends\n      legend.direction = \"vertical\",\n      legend.margin = margin(l = 0, t = 0, unit = \"cm\"),\n      legend.spacing.y = unit(0.07, units = \"cm\"),\n      legend.text.align = 0,\n      legend.box.just = \"top\",\n      legend.key.height = unit(0.2, \"line\"),\n      legend.key.width = unit(0.5, \"line\"),\n      text = element_text(size = 5)\n    )\n}\n\n\nmy_caption_2 <- c(\"Data: bmi.gv.at/412/Nationalratswahlen/Nationalratswahl_2019/start.aspx#vorzugsstimmen\\nAnalysis: Roland Schmidt | @zoowalk | https://werk.statt.codes\")\n\n\n```\n\n\n```{r include=F, echo=F}\n\nparty_colors <- c(FPÖ = \"#005DA8\", NEOS = \"#EA5290\", ÖVP = \"#5DC2CC\", SPÖ = \"#FC0204\", GRÜNE = \"#A3C630\")\n\nmain_parties <- c(\"SPÖ\", \"ÖVP\", \"NEOS\", \"GRÜNE\", \"FPÖ\")\n```\n\n\n```{r extract_data, include=F, echo=F, eval=T}\n# get state and regional list--------------------------------------\n\ndf_state_region <- readxl::read_xlsx(path = here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"NRW19_Vorzugsstimmen_Landes_Regionalparteiliste_16102019.xlsx\"))\n\nnames(df_state_region) <- names(df_state_region) %>%\n  stringr::str_remove(., \"\\r\") %>%\n  stringr::str_remove(., \"\\n\") %>%\n  stringr::str_remove(., \"-\")\n\ndf_state_region <- df_state_region %>%\n  janitor::clean_names()\n\ndf_state_region_long <- df_state_region %>%\n  mutate(party = map_chr(reihung_1, ~ str_extract(., regex(\"^List.*\")))) %>%\n  mutate(state_list = map_chr(reihung_1, ~ str_extract(., regex(\"^Landespartei.*\")))) %>%\n  mutate(regional_list = map_chr(familien_vorname_2, ~ str_extract(., regex(\"^Regionalpartei.*\")))) %>% # mess in bmi file; heading in different columns\n  mutate(regional_list_2 = map_chr(reihung_1, ~ str_extract(., regex(\"^Regionalpartei.*\")))) %>%\n  mutate(district = coalesce(state_list, regional_list, regional_list_2)) %>%\n  janitor::remove_empty(\"rows\") %>%\n  fill(., district, .direction = c(\"down\")) %>%\n  fill(., party, .direction = c(\"down\")) %>%\n  select(-c(\"x6\", \"state_list\", \"regional_list\", \"regional_list_2\")) %>%\n  filter(str_detect(reihung_1, \"^[0-9]\")) %>%\n  select(district, party, everything()) %>%\n  rename_at(\n    vars(reihung_7:vorz_stimm_11),\n    function(x) str_replace_all(x, \"[:digit:]+\", \"b\")\n  ) %>%\n  rename_at(\n    vars(reihung_1:vorz_stimm_5),\n    function(x) str_replace_all(x, \"[:digit:]+\", \"a\")\n  ) %>%\n  mutate_at(vars(reihung_a:vorz_stimm_b), as.character) %>%\n  pivot_longer(\n    cols = reihung_a:vorz_stimm_b, names_to = c(\".value\", \"result\"),\n    names_pattern = \"(.*)_([a|b]$)\"\n  ) %>%\n  mutate_at(vars(reihung, geb_jahr, vorz_stimm), as.numeric) %>%\n  group_by(district, party) %>%\n  arrange(reihung, .by_group = T) %>%\n  mutate(district_type = case_when(\n    str_detect(district, regex(\"Landes.*\")) ~ \"Landeswahlkreis\",\n    str_detect(district, regex(\"^Regional.*\")) ~ \"Regionalwahlkreis\",\n    TRUE ~ NA_character_\n  )) %>%\n  select(district_type, district, party, everything(), -result) %>%\n  rename(\n    name = familien_vorname,\n    pref_votes_abs = vorz_stimm,\n    # district_type = district_type,\n    # district = district,\n    rank_list = reihung,\n    birth_year = geb_jahr,\n  ) %>%\n  ungroup()\n\n\n# get federal list --------------------------------------\n\ndf_federal <- readxl::read_xlsx(\n  path=here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"NRW19_Vorzugsstimmen_bundesweit_16102019.xlsx\"),\n  col_name = F,\n  trim_ws = T\n)\n\nnames(df_federal) <- c(\n  \"Nr\", \"Familienname, Vorname\", \"Geb.-Jahr\", \"Beruf\",\n  \"Gesamt\", \"B\", \"K\", \"NÖ\", \"OÖ\", \"S\", \"Stmk\", \"Tirol\",\n  \"Vlbg\", \"Wien\"\n)\n\n\ndf_federal_clean <- df_federal %>%\n  janitor::remove_empty(., which = c(\"rows\")) %>%\n  filter(!Nr == \"Nr.\") %>%\n  mutate(party = str_extract(Nr, regex(\"[:alpha:].*\"))) %>%\n  fill(., party, .direction = c(\"down\")) %>%\n  filter(!str_detect(Nr, regex(\"[:alpha:]\"))) %>%\n  mutate(district_type = \"Bundeswahlkreis\") %>%\n  pivot_longer(cols = Gesamt:Wien, names_to = \"district\", values_to = \"pref_votes_abs\")\n\n\n# rename to be consistent with regional/state level\ndf_federal_clean <- df_federal_clean %>%\n  select(district_type, district, party,\n    rank_list = \"Nr\", name = \"Familienname, Vorname\", birth_year = \"Geb.-Jahr\",\n    beruf = \"Beruf\", everything()\n  ) %>%\n  mutate_at(vars(\"rank_list\", \"birth_year\", \"pref_votes_abs\"), ~ stringr::str_trim(., side = c(\"both\"))) %>%\n  mutate_at(vars(\"rank_list\", \"birth_year\", \"pref_votes_abs\"), as.numeric)\n\n\n# bind both bund, laender and regio -------------------------------------------------------------------\n\ndf_merge <- bind_rows(\n  df_state_region_long,\n  df_federal_clean\n) %>%\n  ungroup() %>% \n  filter(!is.na(name))\n\n# write.csv2(df_merge,\n#            file = paste0(wdr, \"/data/AUT_NRW19_preference_votes.csv\"),\n#            row.names = F,\n#            fileEncoding = \"latin1\"\n# )\n\n\nfn_remove_titles <- function(x) {\n  titles <- c(\n    \"Mag\", \"MMag\", \"Prof\", \"Dr\", \"O\\\\.Univ\\\\.Prof\", \"Dipl-Ing\", \"Dipl.-Ing.\", \"Dipl.-Rev.\", \"Ing\",\n    \"Dipl\", \"jun\", \"sen\", \"Ba\", \"\\\\(FH\\\\)\", \"MSc\",\n    \"med\", \"univ\", \"Bsc\", \"phil\", \"iur\", \"DDr\", \"BEd\", \"DI\", \"Mba\", \"Mas\", \"MA\", \"MIM\",\n    \"vet\", \"M.A.\", \"PMM\", \"MTD\", \"Päd\", \"Bakk\"\n  ) %>%\n    map(., paste0, c(\"\\\\.\", \"\\\\s\", \"\\\\,\")) %>%\n    unlist()\n\n\n  name_wo_titles <- stringr::str_remove_all(x, regex(\"[[:alpha:]\\\\-]+\\\\.\")) %>%\n    str_remove_all(., regex(\"\\\\([:alpha:]+\\\\)\")) %>%\n    str_remove_all(., regex(paste0(titles, collapse = \"|\"), ignore_case = T)) %>%\n    str_squish()\n}\n\n\nfn_short_name <- function(x) {\n  family_name <- stringr::str_extract(x, \"^[[:alpha:]\\\\-|\\\\s]+(?=,)\") %>%\n    str_to_title() %>%\n    str_squish() %>%\n    str_trim()\n\n  first_name <- str_extract(x, regex(\"(?<=\\\\,)[[:alpha:]\\\\-\\\\s]*$\")) %>%\n    str_trim() %>%\n    str_squish() %>%\n    str_to_title()\n\n  initals <- str_split(first_name, \"\\\\s\") %>%\n    map(., str_sub, start = 1L, end = 1L) %>%\n    map_chr(., str_c, collapse = \".\") %>%\n    paste0(., \".\")\n\n  name_short <- paste(family_name, initals, sep = \", \")\n}\n\ndf <- df_merge %>%\n  mutate(district = str_remove(district, \"Landesparteiliste\") %>%\n    str_remove(., \"Regionalparteiliste\") %>%\n    str_trim(., side = c(\"both\"))) %>%\n  mutate(district = case_when(\n    district == \"B\" ~ \"Burgenland\",\n    district == \"S\" ~ \"Salzburg\",\n    district == \"K\" ~ \"Kärnten\",\n    district == \"NÖ\" ~ \"Niederösterreich\",\n    district == \"OÖ\" ~ \"Oberösterreich\",\n    district == \"Stmk\" ~ \"Steiermark\",\n    district == \"Vlbg\" ~ \"Vorarlberg\",\n    TRUE ~ district\n  )) %>%\n  mutate(district = as_factor(district)) %>%\n  mutate(party2 = str_extract(party, regex(\"\\\\([:alpha:]*\\\\)\")) %>% # take parties' short abbrevs.\n    str_remove_all(., \"\\\\(|\\\\)\")) %>%\n  mutate(name_orig = name) %>%\n  mutate(name = map_chr(name_orig, fn_remove_titles)) %>%\n  mutate(name_short = map_chr(name, fn_short_name)) %>%\n  mutate(state = case_when(\n    str_detect(district, \"^[0-9].*\") ~ str_sub(district, start = 1L, end = 1L),\n    TRUE ~ as.character(district)\n  )) %>%\n  mutate(state = case_when(\n    state == 1 ~ \"Burgenland\",\n    state == 2 ~ \"Kärnten\",\n    state == 3 ~ \"Niederösterreich\",\n    state == 4 ~ \"Oberösterreich\",\n    state == 5 ~ \"Salzburg\",\n    state == 6 ~ \"Steiermark\",\n    state == 7 ~ \"Tirol\",\n    state == 8 ~ \"Vorarlberg\",\n    state == 9 ~ \"Wien\",\n    # TRUE ~ NA_character_\n    TRUE ~ state,\n  )) %>%\n  mutate(district_type = fct_relevel(district_type, \"Bundeswahlkreis\", \"Landeswahlkreis\", \"Regionalwahlkreis\")) %>% \n  mutate(name = case_when(\n    str_detect(name, \"Pistracher\") ~ \"Pistracher, Gerald\",\n    TRUE ~ as.character(name)))\n\n```\n \n\n \n```{r, include=F, echo=F}\n# readr::write_csv2(df, file=here::here(\"posts\", \n#                                       \"2019-11-20-vorzugsstimmen\",\n#                                       \"df.csv\"))\n```\n\n\n```{r include=FALSE}\ndf <- readr::read_csv2(file=here::here(\"posts\", \n                                       \"2019-11-20-vorzugsstimmen\",\n                                       \"df.csv\"))\n \ndf <- df %>%\n  mutate(party3 = fct_other(party2, keep = main_parties) %>%\n    fct_relevel(., \"ÖVP\", \"SPÖ\", \"FPÖ\", \"GRÜNE\", \"NEOS\", \"Other\"))\n```\n\n\n```{r include=FALSE}\n# INCLUDED top 5 candidates per party ----------------------------------------------\n\ntop_candidates <- df %>%\n  # filter(party2 %in% main_parties) %>%\n  filter(!str_detect(district, \"Gesamt\")) %>%\n  group_by(party3, name) %>%\n  summarise(preferences_candidate = sum(pref_votes_abs, na.rm = T)) %>%\n  arrange(desc(preferences_candidate), .by_group = T) %>%\n  slice(1:5)\n\ndf_pl <- df %>%\n  filter(name %in% top_candidates$name) %>%\n  filter(!str_detect(district, \"Gesamt\")) %>%\n  group_by(party3, name, district_type) %>%\n  summarise(sum_candiate = sum(pref_votes_abs, na.rm = T)) %>% # rename sum_candidate\n  group_by(party3) %>%\n  arrange(desc(sum_candiate), .by_group = T) %>%\n  ungroup() %>%\n  group_by(name) %>%\n  mutate(total_candidate = sum(sum_candiate)) %>%\n  ungroup() %>%\n  mutate(name = forcats::fct_reorder(name, total_candidate, .desc = F))\n```\n\n\n```{r include=FALSE}\npl_top_5_candidates <- df_pl %>%\n  ggplot() +\n  geom_bar(aes(\n    x = name,\n    y = sum_candiate,\n    fill = district_type\n  ),\n  width = 0.8,\n  stat = \"identity\"\n  ) +\n  geom_text(\n    data = top_candidates,\n    aes(\n      x = name,\n      y = max(top_candidates$preferences_candidate)+70000,\n      label = scales::comma(preferences_candidate, accuracy = 1)\n    ),\n    stat = \"identity\",\n    family = \"Roboto Condensed\",\n    color = \"grey50\",\n    hjust = 1\n  ) +\n  labs(\n    caption = my_caption_2,\n    title = \"Candidates with most preference votes (Top 5)\",\n    y = \"Number of preference votes in 1,000\"\n  ) +\n  scale_x_discrete(label = fn_short_name) +\n  scale_y_continuous(\n    label = scales::comma_format(scale = 0.001),\n    expand = expansion(mult = c(0, 0.1)),\n    breaks = seq(0, max(top_candidates$preferences_candidate), 25000),\n    minor_breaks = NULL\n  ) +\n  scale_fill_paletteer_d(\"ggsci::default_jama\",\n    labels = c(\n      \"Regionalwahlkreis\" = \"Regional lists\",\n      \"Landeswahlkreis\" = \"State lists\",\n      \"Bundeswahlkreis\" = \"Federal list\"\n    )\n  ) +\n  facet_wrap(vars(party3),\n    ncol = 2,\n    scale = \"free_y\"\n  ) +\n  coord_flip() +\n  theme_post()+\n  theme(\n    panel.grid.major.y = element_blank(),\n    panel.grid.major.x = element_line(),\n    panel.spacing.x = unit(0, units = \"cm\"),\n    panel.spacing.y = unit(0.25, units = \"cm\"),\n    axis.title.y = element_blank(),\n    axis.title.x = element_text(hjust=0, size=13),\n    # axis.text.y = element_text(hjust=0),\n    axis.text.x = element_text(size=13),\n    axis.text.y = element_text(size=13),\n    plot.caption=element_text(hjust=0),\n    legend.title = element_blank(),\n    legend.direction = \"horizontal\",\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.key.size = unit(0.4, units = c(\"cm\")),\n    plot.title.position = \"panel\",\n    plot.background = element_rect(fill=plot_bg_color),\n    strip.text = element_text(face = \"bold\",\n                              size=14)\n  ) +\n  guides(fill = guide_legend(rev = T, ))\n\n\n\n```\n\n```{r, include=F}\n# INCLUDED top per district_type (not included) -----------------------------------------------------------\n\nfn_top_plot <- function(x) {\n  x %>%\n    ggplot() +\n    geom_bar(aes(\n      x = name,\n      y = pref_votes_abs\n    ),\n    stat = \"identity\"\n    ) +\n    labs(title = paste(unique(x$district_type))) +\n    scale_x_discrete(labels = fn_short_name) +\n    hrbrthemes::theme_ipsum_ps() +\n    facet_wrap(vars(district),\n      scales = \"free_y\"\n    ) +\n    coord_flip()\n}\n\nlist_plots <- df %>%\n  filter(!district == \"Gesamt\") %>%\n  group_by(district_type, district) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  slice(1:3) %>%\n  ungroup() %>%\n  group_split(district_type) %>%\n  map(~ fn_top_plot(.))\n\n```\n\n\n```{r, include=F}\n# difference btw ranking and number of preferential votes -----------------\n\ndf_rank_diff <- df %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  group_by(party3, district_type, district) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(rank_votes = row_number()) %>%\n  mutate(rank_diff = rank_list - rank_votes) %>%\n  select(district_type, district, party3, name, pref_votes_abs, rank_list, rank_votes, rank_diff) %>%\n  arrange(desc(rank_diff))\n\ndf_rank_diff_long <- df_rank_diff %>%\n  filter(party3 %in% main_parties) %>%\n  pivot_longer(\n    cols = c(rank_list, rank_votes),\n    values_to = \"rank_no\",\n    names_to = \"ranking_type\"\n  )\n\n# df_rank_diff_long %>%\n#   ggplot() +\n#   geom_point(aes(\n#     x = fct_rev(ranking_type),\n#     y = rank_no,\n#     group = name,\n#     color = party3\n#   )) +\n#   geom_line(aes(\n#     x = fct_rev(ranking_type),\n#     y = rank_no,\n#     group = name,\n#     color = party3\n#   )) +\n#   ggrepel::geom_text_repel(aes(\n#     x = fct_rev(ranking_type),\n#     y = rank_no,\n#     group = name,\n#     label = name,\n#     color = party3\n#   ),\n#   size = 2\n#   ) +\n#   facet_grid(rows = vars(party3), cols = vars(district_type))\n\n\n# INCLUDED Composition of preferential votes ---------------------------------------\n\ndf_list <- df %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  group_by(district_type) %>%\n  summarise(district_type_votes = sum(pref_votes_abs, na.rm = T)) %>%\n  #  arrange(desc(district_type_votes)) %>%\n  mutate(district_type = forcats::fct_relevel(district_type, \"Regionalwahlkreis\", \"Landeswahlkreis\", \"Bundeswahlkreis\")) %>%\n  mutate(district_type_votes_cum = cumsum(district_type_votes)) %>%\n  mutate(district_type_votes_perc = district_type_votes / sum(district_type_votes)) %>%\n  mutate(district_type = forcats::fct_reorder(district_type, district_type_votes_cum, .desc = F))\n\npl_by_district <- df_list %>%\n  ggplot() +\n  geom_bar(aes(\n    x = 1,\n    y = district_type_votes,\n    fill = district_type,\n    group = district_type\n  ),\n  stat = \"identity\"\n  ) +\n  geom_text(aes(\n    x = 1,\n    y = district_type_votes,\n    group = district_type,\n    label = paste(scales::comma(district_type_votes),\n                  scales::percent(district_type_votes_perc),\n                  sep = \"\\n\"\n    )\n  ),\n  colour = \"white\",\n  position = position_stack(vjust = .5, reverse = F)\n  ) +\n  scale_y_continuous(\n    expand = expansion(mult = c(0, 0.05)),\n    breaks = max(df_list$district_type_votes_cum),\n    label = scales::comma(max(df_list$district_type_votes_cum))\n  ) +\n  scale_fill_paletteer_d(\"ggsci::default_jama\",\n                         labels = c(\n                           \"Regionalwahlkreis\" = \"Regional lists\",\n                           \"Landeswahlkreis\" = \"State lists\",\n                           \"Bundeswahlkreis\" = \"Federal list\"\n                         )\n  ) +\n  labs(\n    title = \"Total number of preference votes per electoral district\",\n    caption = my_caption_2,\n    y = \"number of preference votes\"\n  ) +\n  coord_flip() +\n  guides(fill = guide_legend(reverse = T))+\n  theme_post()+\n  theme(legend.position=\"top\",\n        legend.justification = \"left\",\n        legend.direction  = \"horizontal\",\n        plot.caption =element_text(hjust=0),\n        legend.title = element_blank(),\n        axis.text.y = element_blank(),\n        panel.grid.major.y = element_blank()\n        \n  )\n```\n\n\n```{r, include=F}\n# INCLUDED by constituency list and party  -------------------------------------------------------------\n\nx <- df %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  group_by(party3, district_type) %>%\n  summarise(district_type_votes = sum(pref_votes_abs, na.rm = T)) %>%\n  arrange(desc(district_type_votes)) %>%\n  mutate(district_type_votes_cum = cumsum(district_type_votes)) %>%\n  mutate(district_type_votes_perc = district_type_votes / sum(district_type_votes)) %>%\n  ungroup()\n\npl_constituency_list_party <- x %>%\n  filter(party3 != \"Other\") %>%\n  ggplot() +\n  geom_bar(aes(\n    x = party3,\n    y = district_type_votes,\n    group = district_type,\n    fill = district_type\n  ),\n  color = NA,\n  stat = \"identity\",\n  position = \"fill\"\n  ) +\n  geom_text(aes(\n    x = party3,\n    group = district_type,\n    y = district_type_votes_perc,\n    label = scales::percent(district_type_votes_perc, accuracy = 0.1)\n  ),\n  color = \"white\",\n  position = position_stack(vjust = 0.5, reverse = F)\n  ) +\n  labs(\n    title = str_wrap(\"Contribution of different electoral constituencies to total of preferential votes\", 70),\n    caption = my_caption_2\n  ) +\n  scale_fill_paletteer_d(\"ggsci::default_jama\",\n    labels = c(\n      \"Regionalwahlkreis\" = \"Regional lists\",\n      \"Landeswahlkreis\" = \"State lists\",\n      \"Bundeswahlkreis\" = \"Federal list\"\n    )\n  ) +\n  scale_y_continuous(\n    labels = scales::percent,\n    expand = expansion(mult = c(0, 0))\n  ) +\n  scale_x_discrete(expand = expansion(mult = c(0, 0.2)),\n                   position = \"top\") +\n  theme_post()+\n  theme(axis.title.x=element_blank(),\n        legend.title = element_blank(),\n        panel.grid.major.x = element_blank(),\n        plot.title=element_text(),\n        legend.position=\"top\",\n        legend.justification = \"left\",\n        legend.direction =\"horizontal\",\n        plot.caption = element_text(hjust=c(0)))+\n  guides(fill = guide_legend(reverse = F))\n\n```\n\n\n```{r, include=F, eval=T}\n# save --------------------------------------------------------------------\n\n# x <- girafe_options(\n#   x = my_plot,\n#   sizingPolicy(padding = \"0px\")\n# )\n# \n# saveWidget(x,\n#   file = \"Party_PVPv_state.html\",\n#   selfcontained = T,\n#   background = \"white\"\n# )\n# \n\n# name <- \"Party_PVPv_state\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 20\n# width <- 30\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n# \n\n\n# intra-party movements due to preference votes --------------------------\n\n\n# > import election results -----------------------------------------------\n\nnrw19_imp <- readr::read_csv2(\n  file = here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"wahl_20191003_214253.csv\"),\n  locale = locale(encoding = \"latin1\")\n) %>%\n  janitor::remove_empty(., which = c(\"cols\")) %>%\n  janitor::clean_names() %>%\n  rename(gkz = x1)\n\nnrw19 <- nrw19_imp %>%\n  mutate(state = str_sub(gkz, 2, 2)) %>%\n  mutate(district_pol = str_sub(gkz, 3, 4)) %>% # Bezirk\n  mutate(municipality = str_sub(gkz, 5, 6)) %>%\n  mutate(level = case_when(\n    str_sub(gkz, 2, 2) == 0 ~ \"gesamt\",\n    str_detect(gkz, regex(\"^[A-Z][1-9]00[0,9][0,9]\")) ~ \"Bundesland\",\n    str_detect(gkz, regex(\"^G.{1}[A-Z].+\")) ~ \"Regional-Wahlkreis\",\n    str_detect(gkz, regex(\"^G[1-9][0-9][1-9]00\")) ~ \"Bezirk\",\n    str_detect(gkz, regex(\"^G[1-9][0-9][1-9]99\")) ~ \"Bezirk\",\n    str_detect(gkz, regex(\"^G[1-9][0-9][1-9][0-8][0-9]\")) ~ \"Gemeinde\",\n    TRUE ~ as.character(\"u\")\n  )) %>%\n  mutate(wahlkarten = case_when(\n    str_detect(gkz, regex(\"99$\")) ~ \"ja\",\n    TRUE ~ as.character(\"nein\")\n  )) %>%\n  select(level,\n    district_name = gebietsname, gkz, electorate_size = wahlberechtigte,\n    votes_mail = wahlkarten, state, votes_casted = abgegebene, district_pol,\n    municipality, everything()\n  )\n\n\nnrw19_bezirk <- nrw19 %>%\n  filter(votes_mail == \"nein\") %>%\n  filter(level == \"Bezirk\")\n\nnrw19_bezirk <- nrw19_bezirk %>%\n  mutate(turnout = votes_casted / electorate_size * 100) %>%\n  mutate_at(vars(spo, ovp, fpo, grune, neos), .funs = list(perc = ~ .x / gultige))\n\nnrw19_long <- nrw19_bezirk %>%\n  select(contains(\"perc\"), district_name, gkz, turnout) %>%\n  pivot_longer(., cols = contains(\"perc\"), names_to = \"party\", values_to = \"party_perc\")\n\n\n\n# > federal level ---------------------------------------------------------\nresults_federal_list <- nrw19 %>%\n  filter(level == \"gesamt\")\n\nresults_federal_list_long <- results_federal_list %>%\n  pivot_longer(cols = ovp:slp, names_to = \"party\", values_to = \"votes_abs\") %>%\n  mutate(district_type = \"Bundeswahlkreis\") %>%\n  mutate(district = \"00\") %>%\n  select(district_type, district_name, district, party, votes_abs)\n\n\n\n# > state level -----------------------------------------------------------\n\nresults_state_list <- nrw19 %>%\n  filter(level == \"Bundesland\") %>%\n  group_by(state) %>%\n  summarise_if(is.numeric, sum, na.rm = T) %>%\n  mutate(district_name = case_when(\n    state == 1 ~ \"Burgenland\",\n    state == 2 ~ \"Kärnten\",\n    state == 3 ~ \"Niederösterreich\",\n    state == 4 ~ \"Oberösterreich\",\n    state == 5 ~ \"Salzburg\",\n    state == 6 ~ \"Steiermark\",\n    state == 7 ~ \"Tirol\",\n    state == 8 ~ \"Vorarlberg\",\n    state == 9 ~ \"Wien\",\n    TRUE ~ NA_character_\n  )) %>%\n  mutate(district = state)\n\nresults_state_list_long <- results_state_list %>%\n  pivot_longer(cols = ovp:slp, names_to = \"party\", values_to = \"votes_abs\") %>%\n  mutate(district_type = \"Landeswahlkreis\") %>%\n  select(district_type, district_name, district, party, votes_abs)\n\n\n\n# >> details on electoral districts/constituencies -----------------------\n\nlibrary(rvest)\n\nMoI_url <- \"https://www.bmi.gv.at/412/Nationalratswahlen/Wahlkreiseinteilung.aspx\"\n\nn_mandates_regional_districts <- MoI_url %>%\n  read_html() %>%\n  html_nodes(\"table\") %>%\n  html_table() %>%\n  map_df(., bind_rows)\n\n# from utils package; allows Umlaute when exporting\nwrite.csv2(n_mandates_regional_districts,\n  file = here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"n_mandates_regional_districts.csv\"),\n  row.names = F,\n  fileEncoding = \"latin1\"\n)\n\nn_mandates_regional_districts <- read_csv2(\n  file = here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"n_mandates_regional_districts.csv\"),\n  locale = locale(encoding = \"latin1\")\n)\n\n\nn_mandates_landeswahlkreis <- n_mandates_regional_districts %>%\n  mutate(state = stringr::str_sub(Regionalwahlkreis, 1, 1)) %>%\n  group_by(state) %>%\n  summarise(n_mandates = sum(Mandate))\n\ninfo_constituencies <- dplyr::bind_rows(\n  n_mandates_regional_districts %>%\n    select(-Stimmbezirke) %>%\n    rename(\n      district = Regionalwahlkreis,\n      district_name = Bezeichnung,\n      n_mandates = Mandate\n    ),\n  n_mandates_landeswahlkreis %>%\n    mutate(district = case_when(\n      state == \"1\" ~ \"Burgenland\",\n      state == \"2\" ~ \"Kärnten\",\n      state == \"3\" ~ \"Niederösterreich\",\n      state == \"4\" ~ \"Oberösterreich\",\n      state == \"5\" ~ \"Salzburg\",\n      state == \"6\" ~ \"Steiermark\",\n      state == \"7\" ~ \"Tirol\",\n      state == \"8\" ~ \"Vorarlberg\",\n      state == \"9\" ~ \"Wien\",\n      TRUE ~ NA_character_\n    )) %>%\n    mutate(district_name = district)\n) %>%\n  mutate(district_name_short = str_replace(district_name, \"Burgenland\", \"Bgld\") %>%\n    str_replace(., \"Kärnten\", \"Ktn\") %>%\n    str_replace(., \"Niederösterreich\", \"NÖ\") %>%\n    str_replace(., \"Salzburg\", \"Sbg\") %>%\n    str_replace(., \"steiermark\", \"Stmk\") %>%\n    str_replace(., \"Innsbruck\", \"Ibk\") %>%\n    str_replace(., \"Vorarlberg\", \"Vbg\") %>%\n    str_replace(., \"\\\\sund\\\\s\", \" u \")) %>%\n  select(., -state) %>%\n  bind_rows(., data.frame(district = \"Gesamt\", district_name = \"Gesamt\", n_mandates = 183, district_name_short = \"Gesamt\"))\n\n# >> get 'electoral number' --------------------------------------------------\n\nelectoral_number <- left_join(results_state_list %>%\n  select(state, district_name, district, gultige),\nn_mandates_landeswahlkreis,\nby = c(\"district\" = \"state\")\n) %>%\n  mutate(electoral_number = ceiling(gultige / n_mandates)) # rounded to next higher integer\n\n\nresults_state_list_long <- left_join(results_state_list_long,\n  electoral_number %>% select(district, electoral_number),\n  by = c(\"district\" = \"district\")\n)\n\n\n# > regional level -------------------------------------------------------\n\nresults_regional_list <- nrw19 %>%\n  mutate(district_name = str_remove_all(district_name, \"Wahlkarten\") %>%\n    str_remove_all(., \"-\") %>%\n    str_trim()) %>%\n  filter(level == \"Regional-Wahlkreis\" & str_detect(gkz, \"00$\")) %>%\n  mutate(district_type = \"Regionalwahlkreis\") %>%\n  mutate(district = paste0(state, district_pol) %>% stringr::str_sub(., 1, 2)) %>%\n  mutate(state = case_when(\n    state == 1 ~ \"Burgenland\",\n    state == 2 ~ \"Kärnten\",\n    state == 3 ~ \"Niederösterreich\",\n    state == 4 ~ \"Oberösterreich\",\n    state == 5 ~ \"Salzburg\",\n    state == 6 ~ \"Steiermark\",\n    state == 7 ~ \"Tirol\",\n    state == 8 ~ \"Vorarlberg\",\n    state == 9 ~ \"Wien\",\n    TRUE ~ NA_character_\n  ))\n\nresults_regional_list_long <- results_regional_list %>%\n  select(district_type, district_name, district, ovp:slp) %>%\n  pivot_longer(cols = ovp:slp, names_to = \"party\", values_to = \"votes_abs\")\n\nresults_regional_list_long <- results_regional_list_long %>%\n  left_join(., n_mandates_regional_districts %>%\n    select(-Stimmbezirke, -Bezeichnung) %>%\n    rename(\n      district = Regionalwahlkreis,\n      n_mandates = Mandate\n    ),\n  by = c(\"district\")\n  )\n\n\n# bind results\ndf_results <- bind_rows(results_federal_list_long, results_state_list_long, results_regional_list_long) %>%\n  filter(party %in% c(\"ovp\", \"spo\", \"fpo\", \"grune\", \"neos\")) %>%\n  mutate(party = case_when(\n    party == \"ovp\" ~ \"ÖVP\",\n    party == \"spo\" ~ \"SPÖ\",\n    party == \"grune\" ~ \"GRÜNE\",\n    party == \"fpo\" ~ \"FPÖ\",\n    party == \"neos\" ~ \"NEOS\",\n    TRUE ~ as.character(party)\n  )) %>%\n  mutate(district = case_when(\n    district == 1 ~ \"Burgenland\",\n    district == 2 ~ \"Kärnten\",\n    district == 3 ~ \"Niederösterreich\",\n    district == 4 ~ \"Oberösterreich\",\n    district == 5 ~ \"Salzburg\",\n    district == 6 ~ \"Steiermark\",\n    district == 7 ~ \"Tirol\",\n    district == 8 ~ \"Vorarlberg\",\n    district == 9 ~ \"Wien\",\n    district == \"00\" ~ \"Gesamt\",\n    TRUE ~ as.character(district)\n  ))\n\n# merge results of preference votes with parties' overall results.\ndf_comb <- left_join(df %>% select(district_type, district, party3, name, name_short, name_orig,\n  preference_votes = pref_votes_abs\n),\n\ndf_results %>% rename(party_votes = votes_abs),\nby = c(\"district_type\" = \"district_type\", \"district\" = \"district\", \"party3\" = \"party\")\n)\n\n\n\n# preference votes vs votes for party -------------------------------------\n\npreference_votes_constituency <- df %>%\n  group_by(district_type, district, party3, state) %>%\n  summarise(sum_preference_votes = sum(pref_votes_abs, na.rm = T)) %>%\n  ungroup()\n\n# federal level would need disaggregation\nu <- left_join(preference_votes_constituency,\n  df_results %>% select(district_type, district, district_name, party, votes_abs),\n  by = c(\n    \"district_type\" = \"district_type\",\n    \"district\" = \"district\",\n    \"party3\" = \"party\"\n  )\n) %>%\n  mutate(p_pvv_ratio = sum_preference_votes / votes_abs) %>%  #p_pvv_ratio=party preference vote vote ratio\n  # filter(!(kreis==\"Bundeswahlkreis\" & district!=\"Gesamt\")) %>%\n  filter(district_type == \"Regionalwahlkreis\") %>%\n  filter(party3 != \"Other\")\n\nlabeller_bld <- c(\n  \"Burgenland\" = \"Bgld\",\n  \"Kärnten\" = \"Ktn\",\n  \"Niederösterreich\" = \"NÖ\",\n  \"Oberösterreich\" = \"OÖ\",\n  \"Salzburg\" = \"Sbg\",\n  \"Steiermark\" = \"Stmk\",\n  \"Tirol\" = \"Tirol\",\n  \"Vorarlberg\" = \"Vbg\",\n  \"Wien\" = \"Wien\"\n)\n\nu <- dplyr::left_join(u,\n  n_mandates_regional_districts %>%\n    rename(\n      district = Regionalwahlkreis,\n      n_mandates = Mandate\n    ) %>%\n    select(-Bezeichnung, -Stimmbezirke),\n  by = c(\"district\")\n)\n\n\n\n# not included: Parties' preference vote share (facet grid)  -----------------------------------------------------\n\nx <- u %>%\n  ggplot() +\n  geom_bar(aes(\n    x = paste0(district_name, \"(\", district, \")\"),\n    y = p_pvv_ratio,\n    fill = party3\n  ),\n  stat = \"identity\"\n  ) +\n  labs(\n    y = \"preference votes in relation to party votes\",\n    x = \"regional constituency list/Regionalwahlkreis\",\n    title = \"\"\n  ) +\n  scale_y_continuous(\n    labels = scales::percent_format(accuracy = 1),\n    expand = expansion(mult = c(0, 0.1)),\n    position = \"right\"\n  ) +\n  scale_fill_manual(values = party_colors) +\n  facet_grid(\n    rows = vars(party3), cols = vars(state),\n    scales = \"free_x\",\n    space = \"free\",\n    switch = \"y\"\n  ) +\n  hrbrthemes::theme_ipsum_rc() +\n  theme(\n    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0),\n    legend.position = \"none\",\n    strip.text = element_text(hjust = 1),\n    panel.grid.minor.y = element_blank(),\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.spacing = unit(0.05, \"cm\")\n  )\n\n# name <- \"Parties_preference_vote_share_NOT_INCLUDED_IN_BLOG\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 30\n# width <- 40\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n# \n\n# not incldued: Parties' preference vote share (boxplot) ---------------------------------------------------------------\n\n# pos <- position_jitter(width = 0.2, height = 0, seed = 1) # define seed for positioning\n# \n# u %>%\n#   group_by(party3) %>%\n#   arrange(desc(p_pvv_ratio)) %>%\n#   mutate(index = row_number()) %>%\n#   mutate(label = case_when(\n#     index < 4 ~ district_name,\n#     TRUE ~ NA_character_\n#   )) %>%\n#   ungroup() %>%\n#   ggplot() +\n#   labs(\n#     title = \"Preference votes as share of total votes casted (Parties' preference votes share)\",\n#     caption = my_caption_2,\n#     subtitle = \"Only regional constitlevel\",\n#     y = \"Preference votes in relation to total votes\"\n#   ) +\n#   geom_boxplot(aes(\n#     x = party3,\n#     y = p_pvv_ratio\n#   ),\n#   outlier.shape = NA,\n#   fill = \"transparent\"\n#   ) +\n#   geom_point(aes(\n#     x = party3,\n#     y = p_pvv_ratio\n#   ),\n#   position = pos\n#   ) +\n#   ggrepel::geom_text_repel(aes(\n#     x = party3,\n#     y = p_pvv_ratio,\n#     label = label\n#   ),\n#   position = pos\n#   ) +\n#   scale_y_continuous(\n#     labels = scales::percent_format(accuracy = 1),\n#     limits = c(0, .75),\n#     breaks = seq(0, .75, .25)\n#   ) +\n#   hrbrthemes::theme_ipsum_rc() +\n#   theme(\n#     panel.grid.major.x = element_blank(),\n#     plot.caption = element_markdown(\n#       color = \"grey30\",\n#       hjust = c(0, 1)\n#     ),\n#     axis.title.x = element_blank()\n#   )\n# \n# \n# name <- \"Parties_preference_vote_share_boxplot_NOT_INCLUDED_IN_BLOG\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 30\n# width <- 40\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n\n# INCLUDED  Parties' Preference Vote Votre (P-PVV) ratio by state  ------------------------------------------------------\n\npos <- position_jitter(width = 0.2, height = 0, seed = 1) # define seed for positioning\n\nplot_region <- u %>%\n  group_by(state) %>%\n  arrange(desc(p_pvv_ratio), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(label = case_when(\n    index < 4 ~ district_name,\n    TRUE ~ NA_character_\n  )) %>%\n  ungroup() %>%\n  group_by(state) %>%\n  mutate(median_bundesland = median(p_pvv_ratio)) %>%\n  ungroup() %>%\n  mutate(state = fct_reorder(state, median_bundesland, .desc = T)) %>%\n  ggplot() +\n  labs(\n    title = \"Parties' Preference vote - vote ratio (P-PVV) by state\",\n    caption = my_caption_2,\n    subtitle = \"Only regional constituency level (Regionalwahlliste)\",\n    y = \"# of party's preference votes as ratio of party's total votes in the constituency (P-PVV)\"\n  ) +\n  geom_boxplot(aes(\n    x = state,\n    y = p_pvv_ratio\n  ),\n  outlier.shape = NA,\n  fill = \"transparent\"\n  ) +\n  geom_point_interactive(aes(\n    x = state,\n    color = party3,\n    y = p_pvv_ratio,\n    data_id = district_name,\n    tooltip = paste(\n      party3,\n      district_name,\n      round(p_pvv_ratio * 100, 2),\n      \"%\"\n    )\n  ),\n  position = pos\n  ) +\n  scale_y_continuous(\n    labels = scales::percent_format(accuracy = 1),\n    limits = c(0, .75),\n    breaks = seq(0, .75, .25)\n  ) +\n  scale_color_manual(values = party_colors) +\n  theme_post()+\n  theme(\n    panel.grid.major.x = element_blank(),\n    legend.title = element_blank(),\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.direction = \"horizontal\",\n    # plot.title = element_text(size = 12),\n    # plot.subtitle = element_text(size = 12, color = \"grey30\"),\n    plot.title.position = \"plot\",\n    # plot.caption = element_markdown(\n    #   color = \"grey30\",\n    #   hjust = c(0, 1)\n    # ),\n    plot.caption=element_text(hjust=0),\n    # plot.margin = margin(0, unit = \"cm\"),\n    axis.title.x = element_blank()\n  )\n```\n\n```{r, include=F, eval=F}\nplot_region\n```\n\n\n```{r, include=F, eval=T}\nplot_region_interactive <- girafe(\n  code = print(plot_region),\n  width_svg = 10,\n  height_svg = 6,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:lightgray;\n                 font-family:Roboto Condensed;\")\n  ))\n```\n\n\n```{r, include=F, eval=T}\n# INCLUDED: Party's preference vote vote ratio (P-PVPV ratio) by district magnitude -----------------------------------------------------\n\npos <- position_jitter(width = 0.2, height = 0, seed = 1) # define seed for positioning\n\nconstituencies_annotation <- info_constituencies %>%\n  select(district, n_mandates, district_name_short) %>%\n  filter(str_detect(district, \"^[0-9]\")) %>%\n  group_by(n_mandates) %>%\n  summarise(gebiete = paste0(district_name_short, collapse = \", \")) %>%\n  mutate(n_mandates = as_factor(n_mandates))\n\nplot_n_mandates <- u %>%\n  mutate(n_mandates = as_factor(n_mandates) %>% fct_rev()) %>%\n  group_by(n_mandates) %>%\n  # arrange(desc(p_pvpv_ratio), .by_group = T) %>%\n  arrange(desc(p_pvv_ratio), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(label = case_when(\n    index < 4 ~ district_name,\n    TRUE ~ NA_character_\n  )) %>%\n  ungroup() %>%\n  ggplot() +\n  labs(\n    title = \"Parties' preference Votes - party votes ratio (P-PVPV) and district magnitude\",\n    caption = my_caption_2,\n    subtitle = \"Only regional constituency level (Regionalwahlliste).\",\n    y = \"# of party's preference votes as ratio of party's total votes in the constituency (P-PVPV)\",\n    x = \"District magnitude (number of available mandates in constituency)\"\n  ) +\n  geom_boxplot(aes(\n    x = n_mandates,\n    y = p_pvv_ratio\n  ),\n  outlier.shape = NA,\n  fill = \"transparent\"\n  ) +\n  geom_point_interactive(aes(\n    x = n_mandates,\n    color = party3,\n    y = p_pvv_ratio, #p_pvv_ratio\n    data_id = party3,\n    tooltip = paste0(district_name, \"\\n\", party3, \": \", round(p_pvv_ratio * 100, 2), \" %\") #chagend from p_pvpv_ratio\n  ),\n  position = pos\n  ) +\n  geom_rect(\n    ymin = .8, ymax = Inf,\n    xmin = 0, xmax = Inf,\n    fill = plot_bg_color\n  ) +\n  geom_text(\n    data = constituencies_annotation,\n    aes(\n      y = .75,\n      x = n_mandates,\n      label = str_wrap(gebiete, width = 40)\n    ),\n    hjust = 0,\n    family = \"Roboto Condensed\",\n    nudge_x = 0.5,\n    lineheight = 0.8,\n    size = 3.5\n  ) +\n  scale_y_continuous(\n    labels = scales::percent_format(accuracy = 1),\n    limits = c(0, 1),\n    # expand=expansion(mult=c(0.1,0)),\n    breaks = seq(0, .75, .25)\n  ) +\n  scale_color_manual(values = party_colors) +\n  theme_post()+\n  theme(\n    axis.text.y = element_text(\n      size = 12, \n      vjust = 0,\n      hjust = 1\n    ),\n    axis.title.y = element_text(size=12, \n                                color=\"grey50\",\n                                hjust=1,\n                                angle=90),\n    axis.title.x = element_text(hjust=0,\n                                color=\"grey50\",\n                                size=12),\n    panel.grid.major.x = element_line(),\n    panel.grid.major.y = element_blank(),\n    legend.title = element_blank(),\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.direction = \"horizontal\",\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.subtitle = element_text(size = 12, color = \"grey30\"),\n    plot.caption=element_text(hjust=0),\n    plot.margin = margin(0, unit = \"cm\"),\n    plot.title.position = \"plot\") +\n  coord_flip()\n```\n\n\n```{r, include=F, eval=T}\nplot_n_mandates_interactive <- girafe(\n  code = print(plot_n_mandates),\n  width_svg = 10,\n  height_svg = 7,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:plot_bg_color;\t\n                 font-family:Roboto Condensed;\")\n  ))\n\n\n```\n\n\n```{r, include=F}\n# INCLUDED Candidate's preference vote vote ratio (C-PVPV) by list  ------------------------------------------\n\nshare <- df %>%\n  filter(!party3 == \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district, party3) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n  ungroup() %>%\n  mutate(share_pref = pref_votes_abs / sum_preference) %>%\n  # filter(share_pref>0.05) %>%  #change later\n  left_join(., info_constituencies,\n    by = c(\"district\")\n  )\n\ndf_thresholds <- tibble::tribble(\n  ~threshold, ~district_type,\n  .07, \"Bundeswahlkreis\",\n  .10, \"Landeswahlkreis\",\n  .14, \"Regionalwahlkreis\"\n)\n\ndf_thresholds_2 <- crossing(df_thresholds, unique(share$party3)) %>%\n  rename(party3 = `unique(share$party3)`)\n\ndf_share <- share %>%\n  left_join(., df_thresholds_2,\n    by = c(\"party3\", \"district_type\")\n  ) %>%\n  mutate(share_pref = share_pref * 100) %>%\n  left_join(., electoral_number %>%\n    select(district_name, electoral_number),\n  by = c(\"district\" = \"district_name\")\n  ) %>%\n  mutate(electoral_number_indicator = case_when(\n    pref_votes_abs > electoral_number ~ \"yes\",\n    TRUE ~ as.character(\"no\")\n  )) %>% \n  mutate(district_name=case_when(district_name==\"Gesamt\" ~ \"Österreich\",\n                                 TRUE ~ as.character(district_name))) %>% \n  left_join(., df_results %>% select(district_type, -district_name, district, party, votes_abs) %>% \n              mutate(party=as_factor(party)),\n              by=c(\"district_type\"=\"district_type\",\n               #  \"district_name\"=\"district_name\",\n                 \"district\"=\"district\",\n                 \"party3\"=\"party\")) %>% \n  mutate(c_pvpv_ratio=round(pref_votes_abs/votes_abs, 4)) %>%  #c_pvpv candidates' preference vote vote ratio\n  mutate(party3=as_factor(party3)) %>% \n  ungroup() %>% \n  group_by(district) %>% \n  mutate(sorting_index=cur_group_id()) #replaced group_indices\n\n\nx <- df_share %>% \n  select(district, district_name_short, sorting_index) %>% \n  distinct()\n\n\nplot_c_pvpv_ratio <- df_share %>%\n  filter(party3 != \"Other\") %>%\n  ungroup() %>% \n  group_split(district_type) %>%\n  # group_by(district_type) %>% \n  # split() %>% \n  map(~ ggplot(.) +\n    labs(\n      title = paste(unique(.$district_type)),\n      subtitle = paste(\"Candidates securing preference votes more than\n                    <span style='color:orange'>\", unique(.$threshold) * 100, \"</span> % of their party's overall vote in their respective constituency are re-ranked.\"),\n      x = \"Candidate's preference votes in % of party votes (C-PVPV)\"\n    ) +\n    geom_point_interactive(aes(\n      y = reorder(district_name_short, sorting_index),\n      x = c_pvpv_ratio*100,\n      # shape = as_factor(electoral_number_indicator),\n      color = party3,\n      data_id = name_short,\n      tooltip = paste(name_short, round(c_pvpv_ratio*100, 2), sep = \"; \")\n    ),\n    position = position_jitter(width = 0, height = 0.2, seed = 2),\n    stat = \"identity\"\n    ) +\n    geom_vline(aes(xintercept = threshold * 100),\n      color = \"firebrick\"\n    ) +\n    scale_y_discrete(expand = expansion(add = 0.2)) +\n    scale_x_continuous(\n      trans = \"log10\",\n      limits = c(NA, 40),\n      labels = scales::label_percent(accuracy = 1, scale = 1),\n      minor_breaks = NULL,\n      breaks = c(NA, 0, 1, 10, 40)\n    ) +\n    scale_color_manual(values = party_colors) +\n    ggforce::facet_row(vars(party3),\n      space = \"free\",\n      scale = \"free_x\",\n      shrink = T\n    ) +\ntheme_post()+\n    theme(\n      axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 9),\n      axis.title.y = element_blank(),\n      panel.spacing.x = unit(0.2, \"cm\"),\n      panel.spacing.y = unit(0.2, \"cm\"),\n      strip.text.x = element_text(\n        angle = 0,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      strip.text.y = element_text(\n        angle = 180,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      strip.placement = \"outside\",\n      # plot.title = element_text(size = 11, face = \"bold.italic\", \n      #                           margin=margin(b=0, unit=\"cm\")),\n      plot.subtitle = element_markdown(size = 11, \n                                       color = \"grey30\"),\n      plot.title.position = \"plot\",\n      legend.position = \"bottom\",\n      legend.title = element_blank(),\n      legend.justification = \"right\",\n      panel.grid.major.y = element_blank(),\n      plot.margin = margin(0, unit = \"cm\")\n    ) +\n    guides(color = \"none\"))\n\nplot_c_pvpv_ratio <- (patchwork::wrap_plots(plot_c_pvpv_ratio, ncol = 1) &\n  theme(plot.margin = margin(unit = \"cm\", 0))) +\n  plot_annotation(\n    title = \"Candidates' preference votes v. party votes ratio (C-PVPV)\",\n    subtitle = \"Candidates above vertical line move up the electoral list.\",\n    caption = my_caption_2,\n    theme = theme(\n      plot.title = element_text(family = \"Roboto Condensed\", \n                                size = 20,\n                                face = \"bold\"),\n      plot.subtitle = element_text(family = \"Roboto Condensed\", \n                                   size = 12,\n                                   face = \"plain\"),\n      plot.caption=element_text(hjust=0,\n                                color=\"grey30\"),\n      plot.background = element_rect(fill=plot_bg_color)))+\n      plot_layout(heights = c(1, 9, 39))\n```\n\n\n\n```{r, include=F}\n# > save ------------------------------------------------------------------\n\n\n# name <- \"C_PVPV_by_list\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 30\n# width <- 30\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n\nplot_c_pvpv_ratio_interactive <- girafe(\n  code = print(plot_c_pvpv_ratio),\n  width_svg = 10,\n  height_svg = 15,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:plot_bg_color;\t\n                 font-family:Roboto Condensed;\")\n  )\n)\n\n\n\n```\n\n\n\n\n```{r, include=F}\n# x <- girafe_options(\n#   x = my_plot,\n#   sizingPolicy(\n#     padding = \"0px\"\n#   )\n# )\n# \n# saveWidget(x,\n#   file = \"C_PVPV_by_list.html\",\n#   background = \"white\"\n# )\n#\n```\n\n\n```{r, include=F}\n# INCLUDED. Candidates crossing preference vote threshold -------------------------------------------\n\n\ndf_n_candidates_crossing_threshold <- df_share %>%\n  mutate(leader=case_when(rank_list==1 ~ \"list leader\",\n                          TRUE ~ as.character(\"not list leader\"))) %>% \n  mutate(threshold_share = case_when(\n    c_pvpv_ratio * 100> threshold * 100 ~ \"yes\",\n    TRUE ~ as.character(\"no\")\n  )) %>%\n  filter(threshold_share == \"yes\")\n # select(district_type, district_name_short, party3, c_pvpv_ratio, threshold) %>%\n  # group_by(district_type, party3, threshold_share) %>%\n  # summarise(n = n()) %>%\n\n\nplot_n_candidates_crossing_threshold <- df_n_candidates_crossing_threshold %>% \n  ggplot() +\n  labs(\n    title = \"Number of candidates crossing preference vote threshold\",\n    caption = my_caption_2\n  ) +\n  geom_bar(aes(\n    x = party3,\n    fill = leader,\n    group=leader,\n    ),\n  stat = \"count\",\n  position=position_stack(vjust=0.5)\n  ) +\n  geom_text(aes(x=party3,\n                group=leader,\n                label=..count..),\n            color=\"white\",\n            stat=\"count\",\n            position = position_stack(vjust=0.5))+\n  geom_text(aes(x=party3,\n                group=party3,\n                label=..count..),\n            color=\"black\",\n            stat=\"count\",\n            nudge_y = 0.5,\n            #position = position_stack(vjust=1)\n            )+\n  scale_y_continuous(breaks=seq(0, 20, 2))+\n  scale_fill_paletteer_d(\"ggsci::default_jama\")+\n  facet_wrap(vars(district_type)) +\n  theme_post()+\n  theme(\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.direction = \"horizontal\",\n    legend.title = element_blank(),\n    axis.title.y = element_blank(),\n    axis.title.x = element_blank(),\n    panel.grid.major.x = element_blank(),\n    plot.margin = margin(0, unit = \"cm\"),\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.caption = element_text(hjust = c(0))\n  )\n\n\n# name <- \"n_candidates_crossing_threshold\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# width <- 26.49\n# height <- 11.17\n# ggsave(\n#   plot = plot_n_candidates_crossing_threshold,\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   dpi = 96,\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n\n# INCLUDED Candidates crossing electoral number with preference votes (geofacet) -----------------------------------\nlibrary(geofacet)\n\naut_grid <- data.frame(\n  row = c(1, 1, 1, 2, 2, 2, 2, 2, 3),\n  col = c(3, 4, 5, 1, 2, 3, 4, 5, 4),\n  code = c(\"Oberösterreich\", \"Niederösterreich\", \"Wien\", \"Vorarlberg\", \"Tirol\", \"Salzburg\", \"Steiermark\", \"Burgenland\", \"Kärnten\"),\n  name = c(\"Oberösterreich\", \"Niederösterreich\", \"Wien\", \"Vorarlberg\", \"Tirol\", \"Salzburg\", \"Steiermark\", \"Burgenland\", \"Kärnten\")\n)\n\nstate_electoral_number <- df %>%\n  filter(party3 != \"Other\") %>%\n  filter(district_type == \"Landeswahlkreis\") %>%\n  left_join(.,\n    electoral_number %>% select(district_name, electoral_number),\n    by = c(\"district\" = \"district_name\")\n  ) %>%\n  select(district_type, district, name_short, party3, electoral_number, pref_votes_abs)\n\nstate_electoral_number_plot <- state_electoral_number %>%\n  ggplot() +\n  labs(\n    title = \"Candidates' preference votes and electoral number\",\n    caption = my_caption_2,\n    y = \"Preference votes\"\n  ) +\n  geom_point_interactive(aes(\n    x = party3,\n    color = party3,\n    y = pref_votes_abs,\n    tooltip = paste(\n      party3, \"\\n\",\n      name_short, pref_votes_abs\n    )\n  ),\n  position = position_jitter(width = 0.2, height = NULL, seed = 2)\n  ) +\n  geom_hline(aes(yintercept = electoral_number),\n    color = \"firebrick\"\n  ) +\n  geom_text(aes(\n    x = Inf, y = electoral_number,\n    label = scales::comma(electoral_number)\n  ),\n  color = \"firebrick\",\n  nudge_y = -3000,\n  family = \"Roboto Condensed\",\n  hjust = 1,\n  check_overlap = T\n  ) +\n  scale_color_manual(values = party_colors) +\n  scale_x_discrete(expand = expansion(mult = 0)) +\n  scale_y_continuous(\n    labels = scales::label_comma(),\n    expand = expansion(mult = 0),\n    limits = c(0, 35000),\n    minor_breaks = NULL\n  ) +\n  theme_post()+\n  theme(\n    axis.title.x = element_blank(),\n    axis.text.x = element_text(size = 9),\n    panel.grid.major.x = element_blank(),\n    strip.text.y = element_text(angle = 0, vjust = 1),\n    strip.text.x = element_text(size=14),\n    legend.position = \"none\",\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    # plot.title.position = \"plot\",\n    plot.caption = element_text(hjust=0),\n    plot.margin = margin(0, r = 0.2, unit = \"cm\"),\n    strip.background.x = element_rect(fill = plot_bg_color, color=NA),\n    panel.border = element_rect(color = plot_bg_color, fill = \"transparent\")\n  ) +\n  facet_geo(~district, grid = aut_grid) +\n  guides(color = \"none\")\n\n\n# > save ------------------------------------------------------------------\n\nstate_electoral_number_plot_interactive <- girafe(\n  code = print(state_electoral_number_plot),\n  width_svg = 10,\n  height_svg = 6,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:plot_bg_color;\t\n                 font-family:Roboto Condensed;\")\n  )\n)\n```\n\n\n```{r, include=F}\n# x <- girafe_options(\n#   x = my_plot,\n#   sizingPolicy(padding = \"0px\")\n# )\n# \n# saveWidget(x,\n#   file = \"state_electoral_number_plot.html\",\n#   background = \"white\"\n# )\n```\n\n\n```{r, include=F}\n# INCLUDED Concentration of preference votes (gini) ------------------------------------------------------------------\n\nlibrary(reldist)\n\n\n# > plot --------------------------------------------------------------------\n\nplot_gini <- df %>%\n  filter(party3 != \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  left_join(., info_constituencies, by = c(\"district\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district_name_short, party3) %>%\n  summarise(gini_pref = gini(pref_votes_abs)) %>%\n  ggplot() +\n  labs(\n    title = \"Concentration of preference votes\",\n    caption = my_caption_2,\n    y = \"Gini coefficient\"\n  ) +\n  geom_point_interactive(aes(\n    x = party3,\n    y = gini_pref,\n    color = party3,\n    tooltip = paste(\n      district_name_short, \"\\n\",\n      party3, round(gini_pref, 2)\n    )\n  ),\n  pos = position_jitter(width = 0.2, height = NULL, seed = 2)\n  ) +\n  geom_boxplot(aes(\n    x = party3,\n    y = gini_pref\n  ),\n  size=0.5,\n  color=\"grey30\",\n  fill = \"transparent\",\n  outlier.shape = NA\n  ) +\n  scale_color_manual(values = party_colors) +\n  scale_x_discrete(expand = expansion(mult = 0)) +\n  scale_y_continuous(\n    labels = scales::label_comma(),\n    limits = c(0, 1),\n    expand = expansion(mult = 0),\n    minor_breaks = NULL\n  ) +\n  facet_wrap(vars(district_type)) +\n  theme_post()+\n  theme(\n    axis.title.x = element_blank(),\n    panel.grid.major.x = element_blank(),\n    strip.text.y = element_text(angle = 0, \n                                vjust = 1),\n    strip.text.x = element_text(size=12),\n    legend.position = \"none\",\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.caption = element_text(hjust=0)#,\n    # plot.margin = margin(0, unit = \"cm\")\n  ) +\n  guides(color = \"none\")\n```\n\n```{r, include=F}\n# > save --------------------------------------------------------------------\n\nplot_gini_interactive <- girafe(\n  code = print(plot_gini),\n  width_svg = 10,\n  height_svg = 6,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = glue::glue(\"background-color:{plot_bg_color}; font-family:Roboto Condensed\")))\n)\n\n\n```\n\n\n\n```{r, include=F}\n# INCLUDED Competitiveness  ----------------------------------------------------------\n\n\n# > NOT INCLUDED: Difference as share of total preference votes -------------------------\n\n# df %>%\n#   filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n#   # filter(district==\"Gesamt\") %>%\n#   filter(!is.na(pref_votes_abs)) %>%\n#   group_by(district_type, state, district, party3) %>%\n#   arrange(desc(pref_votes_abs), .by_group = T) %>%\n#   mutate(index = row_number()) %>%\n#   mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n#   filter(index < 3) %>%\n#   mutate(pref_diff = pref_votes_abs - lead(pref_votes_abs)) %>%\n#   mutate(diff_perc = pref_diff / sum_preference) %>%\n#   filter(!is.na(diff_perc)) %>%\n#   mutate(indicator = paste0(district, \"-\", name_short)) %>%\n#   mutate(indicator = district) %>%\n#   ggplot() +\n#   labs(\n#     title = \"Lead\",\n#     subtitle = \"Lead in % of party's total number of preference votes\"\n#   ) +\n#   geom_bar(aes(\n#     y = indicator,\n#     x = diff_perc\n#   ),\n#   stat = \"identity\"\n#   ) +\n#   lemon::facet_rep_grid(\n#     cols = vars(party3),\n#     rows = vars(district_type),\n#     # repeat.tick.labels = T,\n#     scales = \"free\",\n#     drop = T,\n#     space = \"free\"\n#   ) +\n#   hrbrthemes::theme_ipsum_rc() +\n#   theme(axis.text.x = element_text(angle = 90))\n```\n\n\n```{r, include=F}\n# > INCLUDED: Difference % leader vs runers-up ---------------------------------------------------\n\n\nd <- df %>%\n  left_join(., info_constituencies, by = c(\"district\")) %>%\n  filter(!party3 == \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district, party3) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n  filter(index < 3) %>%\n  mutate(share_pref = pref_votes_abs / sum_preference) %>%\n  mutate(indicator = district) # %>%\n\nd <- d %>%\n  ggplot() +\n  labs(\n    title = \"Lead\",\n    subtitle = \"Lead in % of party's total number of preference votes\",\n    x = \"Share of intra-party preference votes; leader and runners-up.\"\n  ) +\n  # geom_point(aes(\n  #   y = district_name_short,\n  #   x = share_pref,\n  #   shape = as_factor(index),\n  #   color=party3\n  # ),\n  # stat = \"identity\"\n  # ) +\n  geom_point_interactive(aes(\n    y = district_name_short,\n    x = share_pref,\n    shape = as_factor(index),\n    color = party3,\n    data_id = name_short,\n    tooltip = name_short,\n  ),\n  stat = \"identity\"\n  ) +\n  scale_x_continuous(\n    limits = c(0, 1),\n    labels = scales::percent_format(accuracy = 1),\n    minor_breaks = NULL,\n    breaks = seq(0, 1, .5)\n  ) +\n  scale_shape_manual(\n    labels = c(\"1\" = \"leader\", \"2\" = \"runners-up\"),\n    values = c(1, 2)\n  ) +\n  scale_color_manual(values = party_colors) +\n  lemon::facet_rep_grid(\n    cols = vars(party3),\n    rows = vars(district_type),\n    repeat.tick.labels = F,\n    scales = \"free\",\n    space = \"free\",\n    drop = T\n  ) +\n  hrbrthemes::theme_ipsum_rc() +\n  theme(\n    axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),\n    axis.title.y = element_blank(),\n    panel.spacing.x = unit(0.1, \"cm\"),\n    panel.spacing.y = unit(0.2, \"cm\"),\n    strip.text.y = element_text(angle = 0, vjust = 1),\n    legend.position = \"bottom\",\n    legend.title = element_blank(),\n    legend.justification = \"right\"\n  ) +\n  guides(color = \"none\")\n\n\n# >> save ------------------------------------------------------------------\n\nd_interactive <- girafe(\n  code = print(d),\n  width_svg = 8,\n  height_svg = 12,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T)\n  )\n)\n\n\n# x <- girafe_options(\n#   x = my_plot,\n#   sizingPolicy(\n#     padding = \"0px\"\n#   )\n# )\n# \n# saveWidget(x,\n#   file = \"pi_Difference_leading_runnersup_prefernece_votes.html\",\n#   background = \"gray\"\n# )\n# \n# \n# name <- \"Difference_leading_runnersup_prefernece_votes\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 30\n# width <- 30\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n```\n\n\n```{r, include=F}\n# INCLUDED difference leader - runnersup vs n mandates -----------------------------\n\nd1 <- df %>%\n  left_join(., info_constituencies, by = c(\"district\")) %>%\n  filter(!party3 == \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district, party3) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n  filter(index < 3) %>%\n  mutate(share_pref = pref_votes_abs / sum_preference) %>%\n  mutate(indicator = district) %>%\n  select(\n    district_type, state, district, party3, name_short, district_name, n_mandates, district_name_short,\n    indicator, share_pref, index\n  ) %>%\n  group_by(district_type, state, district, party3, district_name, district_name_short, indicator) %>%\n  mutate(\n    runners_up = lead(name_short),\n    runners_up_share = lead(share_pref)\n  ) %>%\n  rename(\n    leader = name_short,\n    leader_share = share_pref\n  ) %>%\n  filter(index == 1) %>%\n  mutate(share_diff = leader_share - runners_up_share) %>%\n  ungroup() %>%\n  mutate(n_mandates = fct_reorder(as_factor(n_mandates), as.numeric(n_mandates)))\n\nplot_difference <- d1 %>%\n  ggplot() +\n  labs(\n    title = \"Difference between top-2 candidates' preference vote share by constituency list\",\n    y = \"Differnce between top-2 candidates' preference vote share\",\n    caption = my_caption_2\n  ) +\n  geom_point_interactive(aes(\n    x = party3,\n    y = share_diff,\n    color = party3,\n    tooltip = paste(\n      district_name_short, \"\\n\",\n      leader, round(leader_share * 100, 2), \"%\", \"\\n\",\n      runners_up, round(runners_up_share * 100, 2), \"%\", \"\\n\"\n    )\n  ),\n  pos = position_jitter(width = 0.2, height = NULL, seed = 2)\n  ) +\n  geom_boxplot(aes(\n    x = party3,\n    y = share_diff\n  ),\n  fill = \"transparent\",\n  outlier.shape = NA\n  ) +\n  scale_y_continuous(\n    limits = c(0, 1),\n    labels = scales::label_percent()\n  ) +\n  scale_color_manual(values = party_colors) +\n  facet_wrap(vars(district_type)) +\n  theme_post()+\n  theme(\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.title.position = \"plot\",\n    legend.position = \"none\",\n    plot.caption = element_text(hjust = c(0)),\n    axis.title.x = element_blank(),\n    plot.margin = margin(0, unit = \"cm\"),\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.y = element_blank()\n  )\n\n\n\n# >> save ------------------------------------------------------------------\n\nplot_difference_interactive <- girafe(\n  code = print(plot_difference),\n  width_svg = 10,\n  height_svg = 6,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:plot_bg_color;\tfont-family:Roboto Condensed;\")\n  )\n)\n\n\n```\n\n\n# Context\n\nOn 29 September, Austria held its general elections to the national assembly (*Nationalrat*). By now a flurry of analyses and comments has been published and the caravan of political commentary has largely moved on, at least when it comes to the analysis of the results itself (the [government formation](https://www.nytimes.com/reuters/2019/11/10/world/europe/10reuters-austria-politics.html){target=\"_blank\"} train  is finally also getting up to speed). One aspect, I personally have never looked into, and which seems to fall a bit under the radar, is the use of preference votes by Austria's electorate.  This post is essentially my first 'exploratory' go at preference votes. No specific question, no specific theoretical framework in mind, just poking. I'll first present the results, then detail some of the steps implemented in R to obtain, analyze and visualize the relevant data. The entire code for the analysis is available on my github [account](https://github.com/zoowalk/NRW19_preference_votes/){target=\"_blank\"}. As always, if you spot any glaring error etc, don't hesitate and let me know.\n\nPreference vote (*Vorzugsstimme*) refer to voters' option (but not obligation) to indicate their support/preference for specific candidates running for the party of their choice. Since Austrian candidates run on a nation wide federal district list (*Bundeswahlkreis*), one of nine state district lists (*Landeswahlkreis*), or/and one of 39 regional district lists (*Regionalwahlkreis*), voters can cast up to three preference votes [(here](https://www.help.gv.at/Portal.Node/hlpd/public/resources/documents/NRW2017_Vorzugsstimmen.jpg){target=\"_blank\"} a sample ballot slip). Eventually, a candidate's number of preference votes can be consequential when it comes to distributing the seats which a party won to the individual candidates. Without preference votes, seats are distributed in accordance to candidates' position on the electoral list. The lower a candidate is on a list, the lower the likelihood that she can actually get a seat. However, with a sufficient large number of preference votes, the pre-election order on the electoral list can change and initially lower ranked candidates can move up and eventually gain a seat. For details see [here](https://www.oesterreich.gv.at/themen/leben_in_oesterreich/wahlen/1/Seite.320260.html){target=\"_blank\"}.\n\n# Results\n\n## by district list\n\nOverall, there were 1,8 million preference votes cast. The largest part (more than 60 %) were cast for candidates running on regional district lists. Probably this could be read as voters been particularly keen to support 'their' local/regional candidates to make it into the new parliament. Ties between voters and regional candidates are likely to be different than those between voters and candidates running on the more 'removed' federal or state constituency list.\n\n\n\n```{r echo=FALSE, fig.height=3, fig.width=10, message=FALSE, warning=FALSE, code_folding=NULL}\npl_by_district\n```\n\n\n## by constituency list and party\n\nIf we further disaggregate these numbers and differentiate between parties, we see that preference votes obtained on the regional level accounted for the majority of preference votes for all parties. However, there is a noticeable difference between the comparable low 55.9 % of the Freedom Party (FPÖ) and e.g. the 65.7 % of the Social Democrats (SPÖ) or the 64.1 % of the NEOS. Or put differently, with 34.1 % the share of preference votes obtained on the federal level, the Freedom Party stands out. As for the underlying reasons, I can only speculate. One reading could be that voters of the FPÖ have weaker ties to their candidates on the regional or state level and hence felt less inclined to cast a preference vote for them. Another one could be that the relation among FPÖ's candidates on the federal list were particularly competitive and hence a disproportionate high number of voters were mobilized to cast their preference votes on the federal list. Considering the exit of former party leader HC Strache ([Ibiza](https://www.theguardian.com/world/2019/may/20/austria-ibiza-scandal-sting-operation-what-happened-why-does-it-matter){target=\"_blank\"}...) and the subsequent (not yet consolidated?) change in the leadership, this seems plausible (see below). It however does not explain why FPÖ voters did not cast preference votes for candidates on state or regional lists.\n\n```{r echo=FALSE, message=FALSE, warning=FALSE, code_folding=NULL, background=plot_bg_color}\npl_constituency_list_party\n```\n\n\n\n## Top 5 candidates\nIf we are interested in candidates, which candidates were particularly successful in securing preference votes?\n\n\n```{r echo=FALSE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE, code_folding=NULL}\npl_top_5_candidates\n\n```\n\nThe graph above clearly demonstrates the predominate role of former chancellor Sebastian Kurz when it comes to preference votes. With more than 150,000 votes his result clearly outclasses those of any other candidate. With the notable exception of the FPÖ, the leading candidates/party leaders of all parties succeeded in securing most of the preference votes. In the case of the FPÖ, former Minister of Interior Herbert Kickl overtook his party's leader, Norbert Hofer. What is also noticeable is that party leaders almost exclusively secured their preference votes from the federal constituency list, while their colleagues largely relied on votes from the regional constituency list.^[Reportedly, Hofer's 'defeat' to Kickl might be due to an administrative issue though. There was another FPÖ candidate with the family name Hofer running on the federal constituency list. When voters put only the candidate's family name on the ballot to indicate their preference, it was not clear which Hofer was actually meant. As a consequence, these preference votes were reportedly ruled as invalid.] \n\nLooking at the rankings within parties, I have to admit that I was a bit surprised by the strong performance of a some candidates which I at least had never heard of. The result of T. Mete for the SPÖ, and J Hechenberger for the ÖVP were particularly surprising to me.\n\n## Regional dimension\n\n### by district magnitude\n\nThe plot below displays a party's total number of preference votes as percentage of a party's total vote in each regional electoral constituency.  Let's call this for the sake of easier reference **parties' preference votes - party votes ratio**. Or to predend a serious color, **P-PVPV** ratio.^[I assume that the literature on preference votes has already coined a term for this indicator, but for the limited analysis here I leave it with this.] This PVPV ratio are grouped by constituencies' magnitude (number of mandates). The motivation behind is the assumption that the fewer mandates are available the higher will be also intra-party competition. With a smaller cake to distribute (fewer mandates), candidates will try particularly hard to win preference votes and move up the electoral list. Here the analysis is limited to the 39 regional electoral lists. To avoid the indivudal dots overlapping, some random vertical variation was introduced.\n\nThe plot seems to provide at least some backing to this proposition. The constituency with only 1 mandate to compete for (Osttirol) features the highest median of parties' PVPV ratio. While the picture is not entirely clear cut, there seems to be indeed a decreasing median share as constituencies' magnitude increases from to two to seven mandates. The constituencies with eight and nine mandates (Graz-Umgebung, Hausruckviertel, OberStmk), however, do deviate. \nHover over the individual dots to get details.^[There seems to be an issue with the hoover over effect on mobile devices. If anyone knows how to iron this out, please let me know.]\n\n```{r, echo=F, code_folding=NULL}\nplot_n_mandates_interactive\n```\n\n### by state\n\nIf we are interested in whether there are any regional differences when it comes to parties' PVPV ratios, grouping them by states can be of some help. As the boxplots below show, on average parties' PVPV ratio was the largest in Burgenland followed by Vorarlberg. These two states are Austria's two smallest in terms of population. On the other end, Upper Autria (Oberösterreich), Lower Austria (Niedrösterreich), Styria (Steiermark), and Vienna featured on average clearly lower PVPV ratios. These states are Austria's  largest. This difference would be in line with the proposition that candidates in smaller states are better in mobilizing personal support, i.e. preference votes. Closer candidate-voter relations due to smaller population size sounds rather probable to me. But this would certainly need further analysis to corroborate the claim.\n\n```{r, code_folding=NULL, echo=F}\nplot_region_interactive\n```\n\n\n## Intra-party dynamics\nAs already outlined above, preference votes are first and foremost interesting from an intra-party perspective. With sufficient votes, candidates which embarked on the electoral campaign from a lower ranked position can move up the intra-party ladder and secure a seat. \n\nSo when do candidate's move up the ballot list?^[See [here](https://www.oesterreich.gv.at/themen/leben_in_oesterreich/wahlen/1/Seite.320260.html){target=\"_blank\"} for details] \n\n+ On the federal level: when a candidate got a preference votes of at least 7 % of those who voted for her party.\n+ On the state level: when a candidate got preference votes of of at least 10 % of those who voted for her party, *or* at least as many preference votes as the 'electoral number' (*Wahlzahl*)^[By dividing the number of valid votes in a state level constituency by the number of the constituency's available mandates one gets the 'electoral number'].\n+ On the regional level: when a candidate got preference votes by at least 14 % of those who voted for her party. \n\nDid this happen often?\n\n### Candidates' preference vote party vote ratio\nThe graph below presents **candidates' preference votes - party votes ratio**, or, to stay ~~serious~~ clumsy, **C-PVPV**. This ratio is candidates' number of preference votes expressed as % of the total number of votes of her party (in the respective constituency/list). The vertical red lines indicate the stipulated thresholds which candidates have to pass in order to move up on the party's electoral list. Hover over the individual points to get the data pertaining to each candidate. Note that the x-axis is log-transformed to ensure candidates with low C-PVPV ratios remain (somewhat) visible. Note also that only those candidates are included which actually obtained at least one preference vote. \n\n```{r, echo=F, code_folding=NULL}\nplot_c_pvpv_ratio_interactive\n```\n\nWhile the graph provides plenty of details, a few general things standout. First, on the federal level, only two candidates crossed the threshold. Former chancellor Kurz (ÖVP) and former Minister of Interior Kickl (FPÖ). Second, on the state level, not a single candidate secured sufficient preference votes. However, there are several candidates running on regional lists who were able to cross the pertaining threshold. Note that there is no district in which more than one candidate from one party crossed the threshold. \n\n### Candidates' preference votes and electoral number\nAside from candidates' preference-vote party-vote ratio, candidates have one further avenue to be promoted. See point two of the conditions listed above. On the state constituency level, candidates can move up the ladder not only if they crossed the 10 % threshold, but also if they would have reached more preference votes than the electoral number. The graph below presents the pertaining figures. In short, none of the candidates succeeded in doing so in these elections. In fact, candidates are pretty far from this threshold.\n\n```{r}\n#| column: body-outset-left\n#| fig-width: 12\nstate_electoral_number_plot_interactive\n```\n\nWith the above, we know by now who was able to muster sufficient preference votes to cross the relevant thresholds. However, when aggregating, it makes sense to differentiate between list leaders and those of lower ranks. \n\n```{r, code_folding=NULL, echo=F}\nplot_n_candidates_crossing_threshold\n```\n\nThe graph below provides the number of candidates per party who were able to cross the required preference vote threshold. On the regional list level, ÖVP, SPÖ, and FPÖ had the same number of candidates, followed by the Greens and Neos. What the graph also reveals is that in the predominant part of cases, the successful candidates were in fact parties' federal/regional list leaders. In total, only seven candidates which were not list leaders succeeded in securing the necessary preference votes. Probably noteworthy, 4 of these 7 cases originate from the FPÖ. Does this mean anything? I am tempted to suspect that parties with clear hiearchial structures are less likely to see lower rank candidates overtake their party's list leaders. In cases, though, in which e.g. the leadership question is not entirely settled, or leaders are confronted with very strong 'colleagues' (Feind, Todfeind... Parteifreund), successful preference vote campaigns are more likely to occur. At least that's an interpretation which came to my mind when seeing the numbers pertaining to the FPÖ (did I hear 'selecting on the dependent variable'?). On the other hand, this proposition is immediately relativized when checking who these candidates were. With Kunasek (former Minister of Defense, leader of Styria's FPÖ) and Haimbuchner (leader of Upper Austria's FPÖ), we have two FPÖ representatives from the party's upper echelons, who put their names on the ballot list, but - as far as I am aware - see their future as for now (again) in their home states rather than in the national parlament. I am only speculating here, but I found it at least noteworthy that the FPÖ somewhat deviates.\n\n### Difference Leader and Runners-up\n\nAnother angle to look at preference votes could be to examine the difference between the two candidates leading in terms of the number of preference votes. This gives us some idea on how dominant a candidate has been, i.e. whether the intra-party contestation at the top was particularly high. The graph above seeks to display the difference in candidates' **preference vote share** per party and electoral district. Preference vote share is a candidate's share of her party's total preference votes in the respective list/constituency. Here, the higher the difference between those, the lower the contestation for the top spot. Hover over the dots to see the two top candidate and their respective share of preference votes. Not the small gap between SPÖ's leader Rendi-Wagner and Mete.\n\n\n```{r, code_folding=NULL, echo=F}\nplot_difference_interactive\n```\n\n### Concentration of preference votes\n\nLast but not least, to round off the picture, let's see how different parties are when it comes to the concentration of preference votes. Are a party's preference votes going almost exclusively to one or only a few candidates (high concentration)? Or, are preference votes relatively evenly shared among different candidates (low concentration)? A measure of concentration (Gini coefficient) can provide us with another angle on intra-party dynamics. Below the results:  \n\n\n```{r, code_folding=NULL, echo=F}\nplot_gini_interactive\n```\n\n# Steps in R\nBelow some of the most important steps in R to obtain the results above. The full code is published on my github account [here](https://github.com/werkstattcodes/NRW19_preference_votes){target=\"_blank\"}\n\n## Obtaining the preference vote results\nThe first potential hurdle is to virtually 'liberate' the results pertaining to the preference vote. Just have a look a the format of the data [here](https://www.bmi.gv.at/412/Nationalratswahlen/Nationalratswahl_2019/files/NRW19_Vorzugsstimmen_Landes_Regionalparteiliste_16102019.pdf){target=\"_blank\"} and [here](https://www.bmi.gv.at/412/Nationalratswahlen/Nationalratswahl_2019/files/NRW19_Vorzugsstimmen_bundesweit_16102019.pdf){target=\"_blank\"}. Particularly the results for the state and regional electoral district lists are not what a follower of '[tidy data](https://vita.had.co.nz/papers/tidy-data.pdf){target=\"_blank\"}' would hope for. So let's start wrangling:\n\n\n```{r, ref.label=\"extract_data\", eval=F, code_folding=\"Code: Extract data\", include=T}\n```\n\nEt voila (here only the first entries). If needed, you can downlaod the cleaned file [here](https://github.com/werkstattcodes/NRW19_preference_votes/master/data/AUT_NRW19_preference_votes.csv){target=\"_blank\"} github repo.\n\n```{r echo=FALSE, message=FALSE, warning=TRUE, eval=F}\n#table.start\ndf_merge %>% \n  reactable(.,\n          filterable = T,\n          pagination = T,\n          height = 250,\n          outlined = T,\n          bordered = F,\n          compact=T,\n          theme=reactableTheme(backgroundColor = plot_bg_color,\n                           style=list(fontFamily=\"Karla\",\n                                      fontSize=\"12px\"),\n                           filterInputStyle = list(\n                             color=\"black\",\n                             backgroundColor = plot_bg_color)))\n#table.end\n```\n\n\nIf needed, you can download the cleaned file [here](https://github.com/zoowalk/NRW19_preference_votes/master/data/AUT_NRW19_preference_votes.csv){target=\"_blank\"} from the github repo.\n\n## Abbreviating names, removing titles\nAn issue which has as been a frequent source of annoyance is the verbose use of academic and other (obviously even more important) titles in names. It only unnecessarily takes space from graphs and has something, in my personal view, deeply inegalitarian to it (the very purpose of using titles is probably to signal inegalitrianism). So, let's remove all titles and only use the first letter of the first name. [`Regex`](https://stringr.tidyverse.org/articles/regular-expressions.html){target=\"_blank\"} and [`stringr`](https://stringr.tidyverse.org/index.html){target=\"_blank\"} are your friends here. Since this is a task which comes up time and again, it actually screams for a r package...\n\n```{r, eval=F}\nfn_remove_titles <- function(x) {\n  titles <- c(\n    \"Mag\", \"MMag\", \"Prof\", \"Dr\", \"O\\\\.Univ\\\\.Prof\", \"Dipl-Ing\", \"Dipl.-Ing.\", \"Dipl.-Rev.\", \"Ing\",\n    \"Dipl\", \"jun\", \"sen\", \"Ba\", \"\\\\(FH\\\\)\", \"MSc\",\n    \"med\", \"univ\", \"Bsc\", \"phil\", \"iur\", \"DDr\", \"BEd\", \"DI\", \"Mba\", \"Mas\", \"MA\", \"MIM\",\n    \"vet\", \"M.A.\", \"PMM\", \"MTD\", \"Päd\", \"Bakk\"\n  ) %>%\n    map(., paste0, c(\"\\\\.\", \"\\\\s\", \"\\\\,\")) %>%\n    unlist()\n\n\n  name_wo_titles <- stringr::str_remove_all(x, regex(\"[[:alpha:]\\\\-]+\\\\.\")) %>%\n    str_remove_all(., regex(\"\\\\([:alpha:]+\\\\)\")) %>%\n    str_remove_all(., regex(paste0(titles, collapse = \"|\"), ignore_case = T)) %>%\n    str_squish()\n}\n\n\nfn_short_name <- function(x) {\n  family_name <- stringr::str_extract(x, \"^[[:alpha:]\\\\-|\\\\s]+(?=,)\") %>%\n    str_to_title() %>%\n    str_squish() %>%\n    str_trim()\n\n  first_name <- str_extract(x, regex(\"(?<=\\\\,)[[:alpha:]\\\\-\\\\s]*$\")) %>%\n    str_trim() %>%\n    str_squish() %>%\n    str_to_title()\n\n  initals <- str_split(first_name, \"\\\\s\") %>%\n    map(., str_sub, start = 1L, end = 1L) %>%\n    map_chr(., str_c, collapse = \".\") %>%\n    paste0(., \".\")\n\n  name_short <- paste(family_name, initals, sep = \", \")\n}\n\n\ndf <- df_merge %>%\n  mutate(district = str_remove(district, \"Landesparteiliste\") %>%\n    str_remove(., \"Regionalparteiliste\") %>%\n    str_trim(., side = c(\"both\"))) %>%\n  mutate(district = case_when(\n    district == \"B\" ~ \"Burgenland\",\n    district == \"S\" ~ \"Salzburg\",\n    district == \"K\" ~ \"Kärnten\",\n    district == \"NÖ\" ~ \"Niederösterreich\",\n    district == \"OÖ\" ~ \"Oberösterreich\",\n    district == \"Stmk\" ~ \"Steiermark\",\n    district == \"Vlbg\" ~ \"Vorarlberg\",\n    TRUE ~ district\n  )) %>%\n  mutate(district = as_factor(district)) %>%\n  mutate(party2 = str_extract(party, regex(\"\\\\([:alpha:]*\\\\)\")) %>% # take parties' short abbrevs.\n    str_remove_all(., \"\\\\(|\\\\)\")) %>%\n  mutate(name_orig = name) %>%\n  mutate(name = map_chr(name_orig, fn_remove_titles)) %>%\n  mutate(name_short = map_chr(name, fn_short_name)) %>%\n  mutate(state = case_when(\n    str_detect(district, \"^[0-9].*\") ~ str_sub(district, start = 1L, end = 1L),\n    TRUE ~ as.character(district)\n  )) %>%\n  mutate(state = case_when(\n    state == 1 ~ \"Burgenland\",\n    state == 2 ~ \"Kärnten\",\n    state == 3 ~ \"Niederösterreich\",\n    state == 4 ~ \"Oberösterreich\",\n    state == 5 ~ \"Salzburg\",\n    state == 6 ~ \"Steiermark\",\n    state == 7 ~ \"Tirol\",\n    state == 8 ~ \"Vorarlberg\",\n    state == 9 ~ \"Wien\",\n    TRUE ~ NA_character_\n  )) %>%\n  mutate(district_type = fct_relevel(district_type, \"Bundeswahlkreis\", \"Landeswahlkreis\", \"Regionalwahlkreis\"))\n\n```\nWith the above we are basically ready to roll and start analyzing the data in earnest. The code below gives you the first plot (preference votes by district lists).\n\n## Plot - Total number of preference votes per electoral district\n\n\n```{r, eval=F, code_folding=\"Code: Plot total number of preference votes per electoral district\"}\n\ndf_list <- df %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  group_by(district_type) %>%\n  summarise(district_type_votes = sum(pref_votes_abs, na.rm = T)) %>%\n  #  arrange(desc(district_type_votes)) %>%\n  mutate(district_type = forcats::fct_relevel(district_type, \"Regionalwahlkreis\", \"Landeswahlkreis\", \"Bundeswahlkreis\")) %>%\n  mutate(district_type_votes_cum = cumsum(district_type_votes)) %>%\n  mutate(district_type_votes_perc = district_type_votes / sum(district_type_votes)) %>%\n  mutate(district_type = forcats::fct_reorder(district_type, district_type_votes_cum, .desc = F))\n\npl_by_district <- df_list %>%\n  ggplot() +\n  geom_bar(aes(\n    x = 1,\n    y = district_type_votes,\n    fill = district_type,\n    group = district_type\n  ),\n  stat = \"identity\"\n  ) +\n  geom_text(aes(\n    x = 1,\n    y = district_type_votes,\n    group = district_type,\n    label = paste(scales::comma(district_type_votes),\n      scales::percent(district_type_votes_perc),\n      sep = \"\\n\"\n    )\n  ),\n  colour = \"white\",\n  position = position_stack(vjust = .5, reverse = F)\n  ) +\n  scale_y_continuous(\n    expand = expansion(mult = c(0, 0.05)),\n    breaks = max(df_list$district_type_votes_cum),\n    label = scales::comma(max(df_list$district_type_votes_cum))\n  ) +\n  scale_fill_paletteer_d(\"ggsci::default_jama\",\n    labels = c(\n      \"Regionalwahlkreis\" = \"Regional lists\",\n      \"Landeswahlkreis\" = \"State lists\",\n      \"Bundeswahlkreis\" = \"Federal list\"\n    )\n  ) +\n  labs(\n    title = \"Total number of preference votes per electoral district\",\n    caption = my_caption_2,\n    y = \"number of preference votes\"\n  ) +\n  \n  # hrbrthemes::theme_ipsum_tw() +\n  # theme(\n  #   plot.background = element_rect(fill=)\n  #   legend.position = \"top\",\n  #   legend.justification = \"left\",\n  #   plot.title.position = \"plot\",\n  #   legend.title = element_blank(),\n  #   axis.text.y = element_blank(),\n  #   axis.title.y = element_blank(),\n  #   plot.title = element_text(size = 13),\n  #   panel.grid = element_blank(),\n  #   plot.caption = element_markdown(hjust = c(0, 1), color = \"grey30\"),\n  #   plot.margin = margin(t = 0, l = 0, b = 0, r = 1, unit = \"cm\")\n  # ) +\n  coord_flip() +\n  guides(fill = guide_legend(reverse = T))+\n  theme_post()+\n  theme(legend.position=\"top\",\n        legend.justification = \"left\",\n        legend.direction  = \"horizontal\",\n        plot.caption =element_text(hjust=0),\n        # plot.background=element_rect(fill = \"plot_bg_color\", color=\"plot_bg_color\"),\n        legend.title = element_blank(),\n        axis.text.y = element_blank(),\n        panel.grid.major.y = element_blank()\n        \n        )\n\n\n\n\n```\n\n```{r code_folding=NULL, echo=F, fig.height=3, fig.width=10, dev=\"png\"}\npl_by_district\n```\n\n## Group_split, map, and ggplot\n\nAnother part of the code which I'd like to highlight is the one producing the [*plot on candidates' preference votes share*](http://werk.statt.codes/post/vorzugsstimmen/#candidates-preference-votes-share). Here, rather than using a `facet_grid`, I split the dataframe by the electoral district lists, and mapped the plot function to each of the three parts, and subsequently combined them with `patchwork`. The advantage was that graph is more efficient in using the available space.\n\n```{r, eval=F, code_folding=\"plot on candidates’ preference votes share\"}\n\nshare <- df %>%\n  filter(!party2 == \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district, party2) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n  ungroup() %>%\n  mutate(share_pref = pref_votes_abs / sum_preference) %>%\n  # filter(share_pref>0.05) %>%  #change later\n  left_join(., info_constituencies,\n    by = c(\"district\")\n  )\n\ndf_thresholds <- tibble::tribble(\n  ~threshold, ~district_type,\n  .07, \"Bundeswahlkreis\",\n  .10, \"Landeswahlkreis\",\n  .14, \"Regionalwahlkreis\"\n)\n\ndf_thresholds_2 <- crossing(df_thresholds, unique(share$party3)) %>%\n  rename(party3 = `unique(share$party3)`)\n\n\ndf_share <- share %>%\n  left_join(., df_thresholds_2,\n    by = c(\"party3\", \"district_type\")\n  ) %>%\n  mutate(share_pref = share_pref * 100) %>%\n  left_join(., electoral_number %>%\n    select(district_name, electoral_number),\n  by = c(\"district\" = \"district_name\")\n  ) %>%\n  mutate(electoral_number_indicator = case_when(\n    pref_votes_abs > electoral_number ~ \"yes\",\n    TRUE ~ as.character(\"no\")\n  )) %>% \n  mutate(district_name=case_when(district_name==\"Gesamt\" ~ \"Österreich\",\n                                 TRUE ~ as.character(district_name))) %>% \n  left_join(., df_results %>% select(district_type, -district_name, district, party, votes_abs) %>% \n              mutate(party=as_factor(party)),\n              by=c(\"district_type\"=\"district_type\",\n               #  \"district_name\"=\"district_name\",\n                 \"district\"=\"district\",\n                 \"party3\"=\"party\")) %>% \n  mutate(c_pvpv_ratio=round(pref_votes_abs/votes_abs, 4)) %>%  #c_pvpv candidates' preference vote vote ratio\n  mutate(party3=as_factor(party3)) %>% \n  ungroup() %>% \n  mutate(sorting_index=group_indices(., district))\n\n\nx <- df_share %>% \n  select(district, district_name_short, sorting_index) %>% \n  distinct()\n\n\nplot_c_pvpv_ratio <- df_share %>%\n  filter(party3 != \"Other\") %>%\n  group_split(district_type) %>%\n  map(~ ggplot(.) +\n    labs(\n      title = paste(unique(.$district_type)),\n      subtitle = paste(\"Candidates securing preference votes more than\n                    <span style='color:orange'>\", unique(.$threshold) * 100, \"</span> % of their party's overall vote in their respective constituency are re-ranked.\"),\n      x = \"Candidate's preference votes in % of party votes (C-PVPV)\"\n    ) +\n    geom_point_interactive(aes(\n      y = reorder(district_name_short, sorting_index),\n      x = c_pvpv_ratio*100,\n      # shape = as_factor(electoral_number_indicator),\n      color = party3,\n      data_id = name_short,\n      tooltip = paste(name_short, round(c_pvpv_ratio*100, 2), sep = \"; \")\n    ),\n    position = position_jitter(width = 0, height = 0.2, seed = 2),\n    stat = \"identity\"\n    ) +\n    geom_vline(aes(xintercept = threshold * 100),\n      color = \"firebrick\"\n    ) +\n    scale_y_discrete(expand = expansion(add = 0.2)) +\n    scale_x_continuous(\n      trans = \"log10\",\n      limits = c(NA, 40),\n      labels = scales::label_percent(accuracy = 1, scale = 1),\n      minor_breaks = NULL,\n      breaks = c(NA, 0, 1, 10, 40)\n    ) +\n    scale_color_manual(values = party_colors) +\n    ggforce::facet_row(vars(party3),\n      space = \"free\",\n      scale = \"free_x\",\n      shrink = T\n    ) +\ntheme_post()+\n    theme(\n      axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 9),\n      axis.title.y = element_blank(),\n      panel.spacing.x = unit(0.2, \"cm\"),\n      panel.spacing.y = unit(0.2, \"cm\"),\n      strip.text.x = element_text(\n        angle = 0,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      strip.text.y = element_text(\n        angle = 180,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      strip.placement = \"outside\",\n      plot.title = element_text(size = 11, face = \"bold.italic\", \n                                margin=margin(b=0, unit=\"cm\")),\n      plot.subtitle = element_markdown(size = 11, color = \"grey30\",\n                                       face=\"italic\"),\n      plot.title.position = \"plot\",\n      legend.position = \"bottom\",\n      legend.title = element_blank(),\n      legend.justification = \"right\",\n      panel.grid.major.y = element_blank(),\n      plot.margin = margin(0, unit = \"cm\")\n    ) +\n    guides(color = \"none\"))\n\nplot_c_pvpv_ratio <- (patchwork::wrap_plots(plot_c_pvpv_ratio, ncol = 1) &\n  theme(plot.margin = margin(unit = \"cm\", 0))) +\n  plot_annotation(\n    title = \"Candidates' preference votes v. party votes ratio (C-PVPV)\",\n    subtitle = \"Candidates above vertical line move up the electoral list.\",\n    caption = my_caption,\n    theme = theme(\n      plot.title = element_text(family = \"Roboto Condensed\", size = 12,face = \"bold\"),\n      plot.subtitle = element_text(family = \"Roboto Condensed\", size = 12,face = \"plain\")))+\n      plot_layout(heights = c(1, 9, 39))\n\n```\n## Obtaining district magnitude\n\nA convenient way to get data on the districts' magnitude (number of mandates) is to scrap the pertainnig data from the website of the Ministry of Interior. The `rvest`package´ is our reliable tool here.\n\n```{r code_folding=\"Scrap data from site of MoI\", eval=F}\nlibrary(rvest, quietly = T, verbose = F, warn=F)\n\nMoI_url <- \"https://www.bmi.gv.at/412/Nationalratswahlen/Wahlkreiseinteilung.aspx\"\n\nn_mandates_regional_districts <- MoI_url %>%\n  read_html() %>%\n  html_nodes(\"table\") %>%\n  html_table() %>%\n  map_df(., bind_rows)\n```\n\n\n```{r message=FALSE, warning=FALSE, paged.print=TRUE, code_folding=NULL, echo=F, eval=F}\n#table.start\nlibrary(reactable)\nn_mandates_regional_districts %>% \n  reactable(.,\n            filterable = T,\n          pagination = T,\n          height = 250,\n          outlined = T,\n          bordered = F,\n          compact=T,\n          theme=reactableTheme(backgroundColor = plot_bg_color,\n                           style=list(fontFamily=\"Karla\",\n                                      fontSize=\"12px\"),\n                           filterInputStyle = list(\n                             color=\"black\",\n                             backgroundColor = plot_bg_color)))\n\n#table.end\n```\n\n## Geo_facet\nFinally, as the last item, I'd like to highlight the wonderful [`geo_fact` package](https://hafen.github.io/geofacet){target=\"_blank\"}. Rather than plotting data to a map by means of different color (shades), the `geo_facet` package allows facets of a plot to be arranged (more or less) in accordance with the map of e.g. a country. Here, I first created a grid which approximates the position the Austria's states (*Bundesländer*), i.e. state electoral districts. This grid is subsequently passed on to the faceting function used in an otherwise ordinary ggplot command. The result you saw above [here](http://werk.statt.codes/post/vorzugsstimmen/#candidates-preference-votes-and-electoral-number). Sweet, isn't ;-)\n\nGladly, the author of the `geo_facet` package offers users the possibility to [submit](https://hafen.github.io/grid-designer/){target=\"_blank\"} new grids to be integrated into the package. Once I have polished the grid (e.g. add iso codes), I'll submit it and you can use it by simply calling the grid's name in the geo_facet function (update: the grid [was submitted](https://github.com/hafen/geofacet/issues/226){target=\"_blank\"} and now part of the package).\n\n```{r, eval=F, code_folding=\"Code geo_facet grid Austria\"}\nlibrary(geofacet)\n\naut_grid <- data.frame(\n  row = c(1, 1, 1, 2, 2, 2, 2, 2, 3),\n  col = c(3, 4, 5, 1, 2, 3, 4, 5, 4),\n  code = c(\"Oberösterreich\", \"Niederösterreich\", \"Wien\", \"Vorarlberg\", \"Tirol\", \"Salzburg\", \"Steiermark\", \"Burgenland\", \"Kärnten\"),\n  name = c(\"Oberösterreich\", \"Niederösterreich\", \"Wien\", \"Vorarlberg\", \"Tirol\", \"Salzburg\", \"Steiermark\", \"Burgenland\", \"Kärnten\")\n)\n\nstate_electoral_number <- df %>%\n  filter(party3 != \"Other\") %>%\n  filter(district_type == \"Landeswahlkreis\") %>%\n  left_join(.,\n    electoral_number %>% select(district_name, electoral_number),\n    by = c(\"district\" = \"district_name\")\n  ) %>%\n  select(district_type, district, name_short, party3, electoral_number, pref_votes_abs)\n\nstate_electoral_number_plot <- state_electoral_number %>%\n  ggplot() +\n  labs(\n    title = \"Candidates' preference votes and electoral number\",\n    caption = my_caption_2,\n    y = \"Preference votes\"\n  ) +\n  geom_point_interactive(aes(\n    x = party3,\n    color = party3,\n    y = pref_votes_abs,\n    tooltip = paste(\n      party3, \"\\n\",\n      name_short, pref_votes_abs\n    )\n  ),\n  position = position_jitter(width = 0.2, height = NULL, seed = 2)\n  ) +\n  geom_hline(aes(yintercept = electoral_number),\n    color = \"firebrick\"\n  ) +\n  geom_text(aes(\n    x = Inf, y = electoral_number,\n    label = scales::comma(electoral_number)\n  ),\n  color = \"firebrick\",\n  nudge_y = -3000,\n  family = \"Roboto Condensed\",\n  hjust = 1,\n  check_overlap = T\n  ) +\n  scale_color_manual(values = party_colors) +\n  scale_x_discrete(expand = expansion(mult = 0)) +\n  scale_y_continuous(\n    labels = scales::label_comma(),\n    expand = expansion(mult = 0),\n    limits = c(0, 35000),\n    minor_breaks = NULL\n  ) +\n  hrbrthemes::theme_ipsum_rc() +\n  theme(\n    axis.title.x = element_blank(),\n    axis.text.x = element_text(size = 9),\n    panel.grid.major.x = element_blank(),\n    strip.text.y = element_text(angle = 0, vjust = 1),\n    legend.position = \"none\",\n    plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.title.position = \"plot\",\n    plot.caption = element_markdown(hjust = c(0, 1), color = \"grey30\"),\n    plot.margin = margin(0, r = 0.2, unit = \"cm\"),\n    strip.background.x = element_rect(fill = \"lightgrey\"),\n    panel.border = element_rect(color = \"lightgrey\", fill = \"transparent\")\n  ) +\n  facet_geo(~district, grid = aut_grid) +\n  guides(color = \"none\")\n```\n\n\n","srcMarkdownNoYaml":"\n\n\n```{r setup, include=FALSE}\nlibrary(rvest, quietly = T, verbose = F, warn=F)\nlibrary(tidyverse, quietly = T, verbose = F, warn=F)\nlibrary(knitr, quietly =T)\nlibrary(paletteer)\nlibrary(ggtext)\nlibrary(ggforce)\nlibrary(extrafont)\nloadfonts(device = \"win\", quiet = T)\nlibrary(hrbrthemes)\nlibrary(patchwork)\nlibrary(ggiraph)\nlibrary(lemon)\nlibrary(reactable)\n\nplot_bg_color <- \"white\"\n\nknitr::opts_chunk$set(echo = T, background=plot_bg_color)\n\n\ntheme_post <- function() {\n  hrbrthemes::theme_ipsum_rc() +\n    theme(\n      plot.background = element_rect(fill = plot_bg_color, color=NA),\n      panel.background = element_rect(fill = plot_bg_color, color=NA),\n      #panel.border = element_rect(colour = plot_bg_color, fill=NA),\n      #plot.border = element_rect(colour = plot_bg_color, fill=NA),\n      plot.margin = margin(l = 0, \n                           t = 0.25,\n                           unit = \"cm\"),\n      plot.title = element_text(\n        color = \"grey20\",\n        face = \"bold\",\n        margin = margin(l = 0, b=0.25, unit = \"cm\"),\n        size = 18\n      ),\n      plot.title.position = \"plot\",\n      plot.subtitle = element_text(\n        color = \"grey50\",\n        margin = margin(t = 0.2, b = 0.3, unit = \"cm\"),\n        size = 11\n      ),\n      plot.caption = element_text(\n        color = \"grey50\",\n        size = 11\n      ),\n      plot.caption.position = \"panel\",\n      axis.title.x = element_text(\n        angle = 0,\n        color = \"grey50\",\n        hjust = 1\n      ),\n      axis.text.x = element_text(\n        size = 12,\n        color = \"grey50\"\n      ),\n      axis.title.y = element_blank(),\n      axis.text.y = element_text(\n        size = 9,\n        color = \"grey50\"\n      ),\n      panel.grid.minor.x = element_blank(),\n      panel.grid.major.x = element_blank(),\n      panel.grid.minor.y = element_blank(),\n      panel.spacing = unit(0.25, \"cm\"),\n      panel.spacing.y = unit(0.25, \"cm\"),\n      strip.text = element_text(\n        angle = 0,\n        size = 9,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      legend.title = element_text(\n        color = \"grey30\",\n        face = \"bold\",\n        vjust = 1,\n        size = 7\n      ),\n      legend.text = element_text(\n        size = 12,\n        color = \"grey30\"\n      ),\n      legend.justification = \"left\",\n      legend.box = \"horizontal\", # arrangement of multiple legends\n      legend.direction = \"vertical\",\n      legend.margin = margin(l = 0, t = 0, unit = \"cm\"),\n      legend.spacing.y = unit(0.07, units = \"cm\"),\n      legend.text.align = 0,\n      legend.box.just = \"top\",\n      legend.key.height = unit(0.2, \"line\"),\n      legend.key.width = unit(0.5, \"line\"),\n      text = element_text(size = 5)\n    )\n}\n\n\nmy_caption_2 <- c(\"Data: bmi.gv.at/412/Nationalratswahlen/Nationalratswahl_2019/start.aspx#vorzugsstimmen\\nAnalysis: Roland Schmidt | @zoowalk | https://werk.statt.codes\")\n\n\n```\n\n\n```{r include=F, echo=F}\n# preps -------------------------------------------------------------------\n\nparty_colors <- c(FPÖ = \"#005DA8\", NEOS = \"#EA5290\", ÖVP = \"#5DC2CC\", SPÖ = \"#FC0204\", GRÜNE = \"#A3C630\")\n\nmain_parties <- c(\"SPÖ\", \"ÖVP\", \"NEOS\", \"GRÜNE\", \"FPÖ\")\n```\n\n\n```{r extract_data, include=F, echo=F, eval=T}\n# get state and regional list--------------------------------------\n\ndf_state_region <- readxl::read_xlsx(path = here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"NRW19_Vorzugsstimmen_Landes_Regionalparteiliste_16102019.xlsx\"))\n\nnames(df_state_region) <- names(df_state_region) %>%\n  stringr::str_remove(., \"\\r\") %>%\n  stringr::str_remove(., \"\\n\") %>%\n  stringr::str_remove(., \"-\")\n\ndf_state_region <- df_state_region %>%\n  janitor::clean_names()\n\ndf_state_region_long <- df_state_region %>%\n  mutate(party = map_chr(reihung_1, ~ str_extract(., regex(\"^List.*\")))) %>%\n  mutate(state_list = map_chr(reihung_1, ~ str_extract(., regex(\"^Landespartei.*\")))) %>%\n  mutate(regional_list = map_chr(familien_vorname_2, ~ str_extract(., regex(\"^Regionalpartei.*\")))) %>% # mess in bmi file; heading in different columns\n  mutate(regional_list_2 = map_chr(reihung_1, ~ str_extract(., regex(\"^Regionalpartei.*\")))) %>%\n  mutate(district = coalesce(state_list, regional_list, regional_list_2)) %>%\n  janitor::remove_empty(\"rows\") %>%\n  fill(., district, .direction = c(\"down\")) %>%\n  fill(., party, .direction = c(\"down\")) %>%\n  select(-c(\"x6\", \"state_list\", \"regional_list\", \"regional_list_2\")) %>%\n  filter(str_detect(reihung_1, \"^[0-9]\")) %>%\n  select(district, party, everything()) %>%\n  rename_at(\n    vars(reihung_7:vorz_stimm_11),\n    function(x) str_replace_all(x, \"[:digit:]+\", \"b\")\n  ) %>%\n  rename_at(\n    vars(reihung_1:vorz_stimm_5),\n    function(x) str_replace_all(x, \"[:digit:]+\", \"a\")\n  ) %>%\n  mutate_at(vars(reihung_a:vorz_stimm_b), as.character) %>%\n  pivot_longer(\n    cols = reihung_a:vorz_stimm_b, names_to = c(\".value\", \"result\"),\n    names_pattern = \"(.*)_([a|b]$)\"\n  ) %>%\n  mutate_at(vars(reihung, geb_jahr, vorz_stimm), as.numeric) %>%\n  group_by(district, party) %>%\n  arrange(reihung, .by_group = T) %>%\n  mutate(district_type = case_when(\n    str_detect(district, regex(\"Landes.*\")) ~ \"Landeswahlkreis\",\n    str_detect(district, regex(\"^Regional.*\")) ~ \"Regionalwahlkreis\",\n    TRUE ~ NA_character_\n  )) %>%\n  select(district_type, district, party, everything(), -result) %>%\n  rename(\n    name = familien_vorname,\n    pref_votes_abs = vorz_stimm,\n    # district_type = district_type,\n    # district = district,\n    rank_list = reihung,\n    birth_year = geb_jahr,\n  ) %>%\n  ungroup()\n\n\n# get federal list --------------------------------------\n\ndf_federal <- readxl::read_xlsx(\n  path=here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"NRW19_Vorzugsstimmen_bundesweit_16102019.xlsx\"),\n  col_name = F,\n  trim_ws = T\n)\n\nnames(df_federal) <- c(\n  \"Nr\", \"Familienname, Vorname\", \"Geb.-Jahr\", \"Beruf\",\n  \"Gesamt\", \"B\", \"K\", \"NÖ\", \"OÖ\", \"S\", \"Stmk\", \"Tirol\",\n  \"Vlbg\", \"Wien\"\n)\n\n\ndf_federal_clean <- df_federal %>%\n  janitor::remove_empty(., which = c(\"rows\")) %>%\n  filter(!Nr == \"Nr.\") %>%\n  mutate(party = str_extract(Nr, regex(\"[:alpha:].*\"))) %>%\n  fill(., party, .direction = c(\"down\")) %>%\n  filter(!str_detect(Nr, regex(\"[:alpha:]\"))) %>%\n  mutate(district_type = \"Bundeswahlkreis\") %>%\n  pivot_longer(cols = Gesamt:Wien, names_to = \"district\", values_to = \"pref_votes_abs\")\n\n\n# rename to be consistent with regional/state level\ndf_federal_clean <- df_federal_clean %>%\n  select(district_type, district, party,\n    rank_list = \"Nr\", name = \"Familienname, Vorname\", birth_year = \"Geb.-Jahr\",\n    beruf = \"Beruf\", everything()\n  ) %>%\n  mutate_at(vars(\"rank_list\", \"birth_year\", \"pref_votes_abs\"), ~ stringr::str_trim(., side = c(\"both\"))) %>%\n  mutate_at(vars(\"rank_list\", \"birth_year\", \"pref_votes_abs\"), as.numeric)\n\n\n# bind both bund, laender and regio -------------------------------------------------------------------\n\ndf_merge <- bind_rows(\n  df_state_region_long,\n  df_federal_clean\n) %>%\n  ungroup() %>% \n  filter(!is.na(name))\n\n# write.csv2(df_merge,\n#            file = paste0(wdr, \"/data/AUT_NRW19_preference_votes.csv\"),\n#            row.names = F,\n#            fileEncoding = \"latin1\"\n# )\n\n\nfn_remove_titles <- function(x) {\n  titles <- c(\n    \"Mag\", \"MMag\", \"Prof\", \"Dr\", \"O\\\\.Univ\\\\.Prof\", \"Dipl-Ing\", \"Dipl.-Ing.\", \"Dipl.-Rev.\", \"Ing\",\n    \"Dipl\", \"jun\", \"sen\", \"Ba\", \"\\\\(FH\\\\)\", \"MSc\",\n    \"med\", \"univ\", \"Bsc\", \"phil\", \"iur\", \"DDr\", \"BEd\", \"DI\", \"Mba\", \"Mas\", \"MA\", \"MIM\",\n    \"vet\", \"M.A.\", \"PMM\", \"MTD\", \"Päd\", \"Bakk\"\n  ) %>%\n    map(., paste0, c(\"\\\\.\", \"\\\\s\", \"\\\\,\")) %>%\n    unlist()\n\n\n  name_wo_titles <- stringr::str_remove_all(x, regex(\"[[:alpha:]\\\\-]+\\\\.\")) %>%\n    str_remove_all(., regex(\"\\\\([:alpha:]+\\\\)\")) %>%\n    str_remove_all(., regex(paste0(titles, collapse = \"|\"), ignore_case = T)) %>%\n    str_squish()\n}\n\n\nfn_short_name <- function(x) {\n  family_name <- stringr::str_extract(x, \"^[[:alpha:]\\\\-|\\\\s]+(?=,)\") %>%\n    str_to_title() %>%\n    str_squish() %>%\n    str_trim()\n\n  first_name <- str_extract(x, regex(\"(?<=\\\\,)[[:alpha:]\\\\-\\\\s]*$\")) %>%\n    str_trim() %>%\n    str_squish() %>%\n    str_to_title()\n\n  initals <- str_split(first_name, \"\\\\s\") %>%\n    map(., str_sub, start = 1L, end = 1L) %>%\n    map_chr(., str_c, collapse = \".\") %>%\n    paste0(., \".\")\n\n  name_short <- paste(family_name, initals, sep = \", \")\n}\n\ndf <- df_merge %>%\n  mutate(district = str_remove(district, \"Landesparteiliste\") %>%\n    str_remove(., \"Regionalparteiliste\") %>%\n    str_trim(., side = c(\"both\"))) %>%\n  mutate(district = case_when(\n    district == \"B\" ~ \"Burgenland\",\n    district == \"S\" ~ \"Salzburg\",\n    district == \"K\" ~ \"Kärnten\",\n    district == \"NÖ\" ~ \"Niederösterreich\",\n    district == \"OÖ\" ~ \"Oberösterreich\",\n    district == \"Stmk\" ~ \"Steiermark\",\n    district == \"Vlbg\" ~ \"Vorarlberg\",\n    TRUE ~ district\n  )) %>%\n  mutate(district = as_factor(district)) %>%\n  mutate(party2 = str_extract(party, regex(\"\\\\([:alpha:]*\\\\)\")) %>% # take parties' short abbrevs.\n    str_remove_all(., \"\\\\(|\\\\)\")) %>%\n  mutate(name_orig = name) %>%\n  mutate(name = map_chr(name_orig, fn_remove_titles)) %>%\n  mutate(name_short = map_chr(name, fn_short_name)) %>%\n  mutate(state = case_when(\n    str_detect(district, \"^[0-9].*\") ~ str_sub(district, start = 1L, end = 1L),\n    TRUE ~ as.character(district)\n  )) %>%\n  mutate(state = case_when(\n    state == 1 ~ \"Burgenland\",\n    state == 2 ~ \"Kärnten\",\n    state == 3 ~ \"Niederösterreich\",\n    state == 4 ~ \"Oberösterreich\",\n    state == 5 ~ \"Salzburg\",\n    state == 6 ~ \"Steiermark\",\n    state == 7 ~ \"Tirol\",\n    state == 8 ~ \"Vorarlberg\",\n    state == 9 ~ \"Wien\",\n    # TRUE ~ NA_character_\n    TRUE ~ state,\n  )) %>%\n  mutate(district_type = fct_relevel(district_type, \"Bundeswahlkreis\", \"Landeswahlkreis\", \"Regionalwahlkreis\")) %>% \n  mutate(name = case_when(\n    str_detect(name, \"Pistracher\") ~ \"Pistracher, Gerald\",\n    TRUE ~ as.character(name)))\n\n```\n \n\n \n```{r, include=F, echo=F}\n# readr::write_csv2(df, file=here::here(\"posts\", \n#                                       \"2019-11-20-vorzugsstimmen\",\n#                                       \"df.csv\"))\n```\n\n\n```{r include=FALSE}\ndf <- readr::read_csv2(file=here::here(\"posts\", \n                                       \"2019-11-20-vorzugsstimmen\",\n                                       \"df.csv\"))\n \ndf <- df %>%\n  mutate(party3 = fct_other(party2, keep = main_parties) %>%\n    fct_relevel(., \"ÖVP\", \"SPÖ\", \"FPÖ\", \"GRÜNE\", \"NEOS\", \"Other\"))\n```\n\n\n```{r include=FALSE}\n# INCLUDED top 5 candidates per party ----------------------------------------------\n\ntop_candidates <- df %>%\n  # filter(party2 %in% main_parties) %>%\n  filter(!str_detect(district, \"Gesamt\")) %>%\n  group_by(party3, name) %>%\n  summarise(preferences_candidate = sum(pref_votes_abs, na.rm = T)) %>%\n  arrange(desc(preferences_candidate), .by_group = T) %>%\n  slice(1:5)\n\ndf_pl <- df %>%\n  filter(name %in% top_candidates$name) %>%\n  filter(!str_detect(district, \"Gesamt\")) %>%\n  group_by(party3, name, district_type) %>%\n  summarise(sum_candiate = sum(pref_votes_abs, na.rm = T)) %>% # rename sum_candidate\n  group_by(party3) %>%\n  arrange(desc(sum_candiate), .by_group = T) %>%\n  ungroup() %>%\n  group_by(name) %>%\n  mutate(total_candidate = sum(sum_candiate)) %>%\n  ungroup() %>%\n  mutate(name = forcats::fct_reorder(name, total_candidate, .desc = F))\n```\n\n\n```{r include=FALSE}\npl_top_5_candidates <- df_pl %>%\n  ggplot() +\n  geom_bar(aes(\n    x = name,\n    y = sum_candiate,\n    fill = district_type\n  ),\n  width = 0.8,\n  stat = \"identity\"\n  ) +\n  geom_text(\n    data = top_candidates,\n    aes(\n      x = name,\n      y = max(top_candidates$preferences_candidate)+70000,\n      label = scales::comma(preferences_candidate, accuracy = 1)\n    ),\n    stat = \"identity\",\n    family = \"Roboto Condensed\",\n    color = \"grey50\",\n    hjust = 1\n  ) +\n  labs(\n    caption = my_caption_2,\n    title = \"Candidates with most preference votes (Top 5)\",\n    y = \"Number of preference votes in 1,000\"\n  ) +\n  scale_x_discrete(label = fn_short_name) +\n  scale_y_continuous(\n    label = scales::comma_format(scale = 0.001),\n    expand = expansion(mult = c(0, 0.1)),\n    breaks = seq(0, max(top_candidates$preferences_candidate), 25000),\n    minor_breaks = NULL\n  ) +\n  scale_fill_paletteer_d(\"ggsci::default_jama\",\n    labels = c(\n      \"Regionalwahlkreis\" = \"Regional lists\",\n      \"Landeswahlkreis\" = \"State lists\",\n      \"Bundeswahlkreis\" = \"Federal list\"\n    )\n  ) +\n  facet_wrap(vars(party3),\n    ncol = 2,\n    scale = \"free_y\"\n  ) +\n  coord_flip() +\n  theme_post()+\n  theme(\n    panel.grid.major.y = element_blank(),\n    panel.grid.major.x = element_line(),\n    panel.spacing.x = unit(0, units = \"cm\"),\n    panel.spacing.y = unit(0.25, units = \"cm\"),\n    axis.title.y = element_blank(),\n    axis.title.x = element_text(hjust=0, size=13),\n    # axis.text.y = element_text(hjust=0),\n    axis.text.x = element_text(size=13),\n    axis.text.y = element_text(size=13),\n    plot.caption=element_text(hjust=0),\n    legend.title = element_blank(),\n    legend.direction = \"horizontal\",\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.key.size = unit(0.4, units = c(\"cm\")),\n    plot.title.position = \"panel\",\n    plot.background = element_rect(fill=plot_bg_color),\n    strip.text = element_text(face = \"bold\",\n                              size=14)\n  ) +\n  guides(fill = guide_legend(rev = T, ))\n\n\n\n```\n\n```{r, include=F}\n# INCLUDED top per district_type (not included) -----------------------------------------------------------\n\nfn_top_plot <- function(x) {\n  x %>%\n    ggplot() +\n    geom_bar(aes(\n      x = name,\n      y = pref_votes_abs\n    ),\n    stat = \"identity\"\n    ) +\n    labs(title = paste(unique(x$district_type))) +\n    scale_x_discrete(labels = fn_short_name) +\n    hrbrthemes::theme_ipsum_ps() +\n    facet_wrap(vars(district),\n      scales = \"free_y\"\n    ) +\n    coord_flip()\n}\n\nlist_plots <- df %>%\n  filter(!district == \"Gesamt\") %>%\n  group_by(district_type, district) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  slice(1:3) %>%\n  ungroup() %>%\n  group_split(district_type) %>%\n  map(~ fn_top_plot(.))\n\n```\n\n\n```{r, include=F}\n# difference btw ranking and number of preferential votes -----------------\n\ndf_rank_diff <- df %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  group_by(party3, district_type, district) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(rank_votes = row_number()) %>%\n  mutate(rank_diff = rank_list - rank_votes) %>%\n  select(district_type, district, party3, name, pref_votes_abs, rank_list, rank_votes, rank_diff) %>%\n  arrange(desc(rank_diff))\n\ndf_rank_diff_long <- df_rank_diff %>%\n  filter(party3 %in% main_parties) %>%\n  pivot_longer(\n    cols = c(rank_list, rank_votes),\n    values_to = \"rank_no\",\n    names_to = \"ranking_type\"\n  )\n\n# df_rank_diff_long %>%\n#   ggplot() +\n#   geom_point(aes(\n#     x = fct_rev(ranking_type),\n#     y = rank_no,\n#     group = name,\n#     color = party3\n#   )) +\n#   geom_line(aes(\n#     x = fct_rev(ranking_type),\n#     y = rank_no,\n#     group = name,\n#     color = party3\n#   )) +\n#   ggrepel::geom_text_repel(aes(\n#     x = fct_rev(ranking_type),\n#     y = rank_no,\n#     group = name,\n#     label = name,\n#     color = party3\n#   ),\n#   size = 2\n#   ) +\n#   facet_grid(rows = vars(party3), cols = vars(district_type))\n\n\n# INCLUDED Composition of preferential votes ---------------------------------------\n\ndf_list <- df %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  group_by(district_type) %>%\n  summarise(district_type_votes = sum(pref_votes_abs, na.rm = T)) %>%\n  #  arrange(desc(district_type_votes)) %>%\n  mutate(district_type = forcats::fct_relevel(district_type, \"Regionalwahlkreis\", \"Landeswahlkreis\", \"Bundeswahlkreis\")) %>%\n  mutate(district_type_votes_cum = cumsum(district_type_votes)) %>%\n  mutate(district_type_votes_perc = district_type_votes / sum(district_type_votes)) %>%\n  mutate(district_type = forcats::fct_reorder(district_type, district_type_votes_cum, .desc = F))\n\npl_by_district <- df_list %>%\n  ggplot() +\n  geom_bar(aes(\n    x = 1,\n    y = district_type_votes,\n    fill = district_type,\n    group = district_type\n  ),\n  stat = \"identity\"\n  ) +\n  geom_text(aes(\n    x = 1,\n    y = district_type_votes,\n    group = district_type,\n    label = paste(scales::comma(district_type_votes),\n                  scales::percent(district_type_votes_perc),\n                  sep = \"\\n\"\n    )\n  ),\n  colour = \"white\",\n  position = position_stack(vjust = .5, reverse = F)\n  ) +\n  scale_y_continuous(\n    expand = expansion(mult = c(0, 0.05)),\n    breaks = max(df_list$district_type_votes_cum),\n    label = scales::comma(max(df_list$district_type_votes_cum))\n  ) +\n  scale_fill_paletteer_d(\"ggsci::default_jama\",\n                         labels = c(\n                           \"Regionalwahlkreis\" = \"Regional lists\",\n                           \"Landeswahlkreis\" = \"State lists\",\n                           \"Bundeswahlkreis\" = \"Federal list\"\n                         )\n  ) +\n  labs(\n    title = \"Total number of preference votes per electoral district\",\n    caption = my_caption_2,\n    y = \"number of preference votes\"\n  ) +\n  coord_flip() +\n  guides(fill = guide_legend(reverse = T))+\n  theme_post()+\n  theme(legend.position=\"top\",\n        legend.justification = \"left\",\n        legend.direction  = \"horizontal\",\n        plot.caption =element_text(hjust=0),\n        legend.title = element_blank(),\n        axis.text.y = element_blank(),\n        panel.grid.major.y = element_blank()\n        \n  )\n```\n\n\n```{r, include=F}\n# INCLUDED by constituency list and party  -------------------------------------------------------------\n\nx <- df %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  group_by(party3, district_type) %>%\n  summarise(district_type_votes = sum(pref_votes_abs, na.rm = T)) %>%\n  arrange(desc(district_type_votes)) %>%\n  mutate(district_type_votes_cum = cumsum(district_type_votes)) %>%\n  mutate(district_type_votes_perc = district_type_votes / sum(district_type_votes)) %>%\n  ungroup()\n\npl_constituency_list_party <- x %>%\n  filter(party3 != \"Other\") %>%\n  ggplot() +\n  geom_bar(aes(\n    x = party3,\n    y = district_type_votes,\n    group = district_type,\n    fill = district_type\n  ),\n  color = NA,\n  stat = \"identity\",\n  position = \"fill\"\n  ) +\n  geom_text(aes(\n    x = party3,\n    group = district_type,\n    y = district_type_votes_perc,\n    label = scales::percent(district_type_votes_perc, accuracy = 0.1)\n  ),\n  color = \"white\",\n  position = position_stack(vjust = 0.5, reverse = F)\n  ) +\n  labs(\n    title = str_wrap(\"Contribution of different electoral constituencies to total of preferential votes\", 70),\n    caption = my_caption_2\n  ) +\n  scale_fill_paletteer_d(\"ggsci::default_jama\",\n    labels = c(\n      \"Regionalwahlkreis\" = \"Regional lists\",\n      \"Landeswahlkreis\" = \"State lists\",\n      \"Bundeswahlkreis\" = \"Federal list\"\n    )\n  ) +\n  scale_y_continuous(\n    labels = scales::percent,\n    expand = expansion(mult = c(0, 0))\n  ) +\n  scale_x_discrete(expand = expansion(mult = c(0, 0.2)),\n                   position = \"top\") +\n  theme_post()+\n  theme(axis.title.x=element_blank(),\n        legend.title = element_blank(),\n        panel.grid.major.x = element_blank(),\n        plot.title=element_text(),\n        legend.position=\"top\",\n        legend.justification = \"left\",\n        legend.direction =\"horizontal\",\n        plot.caption = element_text(hjust=c(0)))+\n  guides(fill = guide_legend(reverse = F))\n\n```\n\n\n```{r, include=F, eval=T}\n# save --------------------------------------------------------------------\n\n# x <- girafe_options(\n#   x = my_plot,\n#   sizingPolicy(padding = \"0px\")\n# )\n# \n# saveWidget(x,\n#   file = \"Party_PVPv_state.html\",\n#   selfcontained = T,\n#   background = \"white\"\n# )\n# \n\n# name <- \"Party_PVPv_state\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 20\n# width <- 30\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n# \n\n\n# intra-party movements due to preference votes --------------------------\n\n\n# > import election results -----------------------------------------------\n\nnrw19_imp <- readr::read_csv2(\n  file = here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"wahl_20191003_214253.csv\"),\n  locale = locale(encoding = \"latin1\")\n) %>%\n  janitor::remove_empty(., which = c(\"cols\")) %>%\n  janitor::clean_names() %>%\n  rename(gkz = x1)\n\nnrw19 <- nrw19_imp %>%\n  mutate(state = str_sub(gkz, 2, 2)) %>%\n  mutate(district_pol = str_sub(gkz, 3, 4)) %>% # Bezirk\n  mutate(municipality = str_sub(gkz, 5, 6)) %>%\n  mutate(level = case_when(\n    str_sub(gkz, 2, 2) == 0 ~ \"gesamt\",\n    str_detect(gkz, regex(\"^[A-Z][1-9]00[0,9][0,9]\")) ~ \"Bundesland\",\n    str_detect(gkz, regex(\"^G.{1}[A-Z].+\")) ~ \"Regional-Wahlkreis\",\n    str_detect(gkz, regex(\"^G[1-9][0-9][1-9]00\")) ~ \"Bezirk\",\n    str_detect(gkz, regex(\"^G[1-9][0-9][1-9]99\")) ~ \"Bezirk\",\n    str_detect(gkz, regex(\"^G[1-9][0-9][1-9][0-8][0-9]\")) ~ \"Gemeinde\",\n    TRUE ~ as.character(\"u\")\n  )) %>%\n  mutate(wahlkarten = case_when(\n    str_detect(gkz, regex(\"99$\")) ~ \"ja\",\n    TRUE ~ as.character(\"nein\")\n  )) %>%\n  select(level,\n    district_name = gebietsname, gkz, electorate_size = wahlberechtigte,\n    votes_mail = wahlkarten, state, votes_casted = abgegebene, district_pol,\n    municipality, everything()\n  )\n\n\nnrw19_bezirk <- nrw19 %>%\n  filter(votes_mail == \"nein\") %>%\n  filter(level == \"Bezirk\")\n\nnrw19_bezirk <- nrw19_bezirk %>%\n  mutate(turnout = votes_casted / electorate_size * 100) %>%\n  mutate_at(vars(spo, ovp, fpo, grune, neos), .funs = list(perc = ~ .x / gultige))\n\nnrw19_long <- nrw19_bezirk %>%\n  select(contains(\"perc\"), district_name, gkz, turnout) %>%\n  pivot_longer(., cols = contains(\"perc\"), names_to = \"party\", values_to = \"party_perc\")\n\n\n\n# > federal level ---------------------------------------------------------\nresults_federal_list <- nrw19 %>%\n  filter(level == \"gesamt\")\n\nresults_federal_list_long <- results_federal_list %>%\n  pivot_longer(cols = ovp:slp, names_to = \"party\", values_to = \"votes_abs\") %>%\n  mutate(district_type = \"Bundeswahlkreis\") %>%\n  mutate(district = \"00\") %>%\n  select(district_type, district_name, district, party, votes_abs)\n\n\n\n# > state level -----------------------------------------------------------\n\nresults_state_list <- nrw19 %>%\n  filter(level == \"Bundesland\") %>%\n  group_by(state) %>%\n  summarise_if(is.numeric, sum, na.rm = T) %>%\n  mutate(district_name = case_when(\n    state == 1 ~ \"Burgenland\",\n    state == 2 ~ \"Kärnten\",\n    state == 3 ~ \"Niederösterreich\",\n    state == 4 ~ \"Oberösterreich\",\n    state == 5 ~ \"Salzburg\",\n    state == 6 ~ \"Steiermark\",\n    state == 7 ~ \"Tirol\",\n    state == 8 ~ \"Vorarlberg\",\n    state == 9 ~ \"Wien\",\n    TRUE ~ NA_character_\n  )) %>%\n  mutate(district = state)\n\nresults_state_list_long <- results_state_list %>%\n  pivot_longer(cols = ovp:slp, names_to = \"party\", values_to = \"votes_abs\") %>%\n  mutate(district_type = \"Landeswahlkreis\") %>%\n  select(district_type, district_name, district, party, votes_abs)\n\n\n\n# >> details on electoral districts/constituencies -----------------------\n\nlibrary(rvest)\n\nMoI_url <- \"https://www.bmi.gv.at/412/Nationalratswahlen/Wahlkreiseinteilung.aspx\"\n\nn_mandates_regional_districts <- MoI_url %>%\n  read_html() %>%\n  html_nodes(\"table\") %>%\n  html_table() %>%\n  map_df(., bind_rows)\n\n# from utils package; allows Umlaute when exporting\nwrite.csv2(n_mandates_regional_districts,\n  file = here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"n_mandates_regional_districts.csv\"),\n  row.names = F,\n  fileEncoding = \"latin1\"\n)\n\nn_mandates_regional_districts <- read_csv2(\n  file = here::here(\"posts\", \"2019-11-20-vorzugsstimmen\", \"n_mandates_regional_districts.csv\"),\n  locale = locale(encoding = \"latin1\")\n)\n\n\nn_mandates_landeswahlkreis <- n_mandates_regional_districts %>%\n  mutate(state = stringr::str_sub(Regionalwahlkreis, 1, 1)) %>%\n  group_by(state) %>%\n  summarise(n_mandates = sum(Mandate))\n\ninfo_constituencies <- dplyr::bind_rows(\n  n_mandates_regional_districts %>%\n    select(-Stimmbezirke) %>%\n    rename(\n      district = Regionalwahlkreis,\n      district_name = Bezeichnung,\n      n_mandates = Mandate\n    ),\n  n_mandates_landeswahlkreis %>%\n    mutate(district = case_when(\n      state == \"1\" ~ \"Burgenland\",\n      state == \"2\" ~ \"Kärnten\",\n      state == \"3\" ~ \"Niederösterreich\",\n      state == \"4\" ~ \"Oberösterreich\",\n      state == \"5\" ~ \"Salzburg\",\n      state == \"6\" ~ \"Steiermark\",\n      state == \"7\" ~ \"Tirol\",\n      state == \"8\" ~ \"Vorarlberg\",\n      state == \"9\" ~ \"Wien\",\n      TRUE ~ NA_character_\n    )) %>%\n    mutate(district_name = district)\n) %>%\n  mutate(district_name_short = str_replace(district_name, \"Burgenland\", \"Bgld\") %>%\n    str_replace(., \"Kärnten\", \"Ktn\") %>%\n    str_replace(., \"Niederösterreich\", \"NÖ\") %>%\n    str_replace(., \"Salzburg\", \"Sbg\") %>%\n    str_replace(., \"steiermark\", \"Stmk\") %>%\n    str_replace(., \"Innsbruck\", \"Ibk\") %>%\n    str_replace(., \"Vorarlberg\", \"Vbg\") %>%\n    str_replace(., \"\\\\sund\\\\s\", \" u \")) %>%\n  select(., -state) %>%\n  bind_rows(., data.frame(district = \"Gesamt\", district_name = \"Gesamt\", n_mandates = 183, district_name_short = \"Gesamt\"))\n\n# >> get 'electoral number' --------------------------------------------------\n\nelectoral_number <- left_join(results_state_list %>%\n  select(state, district_name, district, gultige),\nn_mandates_landeswahlkreis,\nby = c(\"district\" = \"state\")\n) %>%\n  mutate(electoral_number = ceiling(gultige / n_mandates)) # rounded to next higher integer\n\n\nresults_state_list_long <- left_join(results_state_list_long,\n  electoral_number %>% select(district, electoral_number),\n  by = c(\"district\" = \"district\")\n)\n\n\n# > regional level -------------------------------------------------------\n\nresults_regional_list <- nrw19 %>%\n  mutate(district_name = str_remove_all(district_name, \"Wahlkarten\") %>%\n    str_remove_all(., \"-\") %>%\n    str_trim()) %>%\n  filter(level == \"Regional-Wahlkreis\" & str_detect(gkz, \"00$\")) %>%\n  mutate(district_type = \"Regionalwahlkreis\") %>%\n  mutate(district = paste0(state, district_pol) %>% stringr::str_sub(., 1, 2)) %>%\n  mutate(state = case_when(\n    state == 1 ~ \"Burgenland\",\n    state == 2 ~ \"Kärnten\",\n    state == 3 ~ \"Niederösterreich\",\n    state == 4 ~ \"Oberösterreich\",\n    state == 5 ~ \"Salzburg\",\n    state == 6 ~ \"Steiermark\",\n    state == 7 ~ \"Tirol\",\n    state == 8 ~ \"Vorarlberg\",\n    state == 9 ~ \"Wien\",\n    TRUE ~ NA_character_\n  ))\n\nresults_regional_list_long <- results_regional_list %>%\n  select(district_type, district_name, district, ovp:slp) %>%\n  pivot_longer(cols = ovp:slp, names_to = \"party\", values_to = \"votes_abs\")\n\nresults_regional_list_long <- results_regional_list_long %>%\n  left_join(., n_mandates_regional_districts %>%\n    select(-Stimmbezirke, -Bezeichnung) %>%\n    rename(\n      district = Regionalwahlkreis,\n      n_mandates = Mandate\n    ),\n  by = c(\"district\")\n  )\n\n\n# bind results\ndf_results <- bind_rows(results_federal_list_long, results_state_list_long, results_regional_list_long) %>%\n  filter(party %in% c(\"ovp\", \"spo\", \"fpo\", \"grune\", \"neos\")) %>%\n  mutate(party = case_when(\n    party == \"ovp\" ~ \"ÖVP\",\n    party == \"spo\" ~ \"SPÖ\",\n    party == \"grune\" ~ \"GRÜNE\",\n    party == \"fpo\" ~ \"FPÖ\",\n    party == \"neos\" ~ \"NEOS\",\n    TRUE ~ as.character(party)\n  )) %>%\n  mutate(district = case_when(\n    district == 1 ~ \"Burgenland\",\n    district == 2 ~ \"Kärnten\",\n    district == 3 ~ \"Niederösterreich\",\n    district == 4 ~ \"Oberösterreich\",\n    district == 5 ~ \"Salzburg\",\n    district == 6 ~ \"Steiermark\",\n    district == 7 ~ \"Tirol\",\n    district == 8 ~ \"Vorarlberg\",\n    district == 9 ~ \"Wien\",\n    district == \"00\" ~ \"Gesamt\",\n    TRUE ~ as.character(district)\n  ))\n\n# merge results of preference votes with parties' overall results.\ndf_comb <- left_join(df %>% select(district_type, district, party3, name, name_short, name_orig,\n  preference_votes = pref_votes_abs\n),\n\ndf_results %>% rename(party_votes = votes_abs),\nby = c(\"district_type\" = \"district_type\", \"district\" = \"district\", \"party3\" = \"party\")\n)\n\n\n\n# preference votes vs votes for party -------------------------------------\n\npreference_votes_constituency <- df %>%\n  group_by(district_type, district, party3, state) %>%\n  summarise(sum_preference_votes = sum(pref_votes_abs, na.rm = T)) %>%\n  ungroup()\n\n# federal level would need disaggregation\nu <- left_join(preference_votes_constituency,\n  df_results %>% select(district_type, district, district_name, party, votes_abs),\n  by = c(\n    \"district_type\" = \"district_type\",\n    \"district\" = \"district\",\n    \"party3\" = \"party\"\n  )\n) %>%\n  mutate(p_pvv_ratio = sum_preference_votes / votes_abs) %>%  #p_pvv_ratio=party preference vote vote ratio\n  # filter(!(kreis==\"Bundeswahlkreis\" & district!=\"Gesamt\")) %>%\n  filter(district_type == \"Regionalwahlkreis\") %>%\n  filter(party3 != \"Other\")\n\nlabeller_bld <- c(\n  \"Burgenland\" = \"Bgld\",\n  \"Kärnten\" = \"Ktn\",\n  \"Niederösterreich\" = \"NÖ\",\n  \"Oberösterreich\" = \"OÖ\",\n  \"Salzburg\" = \"Sbg\",\n  \"Steiermark\" = \"Stmk\",\n  \"Tirol\" = \"Tirol\",\n  \"Vorarlberg\" = \"Vbg\",\n  \"Wien\" = \"Wien\"\n)\n\nu <- dplyr::left_join(u,\n  n_mandates_regional_districts %>%\n    rename(\n      district = Regionalwahlkreis,\n      n_mandates = Mandate\n    ) %>%\n    select(-Bezeichnung, -Stimmbezirke),\n  by = c(\"district\")\n)\n\n\n\n# not included: Parties' preference vote share (facet grid)  -----------------------------------------------------\n\nx <- u %>%\n  ggplot() +\n  geom_bar(aes(\n    x = paste0(district_name, \"(\", district, \")\"),\n    y = p_pvv_ratio,\n    fill = party3\n  ),\n  stat = \"identity\"\n  ) +\n  labs(\n    y = \"preference votes in relation to party votes\",\n    x = \"regional constituency list/Regionalwahlkreis\",\n    title = \"\"\n  ) +\n  scale_y_continuous(\n    labels = scales::percent_format(accuracy = 1),\n    expand = expansion(mult = c(0, 0.1)),\n    position = \"right\"\n  ) +\n  scale_fill_manual(values = party_colors) +\n  facet_grid(\n    rows = vars(party3), cols = vars(state),\n    scales = \"free_x\",\n    space = \"free\",\n    switch = \"y\"\n  ) +\n  hrbrthemes::theme_ipsum_rc() +\n  theme(\n    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0),\n    legend.position = \"none\",\n    strip.text = element_text(hjust = 1),\n    panel.grid.minor.y = element_blank(),\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.spacing = unit(0.05, \"cm\")\n  )\n\n# name <- \"Parties_preference_vote_share_NOT_INCLUDED_IN_BLOG\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 30\n# width <- 40\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n# \n\n# not incldued: Parties' preference vote share (boxplot) ---------------------------------------------------------------\n\n# pos <- position_jitter(width = 0.2, height = 0, seed = 1) # define seed for positioning\n# \n# u %>%\n#   group_by(party3) %>%\n#   arrange(desc(p_pvv_ratio)) %>%\n#   mutate(index = row_number()) %>%\n#   mutate(label = case_when(\n#     index < 4 ~ district_name,\n#     TRUE ~ NA_character_\n#   )) %>%\n#   ungroup() %>%\n#   ggplot() +\n#   labs(\n#     title = \"Preference votes as share of total votes casted (Parties' preference votes share)\",\n#     caption = my_caption_2,\n#     subtitle = \"Only regional constitlevel\",\n#     y = \"Preference votes in relation to total votes\"\n#   ) +\n#   geom_boxplot(aes(\n#     x = party3,\n#     y = p_pvv_ratio\n#   ),\n#   outlier.shape = NA,\n#   fill = \"transparent\"\n#   ) +\n#   geom_point(aes(\n#     x = party3,\n#     y = p_pvv_ratio\n#   ),\n#   position = pos\n#   ) +\n#   ggrepel::geom_text_repel(aes(\n#     x = party3,\n#     y = p_pvv_ratio,\n#     label = label\n#   ),\n#   position = pos\n#   ) +\n#   scale_y_continuous(\n#     labels = scales::percent_format(accuracy = 1),\n#     limits = c(0, .75),\n#     breaks = seq(0, .75, .25)\n#   ) +\n#   hrbrthemes::theme_ipsum_rc() +\n#   theme(\n#     panel.grid.major.x = element_blank(),\n#     plot.caption = element_markdown(\n#       color = \"grey30\",\n#       hjust = c(0, 1)\n#     ),\n#     axis.title.x = element_blank()\n#   )\n# \n# \n# name <- \"Parties_preference_vote_share_boxplot_NOT_INCLUDED_IN_BLOG\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 30\n# width <- 40\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n\n# INCLUDED  Parties' Preference Vote Votre (P-PVV) ratio by state  ------------------------------------------------------\n\npos <- position_jitter(width = 0.2, height = 0, seed = 1) # define seed for positioning\n\nplot_region <- u %>%\n  group_by(state) %>%\n  arrange(desc(p_pvv_ratio), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(label = case_when(\n    index < 4 ~ district_name,\n    TRUE ~ NA_character_\n  )) %>%\n  ungroup() %>%\n  group_by(state) %>%\n  mutate(median_bundesland = median(p_pvv_ratio)) %>%\n  ungroup() %>%\n  mutate(state = fct_reorder(state, median_bundesland, .desc = T)) %>%\n  ggplot() +\n  labs(\n    title = \"Parties' Preference vote - vote ratio (P-PVV) by state\",\n    caption = my_caption_2,\n    subtitle = \"Only regional constituency level (Regionalwahlliste)\",\n    y = \"# of party's preference votes as ratio of party's total votes in the constituency (P-PVV)\"\n  ) +\n  geom_boxplot(aes(\n    x = state,\n    y = p_pvv_ratio\n  ),\n  outlier.shape = NA,\n  fill = \"transparent\"\n  ) +\n  geom_point_interactive(aes(\n    x = state,\n    color = party3,\n    y = p_pvv_ratio,\n    data_id = district_name,\n    tooltip = paste(\n      party3,\n      district_name,\n      round(p_pvv_ratio * 100, 2),\n      \"%\"\n    )\n  ),\n  position = pos\n  ) +\n  scale_y_continuous(\n    labels = scales::percent_format(accuracy = 1),\n    limits = c(0, .75),\n    breaks = seq(0, .75, .25)\n  ) +\n  scale_color_manual(values = party_colors) +\n  theme_post()+\n  theme(\n    panel.grid.major.x = element_blank(),\n    legend.title = element_blank(),\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.direction = \"horizontal\",\n    # plot.title = element_text(size = 12),\n    # plot.subtitle = element_text(size = 12, color = \"grey30\"),\n    plot.title.position = \"plot\",\n    # plot.caption = element_markdown(\n    #   color = \"grey30\",\n    #   hjust = c(0, 1)\n    # ),\n    plot.caption=element_text(hjust=0),\n    # plot.margin = margin(0, unit = \"cm\"),\n    axis.title.x = element_blank()\n  )\n```\n\n```{r, include=F, eval=F}\nplot_region\n```\n\n\n```{r, include=F, eval=T}\nplot_region_interactive <- girafe(\n  code = print(plot_region),\n  width_svg = 10,\n  height_svg = 6,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:lightgray;\n                 font-family:Roboto Condensed;\")\n  ))\n```\n\n\n```{r, include=F, eval=T}\n# INCLUDED: Party's preference vote vote ratio (P-PVPV ratio) by district magnitude -----------------------------------------------------\n\npos <- position_jitter(width = 0.2, height = 0, seed = 1) # define seed for positioning\n\nconstituencies_annotation <- info_constituencies %>%\n  select(district, n_mandates, district_name_short) %>%\n  filter(str_detect(district, \"^[0-9]\")) %>%\n  group_by(n_mandates) %>%\n  summarise(gebiete = paste0(district_name_short, collapse = \", \")) %>%\n  mutate(n_mandates = as_factor(n_mandates))\n\nplot_n_mandates <- u %>%\n  mutate(n_mandates = as_factor(n_mandates) %>% fct_rev()) %>%\n  group_by(n_mandates) %>%\n  # arrange(desc(p_pvpv_ratio), .by_group = T) %>%\n  arrange(desc(p_pvv_ratio), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(label = case_when(\n    index < 4 ~ district_name,\n    TRUE ~ NA_character_\n  )) %>%\n  ungroup() %>%\n  ggplot() +\n  labs(\n    title = \"Parties' preference Votes - party votes ratio (P-PVPV) and district magnitude\",\n    caption = my_caption_2,\n    subtitle = \"Only regional constituency level (Regionalwahlliste).\",\n    y = \"# of party's preference votes as ratio of party's total votes in the constituency (P-PVPV)\",\n    x = \"District magnitude (number of available mandates in constituency)\"\n  ) +\n  geom_boxplot(aes(\n    x = n_mandates,\n    y = p_pvv_ratio\n  ),\n  outlier.shape = NA,\n  fill = \"transparent\"\n  ) +\n  geom_point_interactive(aes(\n    x = n_mandates,\n    color = party3,\n    y = p_pvv_ratio, #p_pvv_ratio\n    data_id = party3,\n    tooltip = paste0(district_name, \"\\n\", party3, \": \", round(p_pvv_ratio * 100, 2), \" %\") #chagend from p_pvpv_ratio\n  ),\n  position = pos\n  ) +\n  geom_rect(\n    ymin = .8, ymax = Inf,\n    xmin = 0, xmax = Inf,\n    fill = plot_bg_color\n  ) +\n  geom_text(\n    data = constituencies_annotation,\n    aes(\n      y = .75,\n      x = n_mandates,\n      label = str_wrap(gebiete, width = 40)\n    ),\n    hjust = 0,\n    family = \"Roboto Condensed\",\n    nudge_x = 0.5,\n    lineheight = 0.8,\n    size = 3.5\n  ) +\n  scale_y_continuous(\n    labels = scales::percent_format(accuracy = 1),\n    limits = c(0, 1),\n    # expand=expansion(mult=c(0.1,0)),\n    breaks = seq(0, .75, .25)\n  ) +\n  scale_color_manual(values = party_colors) +\n  theme_post()+\n  theme(\n    axis.text.y = element_text(\n      size = 12, \n      vjust = 0,\n      hjust = 1\n    ),\n    axis.title.y = element_text(size=12, \n                                color=\"grey50\",\n                                hjust=1,\n                                angle=90),\n    axis.title.x = element_text(hjust=0,\n                                color=\"grey50\",\n                                size=12),\n    panel.grid.major.x = element_line(),\n    panel.grid.major.y = element_blank(),\n    legend.title = element_blank(),\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.direction = \"horizontal\",\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.subtitle = element_text(size = 12, color = \"grey30\"),\n    plot.caption=element_text(hjust=0),\n    plot.margin = margin(0, unit = \"cm\"),\n    plot.title.position = \"plot\") +\n  coord_flip()\n```\n\n\n```{r, include=F, eval=T}\nplot_n_mandates_interactive <- girafe(\n  code = print(plot_n_mandates),\n  width_svg = 10,\n  height_svg = 7,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:plot_bg_color;\t\n                 font-family:Roboto Condensed;\")\n  ))\n\n\n```\n\n\n```{r, include=F}\n# INCLUDED Candidate's preference vote vote ratio (C-PVPV) by list  ------------------------------------------\n\nshare <- df %>%\n  filter(!party3 == \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district, party3) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n  ungroup() %>%\n  mutate(share_pref = pref_votes_abs / sum_preference) %>%\n  # filter(share_pref>0.05) %>%  #change later\n  left_join(., info_constituencies,\n    by = c(\"district\")\n  )\n\ndf_thresholds <- tibble::tribble(\n  ~threshold, ~district_type,\n  .07, \"Bundeswahlkreis\",\n  .10, \"Landeswahlkreis\",\n  .14, \"Regionalwahlkreis\"\n)\n\ndf_thresholds_2 <- crossing(df_thresholds, unique(share$party3)) %>%\n  rename(party3 = `unique(share$party3)`)\n\ndf_share <- share %>%\n  left_join(., df_thresholds_2,\n    by = c(\"party3\", \"district_type\")\n  ) %>%\n  mutate(share_pref = share_pref * 100) %>%\n  left_join(., electoral_number %>%\n    select(district_name, electoral_number),\n  by = c(\"district\" = \"district_name\")\n  ) %>%\n  mutate(electoral_number_indicator = case_when(\n    pref_votes_abs > electoral_number ~ \"yes\",\n    TRUE ~ as.character(\"no\")\n  )) %>% \n  mutate(district_name=case_when(district_name==\"Gesamt\" ~ \"Österreich\",\n                                 TRUE ~ as.character(district_name))) %>% \n  left_join(., df_results %>% select(district_type, -district_name, district, party, votes_abs) %>% \n              mutate(party=as_factor(party)),\n              by=c(\"district_type\"=\"district_type\",\n               #  \"district_name\"=\"district_name\",\n                 \"district\"=\"district\",\n                 \"party3\"=\"party\")) %>% \n  mutate(c_pvpv_ratio=round(pref_votes_abs/votes_abs, 4)) %>%  #c_pvpv candidates' preference vote vote ratio\n  mutate(party3=as_factor(party3)) %>% \n  ungroup() %>% \n  group_by(district) %>% \n  mutate(sorting_index=cur_group_id()) #replaced group_indices\n\n\nx <- df_share %>% \n  select(district, district_name_short, sorting_index) %>% \n  distinct()\n\n\nplot_c_pvpv_ratio <- df_share %>%\n  filter(party3 != \"Other\") %>%\n  ungroup() %>% \n  group_split(district_type) %>%\n  # group_by(district_type) %>% \n  # split() %>% \n  map(~ ggplot(.) +\n    labs(\n      title = paste(unique(.$district_type)),\n      subtitle = paste(\"Candidates securing preference votes more than\n                    <span style='color:orange'>\", unique(.$threshold) * 100, \"</span> % of their party's overall vote in their respective constituency are re-ranked.\"),\n      x = \"Candidate's preference votes in % of party votes (C-PVPV)\"\n    ) +\n    geom_point_interactive(aes(\n      y = reorder(district_name_short, sorting_index),\n      x = c_pvpv_ratio*100,\n      # shape = as_factor(electoral_number_indicator),\n      color = party3,\n      data_id = name_short,\n      tooltip = paste(name_short, round(c_pvpv_ratio*100, 2), sep = \"; \")\n    ),\n    position = position_jitter(width = 0, height = 0.2, seed = 2),\n    stat = \"identity\"\n    ) +\n    geom_vline(aes(xintercept = threshold * 100),\n      color = \"firebrick\"\n    ) +\n    scale_y_discrete(expand = expansion(add = 0.2)) +\n    scale_x_continuous(\n      trans = \"log10\",\n      limits = c(NA, 40),\n      labels = scales::label_percent(accuracy = 1, scale = 1),\n      minor_breaks = NULL,\n      breaks = c(NA, 0, 1, 10, 40)\n    ) +\n    scale_color_manual(values = party_colors) +\n    ggforce::facet_row(vars(party3),\n      space = \"free\",\n      scale = \"free_x\",\n      shrink = T\n    ) +\ntheme_post()+\n    theme(\n      axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 9),\n      axis.title.y = element_blank(),\n      panel.spacing.x = unit(0.2, \"cm\"),\n      panel.spacing.y = unit(0.2, \"cm\"),\n      strip.text.x = element_text(\n        angle = 0,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      strip.text.y = element_text(\n        angle = 180,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      strip.placement = \"outside\",\n      # plot.title = element_text(size = 11, face = \"bold.italic\", \n      #                           margin=margin(b=0, unit=\"cm\")),\n      plot.subtitle = element_markdown(size = 11, \n                                       color = \"grey30\"),\n      plot.title.position = \"plot\",\n      legend.position = \"bottom\",\n      legend.title = element_blank(),\n      legend.justification = \"right\",\n      panel.grid.major.y = element_blank(),\n      plot.margin = margin(0, unit = \"cm\")\n    ) +\n    guides(color = \"none\"))\n\nplot_c_pvpv_ratio <- (patchwork::wrap_plots(plot_c_pvpv_ratio, ncol = 1) &\n  theme(plot.margin = margin(unit = \"cm\", 0))) +\n  plot_annotation(\n    title = \"Candidates' preference votes v. party votes ratio (C-PVPV)\",\n    subtitle = \"Candidates above vertical line move up the electoral list.\",\n    caption = my_caption_2,\n    theme = theme(\n      plot.title = element_text(family = \"Roboto Condensed\", \n                                size = 20,\n                                face = \"bold\"),\n      plot.subtitle = element_text(family = \"Roboto Condensed\", \n                                   size = 12,\n                                   face = \"plain\"),\n      plot.caption=element_text(hjust=0,\n                                color=\"grey30\"),\n      plot.background = element_rect(fill=plot_bg_color)))+\n      plot_layout(heights = c(1, 9, 39))\n```\n\n\n\n```{r, include=F}\n# > save ------------------------------------------------------------------\n\n\n# name <- \"C_PVPV_by_list\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 30\n# width <- 30\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n\nplot_c_pvpv_ratio_interactive <- girafe(\n  code = print(plot_c_pvpv_ratio),\n  width_svg = 10,\n  height_svg = 15,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:plot_bg_color;\t\n                 font-family:Roboto Condensed;\")\n  )\n)\n\n\n\n```\n\n\n\n\n```{r, include=F}\n# x <- girafe_options(\n#   x = my_plot,\n#   sizingPolicy(\n#     padding = \"0px\"\n#   )\n# )\n# \n# saveWidget(x,\n#   file = \"C_PVPV_by_list.html\",\n#   background = \"white\"\n# )\n#\n```\n\n\n```{r, include=F}\n# INCLUDED. Candidates crossing preference vote threshold -------------------------------------------\n\n\ndf_n_candidates_crossing_threshold <- df_share %>%\n  mutate(leader=case_when(rank_list==1 ~ \"list leader\",\n                          TRUE ~ as.character(\"not list leader\"))) %>% \n  mutate(threshold_share = case_when(\n    c_pvpv_ratio * 100> threshold * 100 ~ \"yes\",\n    TRUE ~ as.character(\"no\")\n  )) %>%\n  filter(threshold_share == \"yes\")\n # select(district_type, district_name_short, party3, c_pvpv_ratio, threshold) %>%\n  # group_by(district_type, party3, threshold_share) %>%\n  # summarise(n = n()) %>%\n\n\nplot_n_candidates_crossing_threshold <- df_n_candidates_crossing_threshold %>% \n  ggplot() +\n  labs(\n    title = \"Number of candidates crossing preference vote threshold\",\n    caption = my_caption_2\n  ) +\n  geom_bar(aes(\n    x = party3,\n    fill = leader,\n    group=leader,\n    ),\n  stat = \"count\",\n  position=position_stack(vjust=0.5)\n  ) +\n  geom_text(aes(x=party3,\n                group=leader,\n                label=..count..),\n            color=\"white\",\n            stat=\"count\",\n            position = position_stack(vjust=0.5))+\n  geom_text(aes(x=party3,\n                group=party3,\n                label=..count..),\n            color=\"black\",\n            stat=\"count\",\n            nudge_y = 0.5,\n            #position = position_stack(vjust=1)\n            )+\n  scale_y_continuous(breaks=seq(0, 20, 2))+\n  scale_fill_paletteer_d(\"ggsci::default_jama\")+\n  facet_wrap(vars(district_type)) +\n  theme_post()+\n  theme(\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.direction = \"horizontal\",\n    legend.title = element_blank(),\n    axis.title.y = element_blank(),\n    axis.title.x = element_blank(),\n    panel.grid.major.x = element_blank(),\n    plot.margin = margin(0, unit = \"cm\"),\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.caption = element_text(hjust = c(0))\n  )\n\n\n# name <- \"n_candidates_crossing_threshold\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# width <- 26.49\n# height <- 11.17\n# ggsave(\n#   plot = plot_n_candidates_crossing_threshold,\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   dpi = 96,\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n\n# INCLUDED Candidates crossing electoral number with preference votes (geofacet) -----------------------------------\nlibrary(geofacet)\n\naut_grid <- data.frame(\n  row = c(1, 1, 1, 2, 2, 2, 2, 2, 3),\n  col = c(3, 4, 5, 1, 2, 3, 4, 5, 4),\n  code = c(\"Oberösterreich\", \"Niederösterreich\", \"Wien\", \"Vorarlberg\", \"Tirol\", \"Salzburg\", \"Steiermark\", \"Burgenland\", \"Kärnten\"),\n  name = c(\"Oberösterreich\", \"Niederösterreich\", \"Wien\", \"Vorarlberg\", \"Tirol\", \"Salzburg\", \"Steiermark\", \"Burgenland\", \"Kärnten\")\n)\n\nstate_electoral_number <- df %>%\n  filter(party3 != \"Other\") %>%\n  filter(district_type == \"Landeswahlkreis\") %>%\n  left_join(.,\n    electoral_number %>% select(district_name, electoral_number),\n    by = c(\"district\" = \"district_name\")\n  ) %>%\n  select(district_type, district, name_short, party3, electoral_number, pref_votes_abs)\n\nstate_electoral_number_plot <- state_electoral_number %>%\n  ggplot() +\n  labs(\n    title = \"Candidates' preference votes and electoral number\",\n    caption = my_caption_2,\n    y = \"Preference votes\"\n  ) +\n  geom_point_interactive(aes(\n    x = party3,\n    color = party3,\n    y = pref_votes_abs,\n    tooltip = paste(\n      party3, \"\\n\",\n      name_short, pref_votes_abs\n    )\n  ),\n  position = position_jitter(width = 0.2, height = NULL, seed = 2)\n  ) +\n  geom_hline(aes(yintercept = electoral_number),\n    color = \"firebrick\"\n  ) +\n  geom_text(aes(\n    x = Inf, y = electoral_number,\n    label = scales::comma(electoral_number)\n  ),\n  color = \"firebrick\",\n  nudge_y = -3000,\n  family = \"Roboto Condensed\",\n  hjust = 1,\n  check_overlap = T\n  ) +\n  scale_color_manual(values = party_colors) +\n  scale_x_discrete(expand = expansion(mult = 0)) +\n  scale_y_continuous(\n    labels = scales::label_comma(),\n    expand = expansion(mult = 0),\n    limits = c(0, 35000),\n    minor_breaks = NULL\n  ) +\n  theme_post()+\n  theme(\n    axis.title.x = element_blank(),\n    axis.text.x = element_text(size = 9),\n    panel.grid.major.x = element_blank(),\n    strip.text.y = element_text(angle = 0, vjust = 1),\n    strip.text.x = element_text(size=14),\n    legend.position = \"none\",\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    # plot.title.position = \"plot\",\n    plot.caption = element_text(hjust=0),\n    plot.margin = margin(0, r = 0.2, unit = \"cm\"),\n    strip.background.x = element_rect(fill = plot_bg_color, color=NA),\n    panel.border = element_rect(color = plot_bg_color, fill = \"transparent\")\n  ) +\n  facet_geo(~district, grid = aut_grid) +\n  guides(color = \"none\")\n\n\n# > save ------------------------------------------------------------------\n\nstate_electoral_number_plot_interactive <- girafe(\n  code = print(state_electoral_number_plot),\n  width_svg = 10,\n  height_svg = 6,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:plot_bg_color;\t\n                 font-family:Roboto Condensed;\")\n  )\n)\n```\n\n\n```{r, include=F}\n# x <- girafe_options(\n#   x = my_plot,\n#   sizingPolicy(padding = \"0px\")\n# )\n# \n# saveWidget(x,\n#   file = \"state_electoral_number_plot.html\",\n#   background = \"white\"\n# )\n```\n\n\n```{r, include=F}\n# INCLUDED Concentration of preference votes (gini) ------------------------------------------------------------------\n\nlibrary(reldist)\n\n\n# > plot --------------------------------------------------------------------\n\nplot_gini <- df %>%\n  filter(party3 != \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  left_join(., info_constituencies, by = c(\"district\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district_name_short, party3) %>%\n  summarise(gini_pref = gini(pref_votes_abs)) %>%\n  ggplot() +\n  labs(\n    title = \"Concentration of preference votes\",\n    caption = my_caption_2,\n    y = \"Gini coefficient\"\n  ) +\n  geom_point_interactive(aes(\n    x = party3,\n    y = gini_pref,\n    color = party3,\n    tooltip = paste(\n      district_name_short, \"\\n\",\n      party3, round(gini_pref, 2)\n    )\n  ),\n  pos = position_jitter(width = 0.2, height = NULL, seed = 2)\n  ) +\n  geom_boxplot(aes(\n    x = party3,\n    y = gini_pref\n  ),\n  size=0.5,\n  color=\"grey30\",\n  fill = \"transparent\",\n  outlier.shape = NA\n  ) +\n  scale_color_manual(values = party_colors) +\n  scale_x_discrete(expand = expansion(mult = 0)) +\n  scale_y_continuous(\n    labels = scales::label_comma(),\n    limits = c(0, 1),\n    expand = expansion(mult = 0),\n    minor_breaks = NULL\n  ) +\n  facet_wrap(vars(district_type)) +\n  theme_post()+\n  theme(\n    axis.title.x = element_blank(),\n    panel.grid.major.x = element_blank(),\n    strip.text.y = element_text(angle = 0, \n                                vjust = 1),\n    strip.text.x = element_text(size=12),\n    legend.position = \"none\",\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.caption = element_text(hjust=0)#,\n    # plot.margin = margin(0, unit = \"cm\")\n  ) +\n  guides(color = \"none\")\n```\n\n```{r, include=F}\n# > save --------------------------------------------------------------------\n\nplot_gini_interactive <- girafe(\n  code = print(plot_gini),\n  width_svg = 10,\n  height_svg = 6,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = glue::glue(\"background-color:{plot_bg_color}; font-family:Roboto Condensed\")))\n)\n\n\n```\n\n\n\n```{r, include=F}\n# INCLUDED Competitiveness  ----------------------------------------------------------\n\n\n# > NOT INCLUDED: Difference as share of total preference votes -------------------------\n\n# df %>%\n#   filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n#   # filter(district==\"Gesamt\") %>%\n#   filter(!is.na(pref_votes_abs)) %>%\n#   group_by(district_type, state, district, party3) %>%\n#   arrange(desc(pref_votes_abs), .by_group = T) %>%\n#   mutate(index = row_number()) %>%\n#   mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n#   filter(index < 3) %>%\n#   mutate(pref_diff = pref_votes_abs - lead(pref_votes_abs)) %>%\n#   mutate(diff_perc = pref_diff / sum_preference) %>%\n#   filter(!is.na(diff_perc)) %>%\n#   mutate(indicator = paste0(district, \"-\", name_short)) %>%\n#   mutate(indicator = district) %>%\n#   ggplot() +\n#   labs(\n#     title = \"Lead\",\n#     subtitle = \"Lead in % of party's total number of preference votes\"\n#   ) +\n#   geom_bar(aes(\n#     y = indicator,\n#     x = diff_perc\n#   ),\n#   stat = \"identity\"\n#   ) +\n#   lemon::facet_rep_grid(\n#     cols = vars(party3),\n#     rows = vars(district_type),\n#     # repeat.tick.labels = T,\n#     scales = \"free\",\n#     drop = T,\n#     space = \"free\"\n#   ) +\n#   hrbrthemes::theme_ipsum_rc() +\n#   theme(axis.text.x = element_text(angle = 90))\n```\n\n\n```{r, include=F}\n# > INCLUDED: Difference % leader vs runers-up ---------------------------------------------------\n\n\nd <- df %>%\n  left_join(., info_constituencies, by = c(\"district\")) %>%\n  filter(!party3 == \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district, party3) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n  filter(index < 3) %>%\n  mutate(share_pref = pref_votes_abs / sum_preference) %>%\n  mutate(indicator = district) # %>%\n\nd <- d %>%\n  ggplot() +\n  labs(\n    title = \"Lead\",\n    subtitle = \"Lead in % of party's total number of preference votes\",\n    x = \"Share of intra-party preference votes; leader and runners-up.\"\n  ) +\n  # geom_point(aes(\n  #   y = district_name_short,\n  #   x = share_pref,\n  #   shape = as_factor(index),\n  #   color=party3\n  # ),\n  # stat = \"identity\"\n  # ) +\n  geom_point_interactive(aes(\n    y = district_name_short,\n    x = share_pref,\n    shape = as_factor(index),\n    color = party3,\n    data_id = name_short,\n    tooltip = name_short,\n  ),\n  stat = \"identity\"\n  ) +\n  scale_x_continuous(\n    limits = c(0, 1),\n    labels = scales::percent_format(accuracy = 1),\n    minor_breaks = NULL,\n    breaks = seq(0, 1, .5)\n  ) +\n  scale_shape_manual(\n    labels = c(\"1\" = \"leader\", \"2\" = \"runners-up\"),\n    values = c(1, 2)\n  ) +\n  scale_color_manual(values = party_colors) +\n  lemon::facet_rep_grid(\n    cols = vars(party3),\n    rows = vars(district_type),\n    repeat.tick.labels = F,\n    scales = \"free\",\n    space = \"free\",\n    drop = T\n  ) +\n  hrbrthemes::theme_ipsum_rc() +\n  theme(\n    axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),\n    axis.title.y = element_blank(),\n    panel.spacing.x = unit(0.1, \"cm\"),\n    panel.spacing.y = unit(0.2, \"cm\"),\n    strip.text.y = element_text(angle = 0, vjust = 1),\n    legend.position = \"bottom\",\n    legend.title = element_blank(),\n    legend.justification = \"right\"\n  ) +\n  guides(color = \"none\")\n\n\n# >> save ------------------------------------------------------------------\n\nd_interactive <- girafe(\n  code = print(d),\n  width_svg = 8,\n  height_svg = 12,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T)\n  )\n)\n\n\n# x <- girafe_options(\n#   x = my_plot,\n#   sizingPolicy(\n#     padding = \"0px\"\n#   )\n# )\n# \n# saveWidget(x,\n#   file = \"pi_Difference_leading_runnersup_prefernece_votes.html\",\n#   background = \"gray\"\n# )\n# \n# \n# name <- \"Difference_leading_runnersup_prefernece_votes\"\n# format <- \".png\"\n# time <- Sys.Date()\n# folder <- paste0(wdr, \"/graphs/\")\n# height <- 30\n# width <- 30\n# ggsave(\n#   filename = paste0(folder, time, name, format),\n#   device = \"png\",\n#   type = \"cairo\",\n#   height = height,\n#   width = width,\n#   scale = 1,\n#   unit = c(\"cm\")\n# )\n```\n\n\n```{r, include=F}\n# INCLUDED difference leader - runnersup vs n mandates -----------------------------\n\nd1 <- df %>%\n  left_join(., info_constituencies, by = c(\"district\")) %>%\n  filter(!party3 == \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district, party3) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n  filter(index < 3) %>%\n  mutate(share_pref = pref_votes_abs / sum_preference) %>%\n  mutate(indicator = district) %>%\n  select(\n    district_type, state, district, party3, name_short, district_name, n_mandates, district_name_short,\n    indicator, share_pref, index\n  ) %>%\n  group_by(district_type, state, district, party3, district_name, district_name_short, indicator) %>%\n  mutate(\n    runners_up = lead(name_short),\n    runners_up_share = lead(share_pref)\n  ) %>%\n  rename(\n    leader = name_short,\n    leader_share = share_pref\n  ) %>%\n  filter(index == 1) %>%\n  mutate(share_diff = leader_share - runners_up_share) %>%\n  ungroup() %>%\n  mutate(n_mandates = fct_reorder(as_factor(n_mandates), as.numeric(n_mandates)))\n\nplot_difference <- d1 %>%\n  ggplot() +\n  labs(\n    title = \"Difference between top-2 candidates' preference vote share by constituency list\",\n    y = \"Differnce between top-2 candidates' preference vote share\",\n    caption = my_caption_2\n  ) +\n  geom_point_interactive(aes(\n    x = party3,\n    y = share_diff,\n    color = party3,\n    tooltip = paste(\n      district_name_short, \"\\n\",\n      leader, round(leader_share * 100, 2), \"%\", \"\\n\",\n      runners_up, round(runners_up_share * 100, 2), \"%\", \"\\n\"\n    )\n  ),\n  pos = position_jitter(width = 0.2, height = NULL, seed = 2)\n  ) +\n  geom_boxplot(aes(\n    x = party3,\n    y = share_diff\n  ),\n  fill = \"transparent\",\n  outlier.shape = NA\n  ) +\n  scale_y_continuous(\n    limits = c(0, 1),\n    labels = scales::label_percent()\n  ) +\n  scale_color_manual(values = party_colors) +\n  facet_wrap(vars(district_type)) +\n  theme_post()+\n  theme(\n    # plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.title.position = \"plot\",\n    legend.position = \"none\",\n    plot.caption = element_text(hjust = c(0)),\n    axis.title.x = element_blank(),\n    plot.margin = margin(0, unit = \"cm\"),\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.y = element_blank()\n  )\n\n\n\n# >> save ------------------------------------------------------------------\n\nplot_difference_interactive <- girafe(\n  code = print(plot_difference),\n  width_svg = 10,\n  height_svg = 6,\n  options = list(\n    opts_toolbar(saveaspng = FALSE),\n    opts_sizing(rescale = T),\n    opts_tooltip(css = \"background-color:plot_bg_color;\tfont-family:Roboto Condensed;\")\n  )\n)\n\n\n```\n\n\n# Context\n\nOn 29 September, Austria held its general elections to the national assembly (*Nationalrat*). By now a flurry of analyses and comments has been published and the caravan of political commentary has largely moved on, at least when it comes to the analysis of the results itself (the [government formation](https://www.nytimes.com/reuters/2019/11/10/world/europe/10reuters-austria-politics.html){target=\"_blank\"} train  is finally also getting up to speed). One aspect, I personally have never looked into, and which seems to fall a bit under the radar, is the use of preference votes by Austria's electorate.  This post is essentially my first 'exploratory' go at preference votes. No specific question, no specific theoretical framework in mind, just poking. I'll first present the results, then detail some of the steps implemented in R to obtain, analyze and visualize the relevant data. The entire code for the analysis is available on my github [account](https://github.com/zoowalk/NRW19_preference_votes/){target=\"_blank\"}. As always, if you spot any glaring error etc, don't hesitate and let me know.\n\nPreference vote (*Vorzugsstimme*) refer to voters' option (but not obligation) to indicate their support/preference for specific candidates running for the party of their choice. Since Austrian candidates run on a nation wide federal district list (*Bundeswahlkreis*), one of nine state district lists (*Landeswahlkreis*), or/and one of 39 regional district lists (*Regionalwahlkreis*), voters can cast up to three preference votes [(here](https://www.help.gv.at/Portal.Node/hlpd/public/resources/documents/NRW2017_Vorzugsstimmen.jpg){target=\"_blank\"} a sample ballot slip). Eventually, a candidate's number of preference votes can be consequential when it comes to distributing the seats which a party won to the individual candidates. Without preference votes, seats are distributed in accordance to candidates' position on the electoral list. The lower a candidate is on a list, the lower the likelihood that she can actually get a seat. However, with a sufficient large number of preference votes, the pre-election order on the electoral list can change and initially lower ranked candidates can move up and eventually gain a seat. For details see [here](https://www.oesterreich.gv.at/themen/leben_in_oesterreich/wahlen/1/Seite.320260.html){target=\"_blank\"}.\n\n# Results\n\n## by district list\n\nOverall, there were 1,8 million preference votes cast. The largest part (more than 60 %) were cast for candidates running on regional district lists. Probably this could be read as voters been particularly keen to support 'their' local/regional candidates to make it into the new parliament. Ties between voters and regional candidates are likely to be different than those between voters and candidates running on the more 'removed' federal or state constituency list.\n\n\n\n```{r echo=FALSE, fig.height=3, fig.width=10, message=FALSE, warning=FALSE, code_folding=NULL}\npl_by_district\n```\n\n\n## by constituency list and party\n\nIf we further disaggregate these numbers and differentiate between parties, we see that preference votes obtained on the regional level accounted for the majority of preference votes for all parties. However, there is a noticeable difference between the comparable low 55.9 % of the Freedom Party (FPÖ) and e.g. the 65.7 % of the Social Democrats (SPÖ) or the 64.1 % of the NEOS. Or put differently, with 34.1 % the share of preference votes obtained on the federal level, the Freedom Party stands out. As for the underlying reasons, I can only speculate. One reading could be that voters of the FPÖ have weaker ties to their candidates on the regional or state level and hence felt less inclined to cast a preference vote for them. Another one could be that the relation among FPÖ's candidates on the federal list were particularly competitive and hence a disproportionate high number of voters were mobilized to cast their preference votes on the federal list. Considering the exit of former party leader HC Strache ([Ibiza](https://www.theguardian.com/world/2019/may/20/austria-ibiza-scandal-sting-operation-what-happened-why-does-it-matter){target=\"_blank\"}...) and the subsequent (not yet consolidated?) change in the leadership, this seems plausible (see below). It however does not explain why FPÖ voters did not cast preference votes for candidates on state or regional lists.\n\n```{r echo=FALSE, message=FALSE, warning=FALSE, code_folding=NULL, background=plot_bg_color}\npl_constituency_list_party\n```\n\n\n\n## Top 5 candidates\nIf we are interested in candidates, which candidates were particularly successful in securing preference votes?\n\n\n```{r echo=FALSE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE, code_folding=NULL}\npl_top_5_candidates\n\n```\n\nThe graph above clearly demonstrates the predominate role of former chancellor Sebastian Kurz when it comes to preference votes. With more than 150,000 votes his result clearly outclasses those of any other candidate. With the notable exception of the FPÖ, the leading candidates/party leaders of all parties succeeded in securing most of the preference votes. In the case of the FPÖ, former Minister of Interior Herbert Kickl overtook his party's leader, Norbert Hofer. What is also noticeable is that party leaders almost exclusively secured their preference votes from the federal constituency list, while their colleagues largely relied on votes from the regional constituency list.^[Reportedly, Hofer's 'defeat' to Kickl might be due to an administrative issue though. There was another FPÖ candidate with the family name Hofer running on the federal constituency list. When voters put only the candidate's family name on the ballot to indicate their preference, it was not clear which Hofer was actually meant. As a consequence, these preference votes were reportedly ruled as invalid.] \n\nLooking at the rankings within parties, I have to admit that I was a bit surprised by the strong performance of a some candidates which I at least had never heard of. The result of T. Mete for the SPÖ, and J Hechenberger for the ÖVP were particularly surprising to me.\n\n## Regional dimension\n\n### by district magnitude\n\nThe plot below displays a party's total number of preference votes as percentage of a party's total vote in each regional electoral constituency.  Let's call this for the sake of easier reference **parties' preference votes - party votes ratio**. Or to predend a serious color, **P-PVPV** ratio.^[I assume that the literature on preference votes has already coined a term for this indicator, but for the limited analysis here I leave it with this.] This PVPV ratio are grouped by constituencies' magnitude (number of mandates). The motivation behind is the assumption that the fewer mandates are available the higher will be also intra-party competition. With a smaller cake to distribute (fewer mandates), candidates will try particularly hard to win preference votes and move up the electoral list. Here the analysis is limited to the 39 regional electoral lists. To avoid the indivudal dots overlapping, some random vertical variation was introduced.\n\nThe plot seems to provide at least some backing to this proposition. The constituency with only 1 mandate to compete for (Osttirol) features the highest median of parties' PVPV ratio. While the picture is not entirely clear cut, there seems to be indeed a decreasing median share as constituencies' magnitude increases from to two to seven mandates. The constituencies with eight and nine mandates (Graz-Umgebung, Hausruckviertel, OberStmk), however, do deviate. \nHover over the individual dots to get details.^[There seems to be an issue with the hoover over effect on mobile devices. If anyone knows how to iron this out, please let me know.]\n\n```{r, echo=F, code_folding=NULL}\nplot_n_mandates_interactive\n```\n\n### by state\n\nIf we are interested in whether there are any regional differences when it comes to parties' PVPV ratios, grouping them by states can be of some help. As the boxplots below show, on average parties' PVPV ratio was the largest in Burgenland followed by Vorarlberg. These two states are Austria's two smallest in terms of population. On the other end, Upper Autria (Oberösterreich), Lower Austria (Niedrösterreich), Styria (Steiermark), and Vienna featured on average clearly lower PVPV ratios. These states are Austria's  largest. This difference would be in line with the proposition that candidates in smaller states are better in mobilizing personal support, i.e. preference votes. Closer candidate-voter relations due to smaller population size sounds rather probable to me. But this would certainly need further analysis to corroborate the claim.\n\n```{r, code_folding=NULL, echo=F}\nplot_region_interactive\n```\n\n\n## Intra-party dynamics\nAs already outlined above, preference votes are first and foremost interesting from an intra-party perspective. With sufficient votes, candidates which embarked on the electoral campaign from a lower ranked position can move up the intra-party ladder and secure a seat. \n\nSo when do candidate's move up the ballot list?^[See [here](https://www.oesterreich.gv.at/themen/leben_in_oesterreich/wahlen/1/Seite.320260.html){target=\"_blank\"} for details] \n\n+ On the federal level: when a candidate got a preference votes of at least 7 % of those who voted for her party.\n+ On the state level: when a candidate got preference votes of of at least 10 % of those who voted for her party, *or* at least as many preference votes as the 'electoral number' (*Wahlzahl*)^[By dividing the number of valid votes in a state level constituency by the number of the constituency's available mandates one gets the 'electoral number'].\n+ On the regional level: when a candidate got preference votes by at least 14 % of those who voted for her party. \n\nDid this happen often?\n\n### Candidates' preference vote party vote ratio\nThe graph below presents **candidates' preference votes - party votes ratio**, or, to stay ~~serious~~ clumsy, **C-PVPV**. This ratio is candidates' number of preference votes expressed as % of the total number of votes of her party (in the respective constituency/list). The vertical red lines indicate the stipulated thresholds which candidates have to pass in order to move up on the party's electoral list. Hover over the individual points to get the data pertaining to each candidate. Note that the x-axis is log-transformed to ensure candidates with low C-PVPV ratios remain (somewhat) visible. Note also that only those candidates are included which actually obtained at least one preference vote. \n\n```{r, echo=F, code_folding=NULL}\nplot_c_pvpv_ratio_interactive\n```\n\nWhile the graph provides plenty of details, a few general things standout. First, on the federal level, only two candidates crossed the threshold. Former chancellor Kurz (ÖVP) and former Minister of Interior Kickl (FPÖ). Second, on the state level, not a single candidate secured sufficient preference votes. However, there are several candidates running on regional lists who were able to cross the pertaining threshold. Note that there is no district in which more than one candidate from one party crossed the threshold. \n\n### Candidates' preference votes and electoral number\nAside from candidates' preference-vote party-vote ratio, candidates have one further avenue to be promoted. See point two of the conditions listed above. On the state constituency level, candidates can move up the ladder not only if they crossed the 10 % threshold, but also if they would have reached more preference votes than the electoral number. The graph below presents the pertaining figures. In short, none of the candidates succeeded in doing so in these elections. In fact, candidates are pretty far from this threshold.\n\n```{r}\n#| column: body-outset-left\n#| fig-width: 12\nstate_electoral_number_plot_interactive\n```\n\nWith the above, we know by now who was able to muster sufficient preference votes to cross the relevant thresholds. However, when aggregating, it makes sense to differentiate between list leaders and those of lower ranks. \n\n```{r, code_folding=NULL, echo=F}\nplot_n_candidates_crossing_threshold\n```\n\nThe graph below provides the number of candidates per party who were able to cross the required preference vote threshold. On the regional list level, ÖVP, SPÖ, and FPÖ had the same number of candidates, followed by the Greens and Neos. What the graph also reveals is that in the predominant part of cases, the successful candidates were in fact parties' federal/regional list leaders. In total, only seven candidates which were not list leaders succeeded in securing the necessary preference votes. Probably noteworthy, 4 of these 7 cases originate from the FPÖ. Does this mean anything? I am tempted to suspect that parties with clear hiearchial structures are less likely to see lower rank candidates overtake their party's list leaders. In cases, though, in which e.g. the leadership question is not entirely settled, or leaders are confronted with very strong 'colleagues' (Feind, Todfeind... Parteifreund), successful preference vote campaigns are more likely to occur. At least that's an interpretation which came to my mind when seeing the numbers pertaining to the FPÖ (did I hear 'selecting on the dependent variable'?). On the other hand, this proposition is immediately relativized when checking who these candidates were. With Kunasek (former Minister of Defense, leader of Styria's FPÖ) and Haimbuchner (leader of Upper Austria's FPÖ), we have two FPÖ representatives from the party's upper echelons, who put their names on the ballot list, but - as far as I am aware - see their future as for now (again) in their home states rather than in the national parlament. I am only speculating here, but I found it at least noteworthy that the FPÖ somewhat deviates.\n\n### Difference Leader and Runners-up\n\nAnother angle to look at preference votes could be to examine the difference between the two candidates leading in terms of the number of preference votes. This gives us some idea on how dominant a candidate has been, i.e. whether the intra-party contestation at the top was particularly high. The graph above seeks to display the difference in candidates' **preference vote share** per party and electoral district. Preference vote share is a candidate's share of her party's total preference votes in the respective list/constituency. Here, the higher the difference between those, the lower the contestation for the top spot. Hover over the dots to see the two top candidate and their respective share of preference votes. Not the small gap between SPÖ's leader Rendi-Wagner and Mete.\n\n\n```{r, code_folding=NULL, echo=F}\nplot_difference_interactive\n```\n\n### Concentration of preference votes\n\nLast but not least, to round off the picture, let's see how different parties are when it comes to the concentration of preference votes. Are a party's preference votes going almost exclusively to one or only a few candidates (high concentration)? Or, are preference votes relatively evenly shared among different candidates (low concentration)? A measure of concentration (Gini coefficient) can provide us with another angle on intra-party dynamics. Below the results:  \n\n\n```{r, code_folding=NULL, echo=F}\nplot_gini_interactive\n```\n\n# Steps in R\nBelow some of the most important steps in R to obtain the results above. The full code is published on my github account [here](https://github.com/werkstattcodes/NRW19_preference_votes){target=\"_blank\"}\n\n## Obtaining the preference vote results\nThe first potential hurdle is to virtually 'liberate' the results pertaining to the preference vote. Just have a look a the format of the data [here](https://www.bmi.gv.at/412/Nationalratswahlen/Nationalratswahl_2019/files/NRW19_Vorzugsstimmen_Landes_Regionalparteiliste_16102019.pdf){target=\"_blank\"} and [here](https://www.bmi.gv.at/412/Nationalratswahlen/Nationalratswahl_2019/files/NRW19_Vorzugsstimmen_bundesweit_16102019.pdf){target=\"_blank\"}. Particularly the results for the state and regional electoral district lists are not what a follower of '[tidy data](https://vita.had.co.nz/papers/tidy-data.pdf){target=\"_blank\"}' would hope for. So let's start wrangling:\n\n\n```{r, ref.label=\"extract_data\", eval=F, code_folding=\"Code: Extract data\", include=T}\n```\n\nEt voila (here only the first entries). If needed, you can downlaod the cleaned file [here](https://github.com/werkstattcodes/NRW19_preference_votes/master/data/AUT_NRW19_preference_votes.csv){target=\"_blank\"} github repo.\n\n```{r echo=FALSE, message=FALSE, warning=TRUE, eval=F}\n#table.start\ndf_merge %>% \n  reactable(.,\n          filterable = T,\n          pagination = T,\n          height = 250,\n          outlined = T,\n          bordered = F,\n          compact=T,\n          theme=reactableTheme(backgroundColor = plot_bg_color,\n                           style=list(fontFamily=\"Karla\",\n                                      fontSize=\"12px\"),\n                           filterInputStyle = list(\n                             color=\"black\",\n                             backgroundColor = plot_bg_color)))\n#table.end\n```\n\n\nIf needed, you can download the cleaned file [here](https://github.com/zoowalk/NRW19_preference_votes/master/data/AUT_NRW19_preference_votes.csv){target=\"_blank\"} from the github repo.\n\n## Abbreviating names, removing titles\nAn issue which has as been a frequent source of annoyance is the verbose use of academic and other (obviously even more important) titles in names. It only unnecessarily takes space from graphs and has something, in my personal view, deeply inegalitarian to it (the very purpose of using titles is probably to signal inegalitrianism). So, let's remove all titles and only use the first letter of the first name. [`Regex`](https://stringr.tidyverse.org/articles/regular-expressions.html){target=\"_blank\"} and [`stringr`](https://stringr.tidyverse.org/index.html){target=\"_blank\"} are your friends here. Since this is a task which comes up time and again, it actually screams for a r package...\n\n```{r, eval=F}\nfn_remove_titles <- function(x) {\n  titles <- c(\n    \"Mag\", \"MMag\", \"Prof\", \"Dr\", \"O\\\\.Univ\\\\.Prof\", \"Dipl-Ing\", \"Dipl.-Ing.\", \"Dipl.-Rev.\", \"Ing\",\n    \"Dipl\", \"jun\", \"sen\", \"Ba\", \"\\\\(FH\\\\)\", \"MSc\",\n    \"med\", \"univ\", \"Bsc\", \"phil\", \"iur\", \"DDr\", \"BEd\", \"DI\", \"Mba\", \"Mas\", \"MA\", \"MIM\",\n    \"vet\", \"M.A.\", \"PMM\", \"MTD\", \"Päd\", \"Bakk\"\n  ) %>%\n    map(., paste0, c(\"\\\\.\", \"\\\\s\", \"\\\\,\")) %>%\n    unlist()\n\n\n  name_wo_titles <- stringr::str_remove_all(x, regex(\"[[:alpha:]\\\\-]+\\\\.\")) %>%\n    str_remove_all(., regex(\"\\\\([:alpha:]+\\\\)\")) %>%\n    str_remove_all(., regex(paste0(titles, collapse = \"|\"), ignore_case = T)) %>%\n    str_squish()\n}\n\n\nfn_short_name <- function(x) {\n  family_name <- stringr::str_extract(x, \"^[[:alpha:]\\\\-|\\\\s]+(?=,)\") %>%\n    str_to_title() %>%\n    str_squish() %>%\n    str_trim()\n\n  first_name <- str_extract(x, regex(\"(?<=\\\\,)[[:alpha:]\\\\-\\\\s]*$\")) %>%\n    str_trim() %>%\n    str_squish() %>%\n    str_to_title()\n\n  initals <- str_split(first_name, \"\\\\s\") %>%\n    map(., str_sub, start = 1L, end = 1L) %>%\n    map_chr(., str_c, collapse = \".\") %>%\n    paste0(., \".\")\n\n  name_short <- paste(family_name, initals, sep = \", \")\n}\n\n\ndf <- df_merge %>%\n  mutate(district = str_remove(district, \"Landesparteiliste\") %>%\n    str_remove(., \"Regionalparteiliste\") %>%\n    str_trim(., side = c(\"both\"))) %>%\n  mutate(district = case_when(\n    district == \"B\" ~ \"Burgenland\",\n    district == \"S\" ~ \"Salzburg\",\n    district == \"K\" ~ \"Kärnten\",\n    district == \"NÖ\" ~ \"Niederösterreich\",\n    district == \"OÖ\" ~ \"Oberösterreich\",\n    district == \"Stmk\" ~ \"Steiermark\",\n    district == \"Vlbg\" ~ \"Vorarlberg\",\n    TRUE ~ district\n  )) %>%\n  mutate(district = as_factor(district)) %>%\n  mutate(party2 = str_extract(party, regex(\"\\\\([:alpha:]*\\\\)\")) %>% # take parties' short abbrevs.\n    str_remove_all(., \"\\\\(|\\\\)\")) %>%\n  mutate(name_orig = name) %>%\n  mutate(name = map_chr(name_orig, fn_remove_titles)) %>%\n  mutate(name_short = map_chr(name, fn_short_name)) %>%\n  mutate(state = case_when(\n    str_detect(district, \"^[0-9].*\") ~ str_sub(district, start = 1L, end = 1L),\n    TRUE ~ as.character(district)\n  )) %>%\n  mutate(state = case_when(\n    state == 1 ~ \"Burgenland\",\n    state == 2 ~ \"Kärnten\",\n    state == 3 ~ \"Niederösterreich\",\n    state == 4 ~ \"Oberösterreich\",\n    state == 5 ~ \"Salzburg\",\n    state == 6 ~ \"Steiermark\",\n    state == 7 ~ \"Tirol\",\n    state == 8 ~ \"Vorarlberg\",\n    state == 9 ~ \"Wien\",\n    TRUE ~ NA_character_\n  )) %>%\n  mutate(district_type = fct_relevel(district_type, \"Bundeswahlkreis\", \"Landeswahlkreis\", \"Regionalwahlkreis\"))\n\n```\nWith the above we are basically ready to roll and start analyzing the data in earnest. The code below gives you the first plot (preference votes by district lists).\n\n## Plot - Total number of preference votes per electoral district\n\n\n```{r, eval=F, code_folding=\"Code: Plot total number of preference votes per electoral district\"}\n\ndf_list <- df %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  group_by(district_type) %>%\n  summarise(district_type_votes = sum(pref_votes_abs, na.rm = T)) %>%\n  #  arrange(desc(district_type_votes)) %>%\n  mutate(district_type = forcats::fct_relevel(district_type, \"Regionalwahlkreis\", \"Landeswahlkreis\", \"Bundeswahlkreis\")) %>%\n  mutate(district_type_votes_cum = cumsum(district_type_votes)) %>%\n  mutate(district_type_votes_perc = district_type_votes / sum(district_type_votes)) %>%\n  mutate(district_type = forcats::fct_reorder(district_type, district_type_votes_cum, .desc = F))\n\npl_by_district <- df_list %>%\n  ggplot() +\n  geom_bar(aes(\n    x = 1,\n    y = district_type_votes,\n    fill = district_type,\n    group = district_type\n  ),\n  stat = \"identity\"\n  ) +\n  geom_text(aes(\n    x = 1,\n    y = district_type_votes,\n    group = district_type,\n    label = paste(scales::comma(district_type_votes),\n      scales::percent(district_type_votes_perc),\n      sep = \"\\n\"\n    )\n  ),\n  colour = \"white\",\n  position = position_stack(vjust = .5, reverse = F)\n  ) +\n  scale_y_continuous(\n    expand = expansion(mult = c(0, 0.05)),\n    breaks = max(df_list$district_type_votes_cum),\n    label = scales::comma(max(df_list$district_type_votes_cum))\n  ) +\n  scale_fill_paletteer_d(\"ggsci::default_jama\",\n    labels = c(\n      \"Regionalwahlkreis\" = \"Regional lists\",\n      \"Landeswahlkreis\" = \"State lists\",\n      \"Bundeswahlkreis\" = \"Federal list\"\n    )\n  ) +\n  labs(\n    title = \"Total number of preference votes per electoral district\",\n    caption = my_caption_2,\n    y = \"number of preference votes\"\n  ) +\n  \n  # hrbrthemes::theme_ipsum_tw() +\n  # theme(\n  #   plot.background = element_rect(fill=)\n  #   legend.position = \"top\",\n  #   legend.justification = \"left\",\n  #   plot.title.position = \"plot\",\n  #   legend.title = element_blank(),\n  #   axis.text.y = element_blank(),\n  #   axis.title.y = element_blank(),\n  #   plot.title = element_text(size = 13),\n  #   panel.grid = element_blank(),\n  #   plot.caption = element_markdown(hjust = c(0, 1), color = \"grey30\"),\n  #   plot.margin = margin(t = 0, l = 0, b = 0, r = 1, unit = \"cm\")\n  # ) +\n  coord_flip() +\n  guides(fill = guide_legend(reverse = T))+\n  theme_post()+\n  theme(legend.position=\"top\",\n        legend.justification = \"left\",\n        legend.direction  = \"horizontal\",\n        plot.caption =element_text(hjust=0),\n        # plot.background=element_rect(fill = \"plot_bg_color\", color=\"plot_bg_color\"),\n        legend.title = element_blank(),\n        axis.text.y = element_blank(),\n        panel.grid.major.y = element_blank()\n        \n        )\n\n\n\n\n```\n\n```{r code_folding=NULL, echo=F, fig.height=3, fig.width=10, dev=\"png\"}\npl_by_district\n```\n\n## Group_split, map, and ggplot\n\nAnother part of the code which I'd like to highlight is the one producing the [*plot on candidates' preference votes share*](http://werk.statt.codes/post/vorzugsstimmen/#candidates-preference-votes-share). Here, rather than using a `facet_grid`, I split the dataframe by the electoral district lists, and mapped the plot function to each of the three parts, and subsequently combined them with `patchwork`. The advantage was that graph is more efficient in using the available space.\n\n```{r, eval=F, code_folding=\"plot on candidates’ preference votes share\"}\n\nshare <- df %>%\n  filter(!party2 == \"Other\") %>%\n  filter(!(district_type == \"Bundeswahlkreis\" & district != \"Gesamt\")) %>%\n  filter(!is.na(pref_votes_abs)) %>%\n  group_by(district_type, state, district, party2) %>%\n  arrange(desc(pref_votes_abs), .by_group = T) %>%\n  mutate(index = row_number()) %>%\n  mutate(sum_preference = sum(pref_votes_abs, na.rm = T)) %>%\n  ungroup() %>%\n  mutate(share_pref = pref_votes_abs / sum_preference) %>%\n  # filter(share_pref>0.05) %>%  #change later\n  left_join(., info_constituencies,\n    by = c(\"district\")\n  )\n\ndf_thresholds <- tibble::tribble(\n  ~threshold, ~district_type,\n  .07, \"Bundeswahlkreis\",\n  .10, \"Landeswahlkreis\",\n  .14, \"Regionalwahlkreis\"\n)\n\ndf_thresholds_2 <- crossing(df_thresholds, unique(share$party3)) %>%\n  rename(party3 = `unique(share$party3)`)\n\n\ndf_share <- share %>%\n  left_join(., df_thresholds_2,\n    by = c(\"party3\", \"district_type\")\n  ) %>%\n  mutate(share_pref = share_pref * 100) %>%\n  left_join(., electoral_number %>%\n    select(district_name, electoral_number),\n  by = c(\"district\" = \"district_name\")\n  ) %>%\n  mutate(electoral_number_indicator = case_when(\n    pref_votes_abs > electoral_number ~ \"yes\",\n    TRUE ~ as.character(\"no\")\n  )) %>% \n  mutate(district_name=case_when(district_name==\"Gesamt\" ~ \"Österreich\",\n                                 TRUE ~ as.character(district_name))) %>% \n  left_join(., df_results %>% select(district_type, -district_name, district, party, votes_abs) %>% \n              mutate(party=as_factor(party)),\n              by=c(\"district_type\"=\"district_type\",\n               #  \"district_name\"=\"district_name\",\n                 \"district\"=\"district\",\n                 \"party3\"=\"party\")) %>% \n  mutate(c_pvpv_ratio=round(pref_votes_abs/votes_abs, 4)) %>%  #c_pvpv candidates' preference vote vote ratio\n  mutate(party3=as_factor(party3)) %>% \n  ungroup() %>% \n  mutate(sorting_index=group_indices(., district))\n\n\nx <- df_share %>% \n  select(district, district_name_short, sorting_index) %>% \n  distinct()\n\n\nplot_c_pvpv_ratio <- df_share %>%\n  filter(party3 != \"Other\") %>%\n  group_split(district_type) %>%\n  map(~ ggplot(.) +\n    labs(\n      title = paste(unique(.$district_type)),\n      subtitle = paste(\"Candidates securing preference votes more than\n                    <span style='color:orange'>\", unique(.$threshold) * 100, \"</span> % of their party's overall vote in their respective constituency are re-ranked.\"),\n      x = \"Candidate's preference votes in % of party votes (C-PVPV)\"\n    ) +\n    geom_point_interactive(aes(\n      y = reorder(district_name_short, sorting_index),\n      x = c_pvpv_ratio*100,\n      # shape = as_factor(electoral_number_indicator),\n      color = party3,\n      data_id = name_short,\n      tooltip = paste(name_short, round(c_pvpv_ratio*100, 2), sep = \"; \")\n    ),\n    position = position_jitter(width = 0, height = 0.2, seed = 2),\n    stat = \"identity\"\n    ) +\n    geom_vline(aes(xintercept = threshold * 100),\n      color = \"firebrick\"\n    ) +\n    scale_y_discrete(expand = expansion(add = 0.2)) +\n    scale_x_continuous(\n      trans = \"log10\",\n      limits = c(NA, 40),\n      labels = scales::label_percent(accuracy = 1, scale = 1),\n      minor_breaks = NULL,\n      breaks = c(NA, 0, 1, 10, 40)\n    ) +\n    scale_color_manual(values = party_colors) +\n    ggforce::facet_row(vars(party3),\n      space = \"free\",\n      scale = \"free_x\",\n      shrink = T\n    ) +\ntheme_post()+\n    theme(\n      axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 9),\n      axis.title.y = element_blank(),\n      panel.spacing.x = unit(0.2, \"cm\"),\n      panel.spacing.y = unit(0.2, \"cm\"),\n      strip.text.x = element_text(\n        angle = 0,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      strip.text.y = element_text(\n        angle = 180,\n        vjust = 1,\n        face = \"bold\"\n      ),\n      strip.placement = \"outside\",\n      plot.title = element_text(size = 11, face = \"bold.italic\", \n                                margin=margin(b=0, unit=\"cm\")),\n      plot.subtitle = element_markdown(size = 11, color = \"grey30\",\n                                       face=\"italic\"),\n      plot.title.position = \"plot\",\n      legend.position = \"bottom\",\n      legend.title = element_blank(),\n      legend.justification = \"right\",\n      panel.grid.major.y = element_blank(),\n      plot.margin = margin(0, unit = \"cm\")\n    ) +\n    guides(color = \"none\"))\n\nplot_c_pvpv_ratio <- (patchwork::wrap_plots(plot_c_pvpv_ratio, ncol = 1) &\n  theme(plot.margin = margin(unit = \"cm\", 0))) +\n  plot_annotation(\n    title = \"Candidates' preference votes v. party votes ratio (C-PVPV)\",\n    subtitle = \"Candidates above vertical line move up the electoral list.\",\n    caption = my_caption,\n    theme = theme(\n      plot.title = element_text(family = \"Roboto Condensed\", size = 12,face = \"bold\"),\n      plot.subtitle = element_text(family = \"Roboto Condensed\", size = 12,face = \"plain\")))+\n      plot_layout(heights = c(1, 9, 39))\n\n```\n## Obtaining district magnitude\n\nA convenient way to get data on the districts' magnitude (number of mandates) is to scrap the pertainnig data from the website of the Ministry of Interior. The `rvest`package´ is our reliable tool here.\n\n```{r code_folding=\"Scrap data from site of MoI\", eval=F}\nlibrary(rvest, quietly = T, verbose = F, warn=F)\n\nMoI_url <- \"https://www.bmi.gv.at/412/Nationalratswahlen/Wahlkreiseinteilung.aspx\"\n\nn_mandates_regional_districts <- MoI_url %>%\n  read_html() %>%\n  html_nodes(\"table\") %>%\n  html_table() %>%\n  map_df(., bind_rows)\n```\n\n\n```{r message=FALSE, warning=FALSE, paged.print=TRUE, code_folding=NULL, echo=F, eval=F}\n#table.start\nlibrary(reactable)\nn_mandates_regional_districts %>% \n  reactable(.,\n            filterable = T,\n          pagination = T,\n          height = 250,\n          outlined = T,\n          bordered = F,\n          compact=T,\n          theme=reactableTheme(backgroundColor = plot_bg_color,\n                           style=list(fontFamily=\"Karla\",\n                                      fontSize=\"12px\"),\n                           filterInputStyle = list(\n                             color=\"black\",\n                             backgroundColor = plot_bg_color)))\n\n#table.end\n```\n\n## Geo_facet\nFinally, as the last item, I'd like to highlight the wonderful [`geo_fact` package](https://hafen.github.io/geofacet){target=\"_blank\"}. Rather than plotting data to a map by means of different color (shades), the `geo_facet` package allows facets of a plot to be arranged (more or less) in accordance with the map of e.g. a country. Here, I first created a grid which approximates the position the Austria's states (*Bundesländer*), i.e. state electoral districts. This grid is subsequently passed on to the faceting function used in an otherwise ordinary ggplot command. The result you saw above [here](http://werk.statt.codes/post/vorzugsstimmen/#candidates-preference-votes-and-electoral-number). Sweet, isn't ;-)\n\nGladly, the author of the `geo_facet` package offers users the possibility to [submit](https://hafen.github.io/grid-designer/){target=\"_blank\"} new grids to be integrated into the package. Once I have polished the grid (e.g. add iso codes), I'll submit it and you can use it by simply calling the grid's name in the geo_facet function (update: the grid [was submitted](https://github.com/hafen/geofacet/issues/226){target=\"_blank\"} and now part of the package).\n\n```{r, eval=F, code_folding=\"Code geo_facet grid Austria\"}\nlibrary(geofacet)\n\naut_grid <- data.frame(\n  row = c(1, 1, 1, 2, 2, 2, 2, 2, 3),\n  col = c(3, 4, 5, 1, 2, 3, 4, 5, 4),\n  code = c(\"Oberösterreich\", \"Niederösterreich\", \"Wien\", \"Vorarlberg\", \"Tirol\", \"Salzburg\", \"Steiermark\", \"Burgenland\", \"Kärnten\"),\n  name = c(\"Oberösterreich\", \"Niederösterreich\", \"Wien\", \"Vorarlberg\", \"Tirol\", \"Salzburg\", \"Steiermark\", \"Burgenland\", \"Kärnten\")\n)\n\nstate_electoral_number <- df %>%\n  filter(party3 != \"Other\") %>%\n  filter(district_type == \"Landeswahlkreis\") %>%\n  left_join(.,\n    electoral_number %>% select(district_name, electoral_number),\n    by = c(\"district\" = \"district_name\")\n  ) %>%\n  select(district_type, district, name_short, party3, electoral_number, pref_votes_abs)\n\nstate_electoral_number_plot <- state_electoral_number %>%\n  ggplot() +\n  labs(\n    title = \"Candidates' preference votes and electoral number\",\n    caption = my_caption_2,\n    y = \"Preference votes\"\n  ) +\n  geom_point_interactive(aes(\n    x = party3,\n    color = party3,\n    y = pref_votes_abs,\n    tooltip = paste(\n      party3, \"\\n\",\n      name_short, pref_votes_abs\n    )\n  ),\n  position = position_jitter(width = 0.2, height = NULL, seed = 2)\n  ) +\n  geom_hline(aes(yintercept = electoral_number),\n    color = \"firebrick\"\n  ) +\n  geom_text(aes(\n    x = Inf, y = electoral_number,\n    label = scales::comma(electoral_number)\n  ),\n  color = \"firebrick\",\n  nudge_y = -3000,\n  family = \"Roboto Condensed\",\n  hjust = 1,\n  check_overlap = T\n  ) +\n  scale_color_manual(values = party_colors) +\n  scale_x_discrete(expand = expansion(mult = 0)) +\n  scale_y_continuous(\n    labels = scales::label_comma(),\n    expand = expansion(mult = 0),\n    limits = c(0, 35000),\n    minor_breaks = NULL\n  ) +\n  hrbrthemes::theme_ipsum_rc() +\n  theme(\n    axis.title.x = element_blank(),\n    axis.text.x = element_text(size = 9),\n    panel.grid.major.x = element_blank(),\n    strip.text.y = element_text(angle = 0, vjust = 1),\n    legend.position = \"none\",\n    plot.title = element_text(size = 12, face=\"bold.italic\", margin=margin(b=0, unit=\"cm\")),\n    plot.title.position = \"plot\",\n    plot.caption = element_markdown(hjust = c(0, 1), color = \"grey30\"),\n    plot.margin = margin(0, r = 0.2, unit = \"cm\"),\n    strip.background.x = element_rect(fill = \"lightgrey\"),\n    panel.border = element_rect(color = \"lightgrey\", fill = \"transparent\")\n  ) +\n  facet_geo(~district, grid = aut_grid) +\n  guides(color = \"none\")\n```\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"left","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","filters":["lightbox"],"css":["../../styles.css"],"highlight-style":"nord","toc":true,"toc-depth":3,"number-sections":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.43","editor":"visual","date-format":"D MMM YYYY","lightbox":{"match":"auto","desc-position":"bottom"},"theme":{"light":"litera"},"code-copy":true,"fontsize":"16px","toc-title":"Contents","toc-location":"left","fig-cap-location":"top","smooth-scroll":true,"author":[{"name":"Roland Schmidt"}],"title-block-banner":false,"license":"CC BY-NC","citation":true,"title":"Austrian General Elections 2019: Preference votes","description":"A look at the distribution of preference votes casted in the 2019 general elections.","date":"11-20-2019","categories":["elections","stringr","tidyr::pivot","Austria"],"image":"preview.png"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}