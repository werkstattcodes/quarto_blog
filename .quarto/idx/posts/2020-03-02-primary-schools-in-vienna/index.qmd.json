{"title":"Segregation in Vienna's primary schools?","markdown":{"yaml":{"title":"Segregation in Vienna's primary schools?","description":"Drawing on public data from Vienna's school administration I look at how many percentages of pupils in each primary school subsequently leave for schools offering eventually a higher education entrance qualification (Matura). The main interest is in contrasting these ratios between closely (geo-)located schools.\n","date":"03-02-2020","author":"Roland Schmidt","format":{"html":{"toc":true,"toc-depth":3,"toc-title":"Contents","toc-location":"left","code-fold":true,"echo":false,"fig-cap-location":"top","number-sections":true,"smooth-scroll":true}},"categories":["Austria","plotly","crosstalk"],"filters":["lightbox"],"lightbox":"auto","image":"preview.png","execute":{"freeze":true}},"headingText":"Context","containsRefs":false,"markdown":"\n\n\n```{r include=FALSE}\nknitr::opts_chunk$set(echo = T)\n```\n\n\n```{r include=FALSE}\n\nlibrary(tidyverse)\nlibrary(ggplot2)\nlibrary(here)\nlibrary(extrafont)\nloadfonts(device = \"win\", quiet = T)\nlibrary(hrbrthemes)\nlibrary(scales)\nlibrary(ggiraph)\nlibrary(knitr)\nlibrary(mapdeck)\nlibrary(widgetframe)\nlibrary(htmlwidgets)\nlibrary(plotly)\nlibrary(paletteer)\nlibrary(ggtext)\nlibrary(janitor)\nlibrary(magrittr)\noptions(digits = 12)\noptions(pillar.sigfig = 12)\nlibrary(geosphere)\nlibrary(plotly)\nlibrary(crosstalk)\nlibrary(htmltools)\n```\n\n```{r setup, echo = F}\n\nknitr::opts_chunk$set(warning = FALSE, message = FALSE, dpi = 180, fig.height = 5, fig.width = 7, fig.align = \"center\")\noptions(width = 180, dplyr.width = 150)\n\nplot_bg_color <- \"white\"\n\n\n```\n\n\nOur daughter will turn six this summer and in Austria this means that she will start attending school in autumn. While in most parts of Austria’s countryside it’s a rather foregone conclusion to which school a new pupil will go (since there is mostly only one school ‘in town’), choosing a school for your kid in a city like Vienna can become a somewhat protracted decision making process with numerous schools in the vicinity to select from. \nWhile visiting the different schools in our neighbourhood and trying to make an informed decision in the best interest of the child, I was startled by a repeated story of two closely located schools, where one school was said to be for kids with migration-background (‘Migrationshintergrund’), and the other for kids from native German speakers. While I am simplifying here and much of this story remains vague - where does it come from, how is this separation made, who makes this separation - I found this account remarkable to say at least. \n\nThe inconvenient elephant in the room here seems to be some parents’ fear that kids who do not speak German as a native language would slow down the educational development of their own, native German speakers (pure xenophobic impulses I even do not want to consider here). While I see to some extent the concern, the idea that kids of different backgrounds are effectively separated into different schools strikes me as a completely unacceptable development and brings up associations with the history of a country at the southern cone of Africa (not to speak of Austria’s darker past). \n\n\n# Analysis\nSo, triggered by this ‘hearsay’ (and, guilty as charged, by my affinity with R), I wanted to dig a bit deeper and see whether ‘the data’ has anything pertaining to say. The straightforward approach would be simply to look at the share of kids with first languages other than German in each school and compare them. While this data is certainly collected (when enrolling your kid), as far as I can tell, it is not made publicly available on an individual school level (and maybe that’s actually good). However, during our school search I came across a rather informative map provided by Austria’s statistical office (see [here]( https://www.statistik.at/atlas/schulen/#){target=”_blank”}). The map presents not only the location for every (primary) school in Austria, but also data on the school subsequently attended by its pupils once they finished the fourth grade. See e.g. the image below. <br>\n\n![Example of table of 4th graders' school destination](vienna_schools_table.PNG){width=50% height=100%}\n<br>\n\nIn short, with this data we know how many % of all pupils ‘graduating’ from a primary school’s 4th grade subsequently attended either a AHS (or equivalent; a high school/gymnasium) or an NMS (or equivalent; ‘new secondary school’). Critically, an AHS offers a direct trajectory to a school leaving examination after eight years which is required to attend university. In contrast, an NMS lasts only for four years after which kids either go for an apprenticeship, start to work, or if their school record was good enough, switch for another four to five years to an AHS or similar school type which offers a school leaving exam. To (over)simplify, leaving for an AHS is by and large considered to be better for the future educational and professional development. I will subsequently call the % of kids per school leaving for an AHS (or equivalent) the __AHS ratio__.^[To be clear, first: this blog does not intend to convey that a kid attending a middle school rather than a high school is on an individual or school level some sort of a failure. Definitely not. Kids can develop at different pace, have different needs and abilities at different times. An NMS might be just the right fit. While I am not ignorant to the particular challenges NMS entail, they should be an environment in which kids can prosper and life chances be seized. That this is not always the reality is a different story. Second: This post also does not mean to say that schools with higher AHS ratios are ‘better’ schools. Better, in my understanding, is based on schools ability to educationally and socially develop kids from where they stand when they enter school to the point when they leave. And in this regard, schools are hardly served with a clean slate (kids have different starting positions).]\n\n## Differences between districts\nIn an ‘ideal-typical’ world, without any non-randomly distributed confounding factors, the rates of pupils leaving for an AHS should be rather similar across the board. That this is not the case, however, doesn’t come at a surprise. Socio-economic factors of all kinds influence a school’s as well as a kid’s ability to educationally prosper. These factors are frequently geographically clustered and hence can account for different school-leaving ratios between schools. \n\nTo see this in the context in Vienna, I downloaded the data (2018/2019) for every Viennese primary school from the above-mentioned map of Statistik Austria and calculated the ratio of kids leaving for an AHS (or equivalent school). If we separate the result of schools by district and whether they are privately or publicly run, we get the graph below. Hover-over each dot/school to get details.\n\n\n```{r}\n#| cache: true\n# get link to json file with data embedded in the website\ndata_link <- \"https://www.statistik.at/gs-atlas/ATLAS_SCHULE_WFS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=ATLAS_SCHULE_WFS:ATLAS_SCHULE&outputFormat=application%2Fjson&srsname=EPSG:3857&\"\n\n# download jsonfile and extract field with relevant data\n# df_schools <- jsonlite::fromJSON(data_link, flatten=TRUE) %>%\n# pluck(\"features\") %>% #extract nested list with data on schools\n# janitor::clean_names() #clean/standardize names of data columns\n\ndf_schools <- jsonlite::fromJSON(data_link, flatten = TRUE)\n\ndf_schools <- df_schools$features %>% # extract nested list with data on schools\n  janitor::clean_names() # clean/standardize names of data columns\n\n# take only those primary schools located in Vienna\ndf_primary_schools_vienna <- df_schools %>%\n  filter(properties_karto_typ == \"VS\") %>% # filter only primary schools\n  filter(str_detect(properties_plz, \"^1\")) %>%\n  as_tibble() %>%\n  mutate(properties_skz = as.numeric(properties_skz)) %>%\n  mutate(school_adress = paste0(properties_str, \", \", properties_plz, \" \", properties_ort))\n\n# data on 263 primary schools was obtained\nn_distinct(df_primary_schools_vienna$properties_skz) # 263\n```\n\n\n```{r include=FALSE}\n# load version which already includes geolocated data\ndf_primary_schools_vienna <- readr::read_csv2(here(\"posts\", \"2020-03-02-primary-schools-in-vienna\", \"df_primary_schools_vienna.csv\"))\n```\n\n\n```{r warning=FALSE}\n\n# link to on pupils' destinations combined with each primary school's ID\n# gives vector for all destination tables\nlibrary(glue)\ndf_destinations_links <- glue(\"https://www.statistik.at/gs-atlas/ATLAS_SCHULE_WFS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=ATLAS_SCHULE_WFS:ATLAS_SCHULE_UEBERTRITT_OUT_WFS&maxFeatures=500&outputFormat=application%2Fjson&viewparams=SKZ:{df_primary_schools_vienna$properties_skz}\") %>%\n  enframe(value = \"link\", name = NULL)\nNROW(df_destinations_links) # 263 primary schools in Vienna\n\n# define function to get pupils' destinatino data for one school\nfn_get_destination_data <- function(school_link) {\n  jsonlite::fromJSON(school_link, flatten = TRUE) %>%\n    purrr::pluck(\"features\") %>%\n    janitor::clean_names() %>%\n    as_tibble() %>%\n    mutate(school_link = school_link)\n}\n\n\n# apply function to all schools\ndf_destination_data <- map_dfr(\n  df_destinations_links$link,\n  possibly(fn_get_destination_data,\n    otherwise = tibble()\n  )\n)\n\n\n# only 257 out of 263 primary schools with destination data;\n# 6 schools still without 'graduates'\nlength(unique(df_destination_data$properties_skz_vj))\n\ndf_destination_data\n```\n\n\n```{r warning=FALSE}\n# take the destination data and create school-type indicator for schools which provide\n# a direct trajectory to a school leaving exam;\n# since the data provides a 0 if only three or less pupils transfered to a particular school\n# (I assume for data/privacy reasons), I set this number to 2 as some kind of middle ground; see\n# the table on the website of Statitik Austria;\n# Note the .drop=F option in the group_by function; it provides us with a summary value (0) even if #there was no puipil leaving for an AHS.\n\ndf_destination_analysis <- df_destination_data %>%\n  mutate(properties_karto_typ = as_factor(properties_karto_typ)) %>%\n  mutate(school_type = case_when(\n    properties_karto_typ == \"NMSH\" ~ \"Neue Mittelschule\",\n    properties_karto_typ == \"NMSA\" ~ \"Gymnasium mit Modelversuch Mittelschule\",\n    properties_karto_typ == \"SS\" ~ \"Sonderschule\",\n    properties_karto_typ == \"VS\" ~ \"Volksschule\",\n    TRUE ~ as.character(properties_karto_typ)\n  )) %>%\n  mutate(school_type_secondary = case_when(\n    properties_karto_typ %in% c(\"AHS\", \"BMHSK\", \"BMHST\") ~ \"matura\",\n    TRUE ~ as.character(\"no matura\")\n  )) %>%\n  mutate(school_type_secondary = as_factor(school_type_secondary)) %>%\n  mutate(properties_anzahl = case_when(\n    properties_anzahl == 0 ~ 2, # changed to two\n    TRUE ~ as.numeric(properties_anzahl)\n  )) %>% # assumpation\n  group_by(properties_skz_vj, school_type_secondary, .drop = F) %>%\n  summarise(n_obs = sum(properties_anzahl)) %>%\n  ungroup()\n\ndf_share <- df_destination_analysis %>%\n  mutate(properties_skz_vj = as.numeric(properties_skz_vj)) %>%\n  group_by(properties_skz_vj) %>%\n  mutate(total = sum(n_obs)) %>%\n  mutate(n_rel = n_obs / sum(n_obs)) %>%\n  left_join(., df_primary_schools_vienna %>% # merge is wrong; has to be from primary df\n    select(\n      properties_skz,\n      properties_bezeichnung,\n      properties_erhalter,\n      properties_str,\n      properties_plz,\n      properties_ort\n    ),\n  by = c(\"properties_skz_vj\" = \"properties_skz\")\n  ) %>%\n  ungroup() %>%\n  mutate(district_code = stringr::str_sub(properties_plz, start = 2, end = 3) %>% as.numeric())\n```\n\n\n```{r}\nmy_caption <- c(\"Data: Statistik Austria, statistik.at/atlas/schulen/\", \"Analysis: Roland Schmidt | @zoowalk | <span style='color:black'>**werk.statt.codes**</span>\")\n\nplot_district <- df_share %>%\n  filter(school_type_secondary == \"matura\") %>%\n  group_by(district_code) %>%\n  mutate(n_median = median(n_rel)) %>%\n  ungroup() %>%\n  mutate(district_code = fct_reorder(as_factor(district_code), n_median)) %>%\n  mutate(tooltip = paste(\"ratio: \", scales::percent(n_rel),\n    \"\\n\",\n    paste(properties_bezeichnung, properties_str,\n      paste0(district_code, \". \", \"district\"),\n      sep = \", \"\n    ),\n    \"\\n\",\n    properties_erhalter,\n    sep = \"\"\n  )) %>%\n  ggplot() +\n  labs(\n    title = \"% of pupils leaving for secondary schools with school leaving certificate (Matura) per district\",\n    subtitle = \"Data for 2018/2019.\",\n    y = \"% of pupils per school leaving for schools with school leaving certificate (Matura)\",\n    x = \"district\",\n    caption = my_caption\n  ) +\n  geom_boxplot(aes(\n    x = district_code,\n    y = n_rel\n  ),\n  fill = \"transparent\",\n  color = \"grey80\",\n  outlier.shape = NA\n  ) +\n  geom_jitter_interactive(aes(\n    x = district_code,\n    y = n_rel,\n    color = properties_erhalter,\n    tooltip = tooltip\n  ),\n  width = .20\n  ) +\n  coord_flip() +\n  theme_ipsum_rc() +\n  scale_color_paletteer_d(\"ggsci::default_jama\",\n    labels = c(\"öffentlich\" = \"public\", \"privat\" = \"private\")\n  ) +\n  scale_y_continuous(\n    labels = scales::label_percent(),\n    limits = c(0, 1)\n  ) +\n  theme(\n    panel.grid.major.y = element_blank(),\n    panel.grid.major.x = element_line(linetype = \"dotted\"),\n    panel.grid.minor.x = element_line(linetype = \"dotted\"),\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.title = element_blank(),\n    plot.margin = margin(l = 0, t = 0.5, b = 0.5, unit = \"cm\"),\n    plot.background = element_rect(fill = plot_bg_color, color = \"transparent\"),\n    plot.title = element_text(size = 14, face = \"bold\", margin = margin(b = 0, unit = \"cm\")),\n    plot.title.position = \"plot\",\n    plot.subtitle = element_text(size = 12, color = \"grey30\"),\n    plot.caption.position = \"plot\",\n    plot.caption = element_markdown(color = \"grey30\", hjust = c(0, 1))\n  )\n\nlibrary(ggiraph)\nplot_district <- girafe(\n  ggobj = plot_district,\n  options = list(opts_tooltip(\n    css = \"background-color:#323E4F; \ncolor: white;\nfont-family:Roboto Condensed;\",\n    delay_mouseout = 5000\n  )),\n  pointsize = 6,\n  width_svg = 10,\n  height_svg = 7\n) # 10 15\n```\n\n\n```{r echo=FALSE, fig.height=10, fig.width=10, message=FALSE, warning=FALSE}\nplot_district\n```\nTo me the graph reflects two things: First, contrasting the AHS-ratio, there is a considerable difference between districts. While the 11th, 10th and 20th district had median values of around 30 %, those of the 4th, 18th and 19th are above 70 %. Second, private schools (orange dots) have overwhelmingly higher AHS-ratios than the public schools in the same district. Does this come as a surprise? Not really. Is it ok? – Well, not really.\n\n## Role of pupils’ vernacular\n\nTo get an idea on any association between schools’ AHS ratio and pupils’ language skills, I added district level data on pupils’ vernacular. The available data (2017!) presents the % of primary school pupils whose vernacular is not German per district.\n[Source](https://kurier.at/politik/inland/schule-in-not-wo-deutsch-eine-fremdsprache-ist/400134818){target=\"_blank\"}.\nSo to be clear, the data is district level data and not school level data and inferences from any association might suffer from an [ecological fallacy](https://en.wikipedia.org/wiki/Ecological_fallacy){target=\"_blank\"}. But in the absence of any better data, and bearing this caveat in mind, it seems worth looking into it. \nThe graph below depicts each primary school’s AHS-ratio (y axis) and the pertaining district’s ratio of primary school kids with non-German vernacular (x axis). What becomes apparent is that there is quite a strong association between the two factors: The higher the ratio of kids with non-German vernacular, the lower the AHS ratio (a correlation coefficient of - .44). While this is largely in line with what is generally suggested, it is still rather sobering and highlights a pretty significant shortcoming of the educational system. Again, since we do not have individual/school level data on pupils’ language one has to be cautious and not jump to far fetched conclusions. But the data, in my view, would strongly suggest that non-native German speaking kids are let down by the school system (in the sense that their needs are not adequately addressed).\n\n\n```{r}\n# load the data on districts' german/non-german vernacular ratio (source in text),\n# recode name of districts to postal codes\n\ndf_language <- readr::read_csv(here(\n  \"posts\",\n  \"2020-03-02-primary-schools-in-vienna\",\n  \"umgangssprache_deutsch_bezirk_wien.csv\"\n)) %>%\n  clean_names() %>%\n  rename(\n    non_german_perc = x16_17,\n    district = bezirk,\n    pupils_total = volksschuler_innen_gesamt,\n    german_abs = deutsch,\n    non_german_abs = nicht_deutsch,\n    non_german_perc_06 = x06_jul,\n    change_16_06 = unterschied_in_percent\n  ) %>%\n  mutate(district_code = case_when(\n    district == \"Alsergrund\" ~ 9,\n    district == \"Brigittenau\" ~ 20,\n    district == \"Donaustadt\" ~ 22,\n    district == \"Döbling\" ~ 19,\n    district == \"Favoriten\" ~ 10,\n    district == \"Floridsdorf\" ~ 21,\n    district == \"Hernals\" ~ 17,\n    district == \"Hietzing\" ~ 13,\n    district == \"Innere Stadt\" ~ 1,\n    district == \"Josefstadt\" ~ 8,\n    district == \"Landstraße\" ~ 3,\n    district == \"Leopoldstadt\" ~ 2,\n    district == \"Liesing\" ~ 23,\n    district == \"Margareten\" ~ 5,\n    district == \"Mariahilf\" ~ 6,\n    district == \"Meidling\" ~ 12,\n    district == \"Neubau\" ~ 7,\n    district == \"Ottakring\" ~ 16,\n    district == \"Penzing\" ~ 14,\n    district == \"Rudolfsheim-Fünfhaus\" ~ 15,\n    district == \"Simmering\" ~ 11,\n    district == \"Wieden\" ~ 4,\n    district == \"Währing\" ~ 18,\n    TRUE ~ NA_real_\n  ))\n\n# merge data\ndf_share <- df_share %>%\n  left_join(., df_language %>%\n    select(district_code, district, non_german_perc),\n  by = c(\"district_code\")\n  )\n\n# produce plot\nplot_langauge <- df_share %>%\n  mutate(tooltip = paste(\"ratio: \", scales::percent(n_rel),\n    \"\\n\",\n    paste(properties_bezeichnung, properties_str,\n      paste0(district_code, \". \", \"district\"),\n      sep = \", \"\n    ),\n    \"\\n\",\n    properties_erhalter,\n    sep = \"\"\n  )) %>%\n  filter(school_type_secondary == \"matura\") %>%\n  filter(properties_erhalter == \"öffentl.\") %>%\n  ggplot() +\n  labs(\n    y = \"AHS ratio\",\n    title = \"Relation between AHS ratio and primary school pupils' vernacular\",\n    subtitle = str_wrap(\n      \"Note that AHS ratio are school level data; \ninfo on vernacular is district level data. \nOnly public schools. Hover over dots to get details.\",\n      150\n    ),\n    caption = my_caption,\n    x = \"% of primary school pupils with non-German vernacular per district\"\n  ) +\n  geom_jitter_interactive(aes(\n    x = non_german_perc,\n    y = n_rel,\n    tooltip = tooltip\n  )) +\n  geom_smooth(aes(\n    x = non_german_perc,\n    y = n_rel\n  ),\n  method = \"lm\", formula = y ~ x\n  ) +\n  scale_y_continuous(\n    labels = scales::percent,\n    minor_breaks = NULL\n  ) +\n  scale_x_continuous(\n    labels = scales::label_percent(scale = 1),\n    minor_breaks = NULL,\n    limits = c(0, 100)\n  ) +\n  scale_color_paletteer_d(\"ggsci::default_jama\") +\n  # facet_wrap(vars(properties_erhalter))+\n  hrbrthemes::theme_ipsum_rc() +\n  theme(\n    panel.grid.major.y = element_line(linetype = \"dotted\"),\n    panel.grid.major.x = element_line(linetype = \"dotted\"),\n    legend.position = \"top\",\n    legend.justification = \"left\",\n    legend.title = element_blank(),\n    plot.margin = margin(l = 0, t = 0.5, b = 0.5, unit = \"cm\"),\n    plot.background = element_rect(fill = plot_bg_color, color = \"transparent\"),\n    plot.title = element_text(size = 14, face = \"bold\", margin = margin(b = 0, unit = \"cm\")),\n    plot.title.position = \"plot\",\n    plot.subtitle = element_text(size = 12, color = \"grey30\"),\n    plot.caption.position = \"plot\",\n    plot.caption = element_markdown(color = \"grey30\", hjust = c(0, 1))\n  )\n\n# wrap plot as htmlwidget for interactivity\nplot_langauge <- girafe(\n  ggobj = plot_langauge,\n  options = list(opts_tooltip(\n    css = \"background-color:#323E4F; \ncolor: white;\nfont-family:Roboto Condensed;\",\n    delay_mouseout = 5000\n  )),\n  pointsize = 6,\n  width_svg = 10,\n  height_svg = 7\n)\n\n# correlation coefficient\ncor(\n  df_share$n_rel[df_share$school_type_secondary == \"matura\"],\n  df_share$non_german_perc[df_share$school_type_secondary == \"matura\"]\n)\n```\n\n\n```{r echo=FALSE, fig.height=10, fig.width=10, message=FALSE, warning=FALSE}\nplot_langauge\n```\n\n## Same neighbourhood, different school results?\n\nBut to come back to my original point of departure, the two graphs above also show that there is significant variation within districts. While Vienna’s districts are frequently perceived as homogeneous subunits, there is considerable variation within these units which may obscure what we are interested in. To account for these differences and seeking to compare like for like schools as far as their neighbourhood is concerned, I retrieved the _GPS position of every primary school and subsequently calculated the geographical distance between them_. Have a look at the annotated code (that's where most of the work went in). \n\n\n```{r, eval=F}\n\n# apply function google_geocode to each address\n# use map (not map_chr) since you'll get a bunch of geographic details\n\ndf_primary_schools_vienna <- df_primary_schools_vienna %>%\n  mutate(coord = map(\n    school_adress,\n    ~ google_geocode(.x, key = your_google_api_key)\n  ))\n\n# extract from the nested list the with the wonderful 'pluck' function the values #your #interested (lat, lng)\ndf_primary_schools_vienna <- df_primary_schools_vienna %>%\n  mutate(lat = map_dbl(\n    coord,\n    purrr::pluck, \"results\", \"geometry\", \"location\",\n    \"lat\"\n  )) %>%\n  mutate(long = map_dbl(\n    coord,\n    purrr::pluck, \"results\", \"geometry\", \"location\",\n    \"lng\"\n  ))\n```\n\n\n```{r, eval=T}\n# take only AHS-ratios\ndf_diff <- df_share %>%\n  ungroup() %>%\n  filter(school_type_secondary == \"matura\") %>%\n  select(properties_skz_vj, n_rel)\n\n# function outer creates an array including all combinations of schools\n# and calculates the difference of the AHS ratios\ndiff_matrix <- outer(df_diff$n_rel, df_diff$n_rel, FUN = \"-\") %>%\n  data.frame()\n\nnames(diff_matrix) <- df_diff$properties_skz_vj\ndiff_matrix$school_1 <- df_diff$properties_skz_vj\n\n# with pivot_longer we bring the array in the long format;\n# create a pair indictor with pmin/pmax which is indentical for each\n# pair irrespective of the sequence of the school id (A-B covers A-B and B-A);\n# and we take the absolute value of the difference of the AHS ratio\ndf_difference <- diff_matrix %>%\n  pivot_longer(\n    cols = -school_1,\n    names_to = \"school_2\",\n    values_to = \"difference\"\n  ) %>%\n  mutate(pair_indicator = map2_chr(\n    school_1, school_2,\n    function(x, y) paste(pmin(x, y), pmax(x, y), sep = \"-\")\n  )) %>%\n  group_by(pair_indicator) %>%\n  slice(1) %>% # only take one observation; not twice (only one distance sufficient)\n  mutate(diff_abs = abs(difference)) %>%\n  filter(school_2 != school_1) %>% # remove difference observation of school with itself\n  select(pair_indicator, everything())\n\ndf_difference\n```\n\n```{r, eval=F}\n# add details of schools to dataframe containing all combinations of schools (nested);\n# first for 1st school in pair, then for 2nd school in pair;\n# extract values of interest for easier handling from nested dataframe;\ndf_main <- df_difference %>%\n  mutate_at(vars(\"school_1\", \"school_2\"), as.numeric) %>%\n  nest_join(., df_primary_schools_vienna,\n    by = c(\"school_1\" = \"properties_skz\")\n  ) %>%\n  rename(school_1_details = df_primary_schools_vienna) %>%\n  mutate(school_1_lat = map_dbl(school_1_details, purrr::pluck, \"lat\")) %>%\n  mutate(school_1_long = map_dbl(school_1_details, purrr::pluck, \"long\")) %>%\n  # nest(school_1_coords=c(school_1_lat, school_1_long)) %>%\n  nest_join(., df_primary_schools_vienna,\n    by = c(\"school_2\" = \"properties_skz\")\n  ) %>%\n  rename(school_2_details = df_primary_schools_vienna) %>%\n  mutate(school_2_lat = map_dbl(school_2_details, purrr::pluck, \"lat\")) %>%\n  mutate(school_2_long = map_dbl(school_2_details, purrr::pluck, \"long\")) %>%\n  mutate(address1 = map(school_1_details, ~ .x %>% mutate(school_1_address = paste(properties_bezeichnung,\n    properties_str,\n    properties_plz,\n    sep = \", \"\n  ))) %>%\n    map_chr(., purrr::pluck, \"school_1_address\")) %>%\n  mutate(address2 = map(school_2_details, ~ .x %>% mutate(school_2_address = paste(properties_bezeichnung,\n    properties_str,\n    properties_plz,\n    sep = \", \"\n  ))) %>%\n    map_chr(., pluck, \"school_2_address\")) %>%\n  mutate(school_1_erhalter = map(school_1_details, purrr::pluck, \"properties_erhalter\")) %>%\n  mutate(school_2_erhalter = map(school_2_details, purrr::pluck, \"properties_erhalter\")) %>%\n  mutate(school_erhalter_indicator = map2_chr(\n    school_1_erhalter, school_2_erhalter,\n    function(x, y) paste(pmin(x, y), pmax(x, y), sep = \"-\")\n  )) %>%\n  mutate(school_1_erhalter = map(school_1_details, extract, \"properties_erhalter\") %>% unlist()) %>%\n  mutate(school_2_erhalter = map(school_2_details, extract, \"properties_erhalter\") %>% unlist()) %>%\n  mutate(erhalter_type = paste(school_1_erhalter, school_2_erhalter, sep = \" - \")) %>%\n  left_join(., df_share %>%\n    filter(school_type_secondary == \"matura\") %>%\n    select(school_1_n_rel = n_rel, properties_skz_vj),\n  by = c(\"school_1\" = \"properties_skz_vj\")\n  ) %>%\n  left_join(., df_share %>%\n    filter(school_type_secondary == \"matura\") %>%\n    select(school_2_n_rel = n_rel, properties_skz_vj),\n  by = c(\"school_2\" = \"properties_skz_vj\")\n  )\n\n# readr::write_rds(df_main, file=here::here(\"_blog_data\", \"Vienna_primary_schools\",\"df_main_base.rds\"))\n\n\n```\n\n\n\n```{r, eval=T, include=F}\ndf_main <- readr::read_rds(here::here(\"posts\", \"2020-03-02-primary-schools-in-vienna\", \"df_main_base.rds\"))\n\n```\n\n\n```{r, eval=T}\n# create a tooltip for the graphic\ndf_main <- df_main %>%\n  mutate(tooltip = paste0(\n    paste(address1,\n      \"Wien\",\n      school_1_erhalter,\n      scales::percent(school_1_n_rel),\n      sep = \", \"\n    ),\n    \"\\n\",\n    paste(address2,\n      \"Wien\",\n      school_2_erhalter,\n      scales::percent(school_2_n_rel),\n      sep = \", \"\n    )\n  ))\n\n# cacluate the factor by which one school's AHS differeds from another school's AHS ratio.\n# the pmin/pmax function ensures that the school with the lower AHS ratio is\n# is the denominator; makes comparison between school pairs easier;\n\ndf_main <- df_main %>%\n  mutate(diff_factor = map2_dbl(\n    school_1_n_rel, school_2_n_rel,\n    function(x, y) pmax(x, y) / pmin(x, y)\n  ))\n```\n\n\n\n```{r eval=T, paged.print=TRUE}\n# Here the full table with the data\ndf_main\n```\n\n```{r}\n\n# to map the distm function to the four geo-location data points (lat & lon for school 1 and lat & long\n# for school 2 use the pmap function from the purrr package)\n\ndf_main <- df_main %>%\n  ungroup() %>%\n  mutate(distance = pmap_dbl(\n    list(\n      school_1_lat, school_1_long,\n      school_2_lat, school_2_long\n    ),\n    ~ distm(\n      x = c(..1, ..2),\n      y = c(..3, ..4),\n      fun = distHaversine\n    )\n  ))\n\ndf_main %>%\n  select(school_1, school_2, distance)\n```\n\n\nThere are 263 primary schools in the data on Statistik Austira’s map; for 257 schools destination data is provided. Calculating the distance between each pair of these schools leads to a matrix with 56644 cells. Since each pair appears twice (A to B, B to A) I created a pair_indicator and take only one observation from it. Furthermore, I removed distances of type A to A which were also in the matrix. The geolocation was done with via Google’s location API and the [googleway package]( https://github.com/SymbolixAU/googleway){target=”_blank”}. The service can cost a few Euros, but there is a 200 Euro / month free access scheme. The distance between these locations was subsequently calculated with the [geosphere package](https://cran.r-project.org/web/packages/geosphere/geosphere.pdf){target=”_blank”} and the distm function. Since the idea is to account for differences in the neighbourhood (compare only schools which are closely located), I look only at those pairs of schools which are not farther away from each other than 500 m. The result is presented in the two graphs below.\n\nIn the graph below on the left side, each dot represents a pair of public (!) primary schools. The x axis presents the distance between them in meters. The y axis presents the (absolute) difference between both schools' AHS ratio. E.g. if one school has a ratio of 10 % and the other has a ratio of 30 %, the position on the y axis is 20. \n\nAgain, hover with your mouse over each dot to get details and see e.g. which school has a higher AHS ratio. To make things a bit more accessible, if you click on the dot, the map on the right side will highlight the two locations of both schools (you may have to zoom in if schools are very close to each other). \n\nComplementing the absolute difference of the AHS ratios, I also divided the AHS ratios of boths schools, resulting in what I call here (for the lack of a better idea) AHS factor. If school A has a ratio of 10 % and the school B has a ratio of 40 %, the corresponding AHS factor is 4. In other words, the factor indicates how much more likely it is for a kid from one school to ‘graduate’ to an AHS than it is for a kid from the other school. The factor is calculated in such a way that it always takes the ratio of the school with the higher AHS ratio as the numerator and the school with the lower ratio as the denominator. The factor is stated in the tooltip when clicking on the dot (school pair) in the graph.\n\n\n```{r include=FALSE}\ndf_main <- readr::read_rds(here(\"posts\", \"2020-03-02-primary-schools-in-vienna\", \"df_main.rds\"))\n\n```\n\n\nBoth graphs are produced with [plotly]( https://github.com/ropensci/plotly){target=”_blank”}. Their interaction is facilitated by the [crosstalk]( https://rstudio.github.io/crosstalk/){target=”_blank”} package. Note that when using crosstalk in blogdown (which produces this blog), corsstalk messes up you css styling because it injects bootstrap css. To take care of this, see the unstrap function which I - afer some considerable googeling - found here. It basically removes all bootstrap css tags from the shared/crosstalk object and keeps your own blog style in order.\n\n\n\n```{r, eval=T}\n# take only those schools located within 500 m vicincity;\n# and only public school dyads\n\nshared_df_main <- df_main %>%\n  filter(distance < 500) %>%\n  filter(school_erhalter_indicator == \"öffentl.-öffentl.\") %>%\n  select(-contains(\"details\"))\n\n# create a crosstalk object\nshared_df_main <- SharedData$new(shared_df_main,\n  key = ~pair_indicator,\n  group = \"pair_indicator\"\n)\n\n\n\n# plot: x axis geographical distance;\n\nlibrary(plotly)\nplot_distance_diff <-\n  plot_ly(\n    data = shared_df_main,\n    mode = \"markers\",\n    type = \"scatter\",\n    hoverinfo = \"text\",\n    text = ~ paste(\n      \"abs diff AHS ratio (% points):\", round((diff_abs * 100), 2),\n      \"</br>AHS factor:\", round(diff_factor, 2),\n      \"</br>distance (m):\", round(distance, 0),\n      \"</br>\", tooltip\n    )\n  ) %>%\n  add_trace(\n    # text=~tooltip,\n    marker = list(color = \"orange\"),\n    x = ~distance,\n    # y=~diff_factor,\n    y = ~ scales::percent(diff_abs),\n    showlegend = F\n  ) \n  \nplot_distance_diff <- config(plot_distance_diff, displayModeBar=FALSE) %>%\n  layout(\n    title = list(\n      text = \"<b>Schools' different AHS ratios and geographical distance</b>\",\n      x = 0.5\n    ),\n    font = list(family = \"Roboto Condensed\"),\n    xaxis = list(title = \"distance between schools in meters\"),\n    yaxis = list(title = \"absolute difference of AHS ratios (% points)\"),\n    plot_bgcolor = plot_bg_color,\n    paper_bgcolor = plot_bg_color,\n    margin=list(\n      l=200\n    )\n  )\n\n# plot_distance_diff\n\n\n\n# map\n# name package::; otherwise confusiong with leaflet addcircle => error\n\ncross_map2 <- plotly::plot_mapbox(\n  data = shared_df_main,\n  hoverinfo = \"text\",\n  text = ~ paste(\n    \"abs diff AHS ratio (% points):\", round((diff_abs * 100), 2),\n    \"</br>AHS factor:\", round(diff_factor, 2),\n    \"</br>distance (m):\", round(distance, 0),\n    \"</br>\", tooltip\n  )\n) %>%\n  plotly::add_markers(\n    y = ~school_1_lat,\n    x = ~school_1_long,\n    color = \"#FF0000\" #,\n    # text = ~address1\n  ) %>%\n  plotly::add_markers(\n    y = ~school_2_lat,\n    x = ~school_2_long,\n    color = \"#FF0000\" # ,\n    # text = ~address2\n  ) %>%\n  layout(\n    mapbox = list(\n      style = \"mapbox://styles/zoowalk/ckjrkv7065tf519oax4nadm2k\",\n      margin=list(l=0,r=0,t=0,b=0,p=0),\n      zoom = 10,\n      center = list(\n        lat = 48.21,\n        lon = 16.3720798\n      )\n    ),\n    showlegend = FALSE,\n    paper_bgcolor = plot_bg_color\n  ) %>% \n    config(mapboxAccessToken = Sys.getenv(\"MAPBOX_API_KEY\"))\n\n#combine both plots vertically/as two columns\n#problem: introduces bootstrap css which conflicts with css of blog\ncross_plot <- crosstalk::bscols(plot_distance_diff, cross_map2)\n\ncross_plot <- browsable(tagList(cross_plot))\n\n\n\n# see here for how to remove bootstrap css which otherwise messes up you blogdown's css\n# https://github.com/rstudio/crosstalk/issues/26\n# only works when combining plots vertically though ! hence css not as intended;\n\nunstrap <- function(x) {\n  attr(x, \"html_dependencies\") <-\n    Filter(\n      function(dependency) {\n        dependency$name != \"bootstrap\"\n      },\n      attr(x, \"html_dependencies\")\n    )\n  x\n}\n\ncross_plot_clean <- unstrap(cross_plot)\n```\n\n\n```{r}\n#| echo: false\n#| fig.height: 30\n#| column: page\n\ncross_plot_clean\n```"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","filters":["lightbox"],"css":["../../styles.css"],"highlight-style":"github","toc":true,"toc-depth":3,"number-sections":true,"output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.280","author":[{"name":"Roland Schmidt","url":"https://werk.statt.codes"},"Roland Schmidt"],"editor":"visual","date-format":"D MMM YYYY","lightbox":"auto","theme":{"light":"litera"},"code-copy":true,"fontsize":"16px","toc-title":"Contents","toc-location":"left","fig-cap-location":"top","smooth-scroll":true,"title-block-banner":true,"license":"CC BY","citation":true,"title":"Segregation in Vienna's primary schools?","description":"Drawing on public data from Vienna's school administration I look at how many percentages of pupils in each primary school subsequently leave for schools offering eventually a higher education entrance qualification (Matura). The main interest is in contrasting these ratios between closely (geo-)located schools.\n","date":"03-02-2020","categories":["Austria","plotly","crosstalk"],"image":"preview.png"},"extensions":{"book":{"multiFile":true}}}}}