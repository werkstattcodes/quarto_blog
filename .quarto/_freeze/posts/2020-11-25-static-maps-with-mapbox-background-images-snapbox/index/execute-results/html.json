{
  "hash": "0847604dca6e592a6ba5fcbccb965baa",
  "result": {
    "markdown": "---\ntitle: \"Adding background images to maps.\"\ndescription: \"How to create ggplot maps with mapbox images as background.\"\ndate: 11-25-2020\n\ncategories: [maps, Austria, sf, snapbox, mapbox]\nfilters: \n  - lightbox\nlightbox: auto\nimage: map.png\n  \n---\n\n\n\n\n# Context\n\nPartly triggered by my [last post](https://werk.statt.codes/post/recreating-nyt-election-map/){target=\"_blank\"} on replicating NYT's electoral maps, I came across the nascent/experimental `snapbox` package ([link](https://github.com/anthonynorth/snapbox){target=\"_blank\"}) by Anthony North and Miles McBain. The package provides a convenient way to add mapbox tiles as basemaps to maps created with ggplot (did I mention 'maps'?`). \n\nThe package is quite straightforward and not much to explain about. What caused me some hassles though was to figure out how to combine the basemap with my data, plotted with `geom_segment` or `geom_sf`. The critical issue here is to ensure that the maps projection of the coordiante system are the same. Hence, this post is somewhat a note to myself, graphs are not polished and I don't dig into substantive matters. For the purpose of demonstration, I'll use electoral data from the city of Vienna and want to highlight how the number of eligible voters per precinct ('Wahlsprengel') changed between 2015 and 2020. \n\n# SETUP\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code: Load packages\"}\nlibrary(snapbox)\nlibrary(sf)\nlibrary(tidyverse)\n#library(magick)\nknitr::knit_hooks$set(crop = knitr::hook_pdfcrop) #allows to crop white frame from ggplots.\n#for details see https://bookdown.org/yihui/rmarkdown-cookbook/crop-plot.html\nplot_bg_color  <- \"white\"\n```\n:::\n\n\n\n# ELECTORAL DATA\n\nGet the election results from 2015 and 2020, retrieve the number of eligible voters per precinct (`wber``), and calculate the change.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-2_62e9348a9fc5fa99b75d30c41d3044b7'}\n\n```{.r .cell-code  code-summary=\"Code: Get electoral data + change in number of elegible voters\"}\n# https://www.data.gv.at/katalog/dataset/stadt-wien_wahleninwiengemeinderatswahlen/resource/a526df98-c307-4dee-8233-43b02856d1d7\n# https://www.wien.gv.at/politik/wahlen/hilfetext/rohdaten.html\nres20 <- readr::read_csv2(file = \"https://www.wien.gv.at/politik/wahlen/ogd/gr201_99999999_9999_spr.csv\")\nres15 <- readr::read_csv2(file = \"https://www.wien.gv.at/politik/wahlen/ogd/gr151_99999999_9999_spr.csv\")\n\nres <- bind_rows(elections=list('2020'=res20, '2015'=res15), .id=\"election\") %>% \n  janitor::clean_names() %>% \n  janitor::remove_empty(\"cols\") %>% \n  mutate(election=as.numeric(election)) %>% \n  mutate(indicator_sprengel=bz*1000+spr, .after=spr) %>% \n  select(election:wber) \n\n\n# change of eligible voters ----------------------------------------------------------\n\ndf_wber_diff <- res %>% \n  filter(wber>0) %>% #remove 'technical' precincts for mail & absentee voting \n  select(-contains(\"nuts\")) %>% \n  group_by(indicator_sprengel) %>% \n  arrange(desc(election), .by_group=T) %>% \n  mutate(wber_diff=wber-lead(wber)) %>% \n  filter(election==2020) %>% \n  mutate(wber_diff_rel=wber_diff/wber) %>% \n  ungroup() %>% \n  mutate(change_indicator=case_when(wber_diff_rel>0 ~ \"increase\",\n                                    wber_diff_rel<0 ~ \"decrease\",\n                                    TRUE ~ as.character(\"stable\")))\n```\n:::\n\n::: {.cell paged.print='true'}\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1,483 × 4\n   indicator_sprengel wber_diff wber_diff_rel change_indicator\n                <dbl>     <dbl>         <dbl> <chr>           \n 1               1001       -43       -0.0640 decrease        \n 2               1002       -34       -0.0521 decrease        \n 3               1003       -36       -0.0574 decrease        \n 4               1004        -8       -0.0247 decrease        \n 5               1005       -76       -0.104  decrease        \n 6               1006       -43       -0.0814 decrease        \n 7               1007       -74       -0.138  decrease        \n 8               1008       -17       -0.0297 decrease        \n 9               1009       -48       -0.0650 decrease        \n10               1010       -31       -0.0442 decrease        \n# … with 1,473 more rows\n```\n:::\n:::\n\n\nLet's have a quick look at the distribution of the change rates:\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code: Distribution of changes\"}\nlibrary(ggridges)\npl_dist <- df_wber_diff %>% \n  ggplot()+\n  ggridges::geom_density_line(aes(x=wber_diff_rel))+\n  labs(x=\"% change number of eligible voters 2020 vs 2015\")+\n  theme(axis.text.y=element_blank())\n\ntable(df_wber_diff$change_indicator)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\ndecrease increase   stable \n     978      451       54 \n```\n:::\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n\ndecrease increase   stable \n     978      451       54 \n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nSo, while the purpose of this post is not to dig into substantive matters, I was a bit surprised to see that a large majority of precincts features a decreased number of eligible voters. \n\n# MAP\n\n## Get boundaries of precincts\n\nGet the shapefile of the precincts' boundaries. \n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code: Get shape with boundaries of precincts\"}\n# https://www.data.gv.at/katalog/dataset/79c1030d-5cf6-4d58-ade6-02f66fb4dffb\nprecincts <- st_read(here::here(\"posts\",\"2020-11-25-static-maps-with-mapbox-background-images-snapbox\",\"shapefile\",\"WAHLSPRGR2020OGDPolygon.shp\"),\n              quiet=T) %>% \n  janitor::clean_names() %>% \n  mutate(sprengel=as.numeric(sprengel))\n\nggplot()+\n  geom_sf(data=precincts)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\nNow let's calculate the center of each precinct. Note that I transform the coordination projection from WGS84 to 3857. The latter is 'a Spherical Mercator projection coordinate system popularized by web services such as Google and later OpenStreetMap.'^[See [here](https://wiki.openstreetmap.org/wiki/EPSG:3857#:~:text=EPSG%3A3857%20is%20a%20Spherical,as%20Google%20and%20later%20OpenStreetMap.){target=\"_blank\"}.] \nAfter the transformation I take the x and y values from the centroids' geometry. The function `st_centroid` gives us the centre of each polygon.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code: Get centroids for precincts\"}\nst_crs(precincts)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCoordinate Reference System:\n  User input: WGS 84 \n  wkt:\nGEOGCRS[\"WGS 84\",\n    DATUM[\"World Geodetic System 1984\",\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ID[\"EPSG\",6326]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433],\n        ID[\"EPSG\",8901]],\n    CS[ellipsoidal,2],\n        AXIS[\"geodetic longitude\",east,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        AXIS[\"geodetic latitude\",north,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433]]]\n```\n:::\n\n```{.r .cell-code  code-summary=\"Code: Get centroids for precincts\"}\ncent_precincts <- precincts %>% \n  st_transform(., crs=3857) %>% \n  st_centroid() %>% \n  mutate(point_x=map_dbl(geometry, pluck, 1),\n         point_y=map_dbl(geometry, pluck, 2))\n\nggplot()+\n  geom_sf(data=precincts)+\n  geom_sf(data=cent_precincts,\n          size=0.1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n## Add change indicators (arrows)\n\nCalculate the length of the arrow indicating the change: Here the arrows should have an angle of 20 degrees; positive changes point towards the right, negative changes towards the left. With the sin and cos function we calculate the horizontal and vertical distance from the centroids.  In addition, to make the arrows sufficiently long to be visible, I multiply them with a scale factor. Note that I add `coord_sf()` to the plot which 'ensures that all layers use a common CRS.'^[See [here.](https://ggplot2.tidyverse.org/reference/ggsf.html){target=\"_blank\"}]\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code: Calculate length of arrows indicating change\"}\nscale_factor <- 10^3\n\ndf_change <- cent_precincts %>% \n  left_join(., df_wber_diff,\n            by=c(\"sprengel\"=\"indicator_sprengel\")) %>% \n  mutate(x_change=wber_diff_rel*sin(20),\n         y_change=abs(wber_diff_rel)*cos(20)) %>% \n  mutate(point_x_end=point_x+(x_change*scale_factor), .after=point_x) %>% \n  mutate(point_y_end=(y_change*scale_factor)+point_y, .after=point_y) \n\npl_change <- ggplot()+\n  geom_sf(data=precincts,\n          linewidth=0.1,\n          fill=\"transparent\")+\n  geom_segment(data=df_change,\n               aes(x=point_x,\n                   xend=point_x_end,\n                   y=point_y,\n                   yend=point_y_end,\n                   color=change_indicator),\n               linejoin=\"mitre\",\n               arrow=arrow(length=unit(0.05, \"cm\"),\n                           angle=15,\n                           type=\"closed\"),\n               linewidth=0.5)+\n  scale_color_manual(values=c(\"increase\"=\"darkgreen\",\n                              \"decrease\"=\"maroon\",\n                              \"stable\"=\"orange\"))+\n  coord_sf(crs=3857)+\n  theme_void()\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n## Add mapbox basemap\n\nNow, let's add a mapbox basemap by using the `layer_mapbox` function of `snapbox`. To so, we first have to define the scope or boundary of the basemap. I do this by extracting the minimum and maximum x and y values from our map of the precincts. And then create a bbox object. Note that this boundary box is has the 4326 projection. The basemap for this boundary box is then added to the plot by using the layer_mapbox function. Note that you need an [API-key](https://docs.mapbox.com/help/how-mapbox-works/access-tokens/){target=\"_blank\"} to access basemaps of mapbox. \n\nEt voila. \n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code: Add mapbox basemap\"}\n#get boundaries of plot\n\n#map boundaries: get max/min x, y values\nd <- precincts$geometry\nd <- attributes(d)$bbox\nmy_xmin <- d[[1]]\nmy_ymin <- d[[2]]\nmy_xmax <- d[[3]]\nmy_ymax <- d[[4]]\nmy_xmin\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 16.18183\n```\n:::\n\n```{.r .cell-code  code-summary=\"Code: Add mapbox basemap\"}\nmy_ymin\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 48.1179\n```\n:::\n\n```{.r .cell-code  code-summary=\"Code: Add mapbox basemap\"}\nmy_xmax\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 16.57751\n```\n:::\n\n```{.r .cell-code  code-summary=\"Code: Add mapbox basemap\"}\nmy_ymax\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 48.32267\n```\n:::\n\n```{.r .cell-code  code-summary=\"Code: Add mapbox basemap\"}\n#get basemap\nbackground_image <- st_bbox(\n  c(xmin = my_xmin, ymin = my_ymin, xmax = my_xmax, ymax = my_ymax),\n  crs=4326) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#combine\npl_combined <- ggplot()+\n  layer_mapbox(background_image,\n               map_style = mapbox_gallery_north_star(),\n               mapbox_api_access_token = Sys.getenv(\"MAPBOX_API_KEY\"),\n               scale_ratio = 1)+\n  geom_sf(data=precincts,\n          size=0.2,\n          fill=\"transparent\")+\n  geom_segment(data=df_change,\n               aes(x=point_x,\n                   xend=point_x_end,\n                   y=point_y,\n                   yend=point_y_end,\n                   color=change_indicator),\n               linejoin=\"mitre\",\n               arrow=arrow(length=unit(0.05, \"cm\"),\n                           angle=15,\n                           type=\"closed\"),\n               size=0.5)+\n  scale_color_manual(values=c(\"increase\"=\"darkgreen\",\n                              \"decrease\"=\"maroon\",\n                              \"stable\"=\"orange\"))+\n  coord_sf(crs=3857)+\n  theme_void()+\n  theme(legend.position = \"none\")\n```\n:::\n\n::: {.cell crop='true'}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nYou can quickly change the background image by specifying a different `map_style` value, e.g. below \nI use the *decimal style*. And also combine with a different aesthetic, e.g. using fill to color the precincts according to their respective change. \n\n\n::: {.cell crop='true'}\n\n```{.r .cell-code  code-summary=\"Code: Gradient fill of precincts\"}\ndf_fill <- precincts %>% \n  left_join(., df_change %>% select(sprengel, wber_diff_rel) %>% as.data.frame(),\n            by=c(\"sprengel\"=\"sprengel\"))\n\n\npl_combined2<- ggplot()+\n  layer_mapbox(background_image,\n               map_style = mapbox_gallery_north_star(),\n               mapbox_api_access_token = Sys.getenv(\"MAPBOX_API_KEY\"),\n               scale_ratio = 1)+\n  geom_sf(data=df_fill,\n          aes(fill=wber_diff_rel),\n          size=0.2)+\n\n  scale_fill_gradient2(low=\"red\", high=\"green\", mid=\"white\",\n                       breaks=scales::pretty_breaks(n=4)(min(df_fill$wber_diff_rel, na.rm = T):\n                                                   abs(min(df_fill$wber_diff_rel, na.rm=T))),\n                                                 guide = \"colourbar\",\n                       name=\"% change eligible voters 2015-2020\",\n                       limits=c(min(df_fill$wber_diff_rel, na.rm=T), abs(min(df_fill$wber_diff_rel, na.rm=T))))+\n\n  coord_sf(crs=3857)+\n  theme_void()+\n  theme(plot.background = element_rect(fill=plot_bg_color, color=plot_bg_color),\n        legend.title = element_text(size=7, vjust=1),\n        legend.text = element_text(size=5),\n        legend.position = \"bottom\",\n        legend.justification = \"left\")+\n  guides(fill = guide_colourbar(barwidth = 3, barheight = .2, title.position = \"top\"))\n```\n:::\n\n::: {.cell layout-align=\"left\" crop='true'}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){fig-align='left' width=2100}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}